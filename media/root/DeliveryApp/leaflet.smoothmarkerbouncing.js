data:application/x-javascript;base64,LyoKICogQ29weXJpZ2h0IChjKSAyMDE1LCBBbGV4ZWkgS0xFTklOCiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqCiAqIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dAogKiBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDoKICoKICogICAxLiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsCiAqICAgICAgICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgogKgogKiAgIDIuIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0CiAqICAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlCiAqICAgICAgICBkb2N1bWVudGF0aW9uIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgogKgogKiBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTICJBUyBJUyIKICogQU5EIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRQogKiBJTVBMSUVEIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRQogKiBBUkUgRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVCBIT0xERVIgT1IgQ09OVFJJQlVUT1JTIEJFCiAqIExJQUJMRSBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IKICogQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YKICogU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTCiAqIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOCiAqIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpCiAqIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFCiAqIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgogKi8KCi8qKgogKiBQbHVnaW4gZm9yIHNtb290aCBib3VuY2luZyBvZiBMZWFmbGV0IG1hcmtlcnMuCiAqCiAqIEBhdXRob3IgQWxleGVpIEtMRU5JTiA8YWxleGV5X2tsZW5pbkBob3RtYWlsLmZyPgogKi8KOyhmdW5jdGlvbiAoZmFjdG9yeSwgd2luZG93KSB7CgogICAgLyogRGVmaW5lIGFuIEFNRCBtb2R1bGUgdGhhdCByZWxpZXMgb24gJ2xlYWZsZXQnICovCiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgZGVmaW5lKFsnbGVhZmxldCddLCBmYWN0b3J5KTsKCiAgICAgICAgLyogRGVmaW5lIGEgQ29tbW9uIEpTIG1vZHVsZSB0aGF0IHJlbGllcyBvbiAnbGVhZmxldCcqLwogICAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgnbGVhZmxldCcpKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LkwpIHsKICAgICAgICBmYWN0b3J5KEwpOwogICAgfQp9KGZ1bmN0aW9uIChMKSB7CgogICAgJ3VzZSBzdHJpY3QnOwoKICAgIHZhciByZWdTdHlsZSA9IC8oW1x3LV0rKTogKFteO10rKTsvZywgICAgLy8gcmVnZXggdG8gcGFyc2Ugc3R5bGUgZGVmaW5pdGlvbnMKCiAgICAgICAgLyoqCiAgICAgICAgICogQ1NTMyB0cmFuc2Zvcm0gcHJvcGVydGllcyBmb3IgZGlmZmVyZW50IGJyb3dzZXJzCiAgICAgICAgICovCiAgICAgICAgY3NzM190cmFuc2Zvcm1zID0gewogICAgICAgICAgICB0cmFuc2Zvcm0gICAgICAgOiAndHJhbnNmb3JtJywKICAgICAgICAgICAgV2Via2l0VHJhbnNmb3JtIDogJy13ZWJraXQtdHJhbnNmb3JtJywKICAgICAgICAgICAgT1RyYW5zZm9ybSAgICAgIDogJy1vLXRyYW5zZm9ybScsCiAgICAgICAgICAgIE1velRyYW5zZm9ybSAgICA6ICctbW96LXRyYW5zZm9ybScsCiAgICAgICAgICAgIG1zVHJhbnNmb3JtICAgICA6ICctbXMtdHJhbnNmb3JtJwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENTUzMgdHJhbnNmb3JtIHByb3BlcnR5IGZvciB0aGlzIGJyb3dzZXIKICAgICAgICAgKi8KICAgICAgICB0cmFuc2Zvcm0gPSBjc3MzX3RyYW5zZm9ybXNbTC5Eb21VdGlsLlRSQU5TRk9STV0sCgogICAgICAgIC8qIENhY2hlIGZvciBtb3Rpb24gZGF0YSB0aGF0IG5vdCBkZXBlbmRzIG9uIHggJiB5IG9mIHRoZSBtYXJrZXI6CiAgICAgICAgICogICAgLSBtb3ZlU3RlcHMKICAgICAgICAgKiAgICAtIG1vdmVEZWxheXMKICAgICAgICAgKiAgICAtIHJlc2l6ZVN0ZXBzCiAgICAgICAgICogICAgLSByZXNpemVEZWxheXMKICAgICAgICAgKi8KICAgICAgICBfYm91bmNpbmdNb3Rpb25zQ2FjaGUgPSB7fTsKCiAgICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKiAgICAgICAgIEluLWNsb3N1cmUgaGVscGVyIGZ1bmN0aW9ucwogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICovCgogICAgLyoqCiAgICAgKiBQYXJzZXMgY3NzVGV4dCBhdHRyaWJ1dGUgaW50byBvYmplY3QuIFN0eWxlIGRlZmluaXRpb25zIGJlY29tZXMgdGhlIGtleXMKICAgICAqIG9mIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQHBhcmFtIGNzc1RleHQgICBjc3NUZXh0IHN0cmluZwogICAgICoKICAgICAqIEByZXR1cm4gb2JqZWN0IHdpdGggc3R5bGUgZGVmaW5pdGlvbnMgYXMga2V5cwogICAgICovCiAgICBmdW5jdGlvbiBwYXJzZUNzc1RleHQoY3NzVGV4dCkgewogICAgICAgIHZhciBzdHlsZURlZmluaXRpb25zID0ge30sCiAgICAgICAgICAgIG1hdGNoID0gcmVnU3R5bGUuZXhlYyhjc3NUZXh0KTsKCiAgICAgICAgd2hpbGUgKG1hdGNoKSB7CiAgICAgICAgICAgIHN0eWxlRGVmaW5pdGlvbnNbbWF0Y2hbMV1dID0gbWF0Y2hbMl07CiAgICAgICAgICAgIG1hdGNoID0gcmVnU3R5bGUuZXhlYyhjc3NUZXh0KTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzdHlsZURlZmluaXRpb25zOwogICAgfQoKICAgIC8qKgogICAgICogUmVuZGVycyBvYmplY3Qgd2l0aCBzdHlsZSBkZWZpbml0aW9ucyBhcyBzdHJpbmcuIENyZWF0ZWQgc3RyaW5nIGlzIHJlYWR5CiAgICAgKiB0byBwdXQgaW4gY3NzVGV4dCBhdHRyaWJ1dGUuCiAgICAgKgogICAgICogQHBhcmFtIHN0eWxlRGVmaW5pdGlvbnMgICAgb2JqZWN0IHdpdGggc3R5bGUgZGVmaW5pdGlvbnMKICAgICAqCiAgICAgKiBAcmV0dXJuIGNzc1RleHQgc3RyaW5nCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlbmRlckNzc1RleHQoc3R5bGVEZWZpbml0aW9ucykgewogICAgICAgIHZhciBjc3NUZXh0ID0gJycsCiAgICAgICAgICAgIGtleTsKCiAgICAgICAgZm9yIChrZXkgaW4gc3R5bGVEZWZpbml0aW9ucykgewogICAgICAgICAgICBjc3NUZXh0ICs9IGtleSArICc6ICcgKyBzdHlsZURlZmluaXRpb25zW2tleV0gKyAnOyAnCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY3NzVGV4dDsKICAgIH0KCiAgICAvKioKICAgICAqIENhbGN1bGF0ZXMgdGhlIHBvaW50cyB0byBkcmF3IHRoZSBjb250aW5vdXMgbGluZSBvbiB0aGUgc2NyZWVuLiBSZXR1cm5zCiAgICAgKiB0aGUgYXJyYXkgb2Ygb3JkZXJlZCBwb2ludCBjb29yZGluYXRlcy4gVXNlcyBCcmVzZW5oYW0gYWxnb3JpdGhtLgogICAgICoKICAgICAqIEBwYXJhbSB4ICAgICAgICAgeCBjb29yZGluYXRlIG9mIG9yaWdpbgogICAgICogQHBhcmFtIHkgICAgICAgICB5IGNvb3JkaW5hdGUgb2Ygb3JpZ2luCiAgICAgKiBAcGFyYW0gYW5nbGUgICAgIGFuZ2xlIChyYWRpYW5zKQogICAgICogQHBhcmFtIGxlbmd0aCAgICBsZW5ndGggb2YgbGluZSAocHgpCiAgICAgKgogICAgICogQHJldHVybiBhcnJheSBvZiBvcmRlcmVkIHBvaW50IGNvb3JkaW5hdGVzCiAgICAgKgogICAgICogQHNlZQogICAgICogaHR0cDovL3Jvc2V0dGFjb2RlLm9yZy93aWtpL0JpdG1hcC9CcmVzZW5oYW0nc19saW5lX2FsZ29yaXRobSNKYXZhU2NyaXB0CiAgICAgKi8KICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZUxpbmUoeCwgeSwgYW5nbGUsIGxlbmd0aCkgewogICAgICAgIC8vIFRPRE86IHVzZSBzb21ldGhpbmcgZWxzZSB0aGFuIG11bHRpcGx5IGxlbmd0aCBieSAyIHRvIGNhbGN1bGF0ZSB0aGUKICAgICAgICAvLyBsaW5lIHdpdGggZGVmaW5lZCBsZW5ndGgKICAgICAgICB2YXIgeEQgPSBNYXRoLnJvdW5kKHggKyBNYXRoLmNvcyhhbmdsZSkgKiAobGVuZ3RoICogMikpLAogICAgICAgICAgICB5RCA9IE1hdGgucm91bmQoeSArIE1hdGguc2luKGFuZ2xlKSAqIChsZW5ndGggKiAyKSksCgogICAgICAgICAgICBkeCA9IE1hdGguYWJzKHhEIC0geCksCiAgICAgICAgICAgIHN4ID0geCA8IHhEID8gMSA6IC0xLAoKICAgICAgICAgICAgZHkgPSBNYXRoLmFicyh5RCAtIHkpLAogICAgICAgICAgICBzeSA9IHkgPCB5RCA/IDEgOiAtMSwKCiAgICAgICAgICAgIGVyciA9IChkeCA+IGR5ID8gZHggOiAtZHkpIC8gMiwKICAgICAgICAgICAgZTIsCgogICAgICAgICAgICBwID0gW10sCiAgICAgICAgICAgIGkgPSAwOwoKICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICBwLnB1c2goW3gsIHldKTsKICAgICAgICAgICAgaSsrOwogICAgICAgICAgICBpZiAoaSA9PT0gbGVuZ3RoKQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGUyID0gZXJyOwogICAgICAgICAgICBpZiAoZTIgPiAtZHgpIHsKICAgICAgICAgICAgICAgIGVyciAtPSBkeTsKICAgICAgICAgICAgICAgIHggKz0gc3g7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGUyIDwgZHkpIHsKICAgICAgICAgICAgICAgIGVyciArPSBkeDsKICAgICAgICAgICAgICAgIHkgKz0gc3k7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBwOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBjYWxjdWxhdGVkIGFycmF5IG9mIHBvaW50cyBmb3IgaWNvbiBtb3ZlbWVudC4gVXNlZCB0byBhbmltYXRlCiAgICAgKiBtYXJrZXJzIGluIGJyb3dzZXJzIHRoYXQgZG9lc24ndCBzdXBwb3J0ICd0cmFuc2Zvcm0nIGF0dHJpYnV0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0geCAgICAgICAgICAgICAgIHggY29vcmRpbmF0ZSBvZiBvcmlnaW5hbCBwb3NpdGlvbiBvZiB0aGUgbWFya2VyCiAgICAgKiBAcGFyYW0geSAgICAgICAgICAgICAgIHkgY29vcmRpbmF0ZSBvZiBvcmlnaW5hbCBwb3NpdGlvbiBvZiB0aGUgbWFya2VyCiAgICAgKiBAcGFyYW0gYm91bmNlSGVpZ2h0ICAgIGhlaWdodCBvZiBib3VuY2luZyAocHgpCiAgICAgKgogICAgICogQHJldHVybiBhcnJheSBvZiBwb2ludHMgW3gsIHldCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZUljb25Nb3ZlUG9pbnRzKHgsIHksIGJvdW5jZUhlaWdodCkgewogICAgICAgIHZhciBwID0gW10sICAgICAgICAgICAgICAgICAgIC8vIGFycmF5IG9mIHBvaW50cwogICAgICAgICAgICBkSCA9IGJvdW5jZUhlaWdodCArIDE7ICAgIC8vIGRlbHRhIG9mIGhlaWdodAoKICAgICAgICAvKiBVc2UgZmFzdCBpbnZlcnNlIHdoaWxlIGxvb3AgdG8gZmlsbCB0aGUgYXJyYXkgKi8KICAgICAgICB3aGlsZSAoZEgtLSkgewogICAgICAgICAgICBwW2RIXSA9IFt4LCB5IC0gZEhdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHA7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGNhbGN1bGF0ZWQgYXJyYXkgb2YgcG9pbnRzIGZvciBzaGFkb3cgbW92ZW1lbnQuIFVzZWQgdG8gYW5pbWF0ZQogICAgICogbWFya2VycyBpbiBicm93c2VycyB0aGF0IGRvZXNuJ3Qgc3VwcG9ydCAndHJhbnNmb3JtJyBhdHRyaWJ1dGUuCiAgICAgKgogICAgICogQHBhcmFtIHggICAgICAgICAgICAgICB4IGNvb3JkaW5hdGUgb2Ygb3JpZ2luYWwgcG9zaXRpb24gb2YgdGhlIG1hcmtlcgogICAgICogQHBhcmFtIHkgICAgICAgICAgICAgICB5IGNvb3JkaW5hdGUgb2Ygb3JpZ2luYWwgcG9zaXRpb24gb2YgdGhlIG1hcmtlcgogICAgICogQHBhcmFtIGJvdW5jZUhlaWdodCAgICBoZWlnaHQgb2YgYm91bmNpbmcgKHB4KQogICAgICogQHBhcmFtIGFuZ2xlICAgICAgICAgICBzaGFkb3cgaW5jbGluYXRpb24gYW5nbGUsIGlmIG51bGwgc2hhZG93IGRvbid0CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgIG1vdmVzIGZyb20gaXQncyBpbml0aWFsIHBvc2l0aW9uIChyYWRpYW5zKQogICAgICoKICAgICAqIEByZXR1cm4gYXJyYXkgb2YgdGhlIHBvaW50cyBbeCwgeV0KICAgICAqLwogICAgZnVuY3Rpb24gY2FsY3VsYXRlU2hhZG93TW92ZVBvaW50cyh4LCB5LCBib3VuY2VIZWlnaHQsIGFuZ2xlKSB7CiAgICAgICAgaWYgKGFuZ2xlICE9IG51bGwpIHsgIC8vIGltcG9ydGFudDogMCBpcyBub3QgbnVsbAogICAgICAgICAgICByZXR1cm4gY2FsY3VsYXRlTGluZSh4LCB5LCBhbmdsZSwgYm91bmNlSGVpZ2h0ICsgMSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgcCA9IFtdLCBpID0gMDsgaSA8PSBib3VuY2VIZWlnaHQ7IGkrKykgewogICAgICAgICAgICAgICAgcFtpXSA9IFt4LCB5XTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGNhbGN1bGF0ZWQgYXJyYXkgb2YgdHJhbnNmb3JtYXRpb24gZGVmaW5pdGlvbnMgZm9yIHRoZSBhbmltYXRpb24KICAgICAqIG9mIGljb24gbW92ZW1lbnQuIEZ1bmN0aW9uIGRlZmluZXMgb25lIHRyYW5zZm9ybSBmb3IgZXZlcnkgcGl4ZWwgb2Ygc2hpZnQKICAgICAqIG9mIHRoZSBpY29uIGZyb20gaXQncyBvcmlnaW5hbCB5IHBvc2l0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB4ICAgICAgICAgICAgICAgeCBjb29yZGluYXRlIG9mIG9yaWdpbmFsIHBvc2l0aW9uIG9mIHRoZSBtYXJrZXIKICAgICAqIEBwYXJhbSB5ICAgICAgICAgICAgICAgeSBjb29yZGluYXRlIG9mIG9yaWdpbmFsIHBvc2l0aW9uIG9mIHRoZSBtYXJrZXIKICAgICAqIEBwYXJhbSBib3VuY2VIZWlnaHQgICAgaGVpZ2h0IG9mIGJvdW5jaW5nIChweCkKICAgICAqCiAgICAgKiBAcmV0dXJuIGFycmF5IG9mIHRyYW5zZm9ybWF0aW9uIGRlZmluaXRpb25zCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZUljb25Nb3ZlVHJhbnNmb3Jtcyh4LCB5LCBib3VuY2VIZWlnaHQpIHsKICAgICAgICB2YXIgdCA9IFtdLCAgICAgICAgICAgICAgICAgLy8gYXJyYXkgb2YgdHJhbnNmb3JtYXRpb25zCiAgICAgICAgICAgIGRZID0gYm91bmNlSGVpZ2h0ICsgMTsgIC8vIGRlbHRhIFkKCiAgICAgICAgLyogVXNlIGZhc3QgaW52ZXJzZSB3aGlsZSBsb29wIHRvIGZpbGwgdGhlIGFycmF5ICovCiAgICAgICAgd2hpbGUgKGRZLS0pIHsKCiAgICAgICAgICAgIC8qIFVzZSBtYXRyaXgzZCBmb3IgaGFyZHdhcmUgYWNjZWxlcmF0aW9uICovCiAgICAgICAgICAgIHRbZFldID0gJyBtYXRyaXgzZCgxLDAsMCwwLDAsMSwwLDAsMCwwLDEsMCwnICsgeCArICcsJyArICh5IC0gZFkpCiAgICAgICAgICAgICAgICArICcsMCwxKSAnOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGNhbGN1bGF0ZWQgYXJyYXkgb2YgdHJhbnNmb3JtYXRpb24gZGVmaW5pdGlvbnMgZm9yIHRoZSBhbmltYXRpb24KICAgICAqIG9mIHNoYWRvdyBtb3ZlbWVudC4gRnVuY3Rpb24gZGVmaW5lcyBvbmUgdHJhbnNmb3JtIGZvciBldmVyeSBwaXhlbCBvZgogICAgICogc2hpZnQgb2YgdGhlIHNoYWRvdyBmcm9tIGl0J3Mgb3JpZ2luYWwgcG9zaXRpb24uCiAgICAgKgogICAgICogQHBhcmFtIHggICAgICAgICAgICAgICB4IGNvb3JkaW5hdGUgb2Ygb3JpZ2luYWwgcG9zaXRpb24gb2YgbWFya2VyCiAgICAgKiBAcGFyYW0geSAgICAgICAgICAgICAgIHkgY29vcmRpbmF0ZSBvZiBvcmlnaW5hbCBwb3NpdGlvbiBvZiBtYXJrZXIKICAgICAqIEBwYXJhbSBib3VuY2VIZWlnaHQgICAgaGVpZ2h0IG9mIGJvdW5jaW5nIChweCkKICAgICAqIEBwYXJhbSBhbmdsZSAgICAgICAgICAgc2hhZG93IGluY2xpbmF0aW9uIGFuZ2xlLCBpZiBudWxsIHNoYWRvdyBkb24ndAogICAgICogICAgICAgICAgICAgICAgICAgICAgICBtb3ZlcyBmcm9tIGl0J3MgaW5pdGlhbCBwb3NpdGlvbiAocmFkaWFucykKICAgICAqCiAgICAgKiBAcmV0dXJuIGFycmF5IG9mIHRyYW5zZm9ybWF0aW9uIGRlZmluaXRpb25zCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZVNoYWRvd01vdmVUcmFuc2Zvcm1zKHgsIHksIGJvdW5jZUhlaWdodCwgYW5nbGUpIHsKICAgICAgICAvLyBUT0RPOiBjaGVjayB0aGlzIG1ldGhvZCB0byBrbm93IGlmIGJvdW5jZUhlaWdodCArIDEgaXMgbm9ybWFsCiAgICAgICAgdmFyIHQgPSBbXSwgICAgICAgICAgICAgICAgICAgLy8gYXJyYXkgb2YgdHJhbnNmb3JtYXRpb24gZGVmaW5pdGlvbnMKICAgICAgICAgICAgZFkgPSBib3VuY2VIZWlnaHQgKyAxOyAgICAvLyBkZWx0YSBZCgogICAgICAgIGlmIChhbmdsZSAhPSBudWxsKSB7ICAvLyBpbXBvcnRhbnQ6IDAgaXMgbm90IG51bGwKICAgICAgICAgICAgdmFyIHAgPSBjYWxjdWxhdGVMaW5lKHgsIHksIGFuZ2xlLCBib3VuY2VIZWlnaHQgKyAxKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBwID0gW10sIGkgPSAwOyBpIDw9IGJvdW5jZUhlaWdodDsgaSsrKSB7CiAgICAgICAgICAgICAgICBwW2ldID0gW3gsIHldOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvKiBVc2UgZmFzdCBpbnZlcnNlIHdoaWxlIGxvb3AgdG8gZmlsbCB0aGUgYXJyYXkgKi8KICAgICAgICB3aGlsZSAoZFktLSkgewoKICAgICAgICAgICAgLyogVXNlIG1hdHJpeDNkIGZvciBoYXJkd2FyZSBhY2NlbGVyYXRpb24gKi8KICAgICAgICAgICAgdFtkWV0gPSAnIG1hdHJpeDNkKDEsMCwwLDAsMCwxLDAsMCwwLDAsMSwwLCcgKyBwW2RZXVswXSArICcsJwogICAgICAgICAgICAgICAgKyBwW2RZXVsxXSArICcsMCwxKSAnOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGNhbGN1bGF0ZWQgYXJyYXkgb2YgdHJhbnNmb3JtYXRpb24gZGVmaW5pdGlvbnMgZm9yIHRoZSBhbmltYXRpb24KICAgICAqIG9mIGljb24gcmVzaXppbmcuIEZ1bmN0aW9uIGRlZmluZXMgb25lIHRyYW5zZm9ybSBmb3IgZXZlcnkgcGl4ZWwgb2YKICAgICAqIHJlc2l6aW5nIG9mIG1hcmtlciBmcm9tIGl0J3Mgb3JpZ2luYWwgaGVpZ2h0LgogICAgICoKICAgICAqIEBwYXJhbSB4ICAgICAgICAgICAgICAgICB4IGNvb3JkaW5hdGUgb2Ygb3JpZ2luYWwgcG9zaXRpb24gb2YgbWFya2VyCiAgICAgKiBAcGFyYW0geSAgICAgICAgICAgICAgICAgeSBjb29yZGluYXRlIG9mIG9yaWdpbmFsIHBvc2l0aW9uIG9mIG1hcmtlcgogICAgICogQHBhcmFtIGhlaWdodCAgICAgICAgICAgIG9yaWdpbmFsIG1hcmtlciBoZWlnaHQgKHB4KQogICAgICogQHBhcmFtIGNvbnRyYWN0SGVpZ2h0ICAgIGhlaWdodCBvZiBtYXJrZXIgY29udHJhY3Rpb24gKHB4KQogICAgICoKICAgICAqIEByZXR1cm4gYXJyYXkgb2YgdHJhbnNmb3JtYXRpb24gZGVmaW5pdGlvbnMKICAgICAqLwogICAgZnVuY3Rpb24gY2FsY3VsYXRlSWNvblJlc2l6ZVRyYW5zZm9ybXMoeCwgeSwgaGVpZ2h0LCBjb250cmFjdEhlaWdodCkgewogICAgICAgIHZhciB0ID0gW10sICAgICAgICAgICAgICAgICAgICAgLy8gYXJyYXkgb2YgdHJhbnNmb3JtYXRpb25zCiAgICAgICAgICAgIGRIID0gY29udHJhY3RIZWlnaHQgKyAxOyAgICAvLyBkZWx0YSBvZiBoZWlnaHQKCiAgICAgICAgLyogVXNlIGZhc3QgaW52ZXJzZSB3aGlsZSBsb29wIHRvIGZpbGwgdGhlIGFycmF5ICovCiAgICAgICAgd2hpbGUgKGRILS0pIHsKCiAgICAgICAgICAgIC8qIFVzZSBtYXRyaXgzZCBmb3IgaGFyZHdhcmUgYWNjZWxlcmF0aW9uICovCiAgICAgICAgICAgIHRbZEhdID0gJyBtYXRyaXgzZCgxLDAsMCwwLDAsJyArICgoaGVpZ2h0IC0gZEgpIC8gaGVpZ2h0KQogICAgICAgICAgICAgICAgKyAnLDAsMCwwLDAsMSwwLCcgKyB4ICsgJywnICsgKHkgKyBkSCkgKyAnLDAsMSkgJzsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0OwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBjYWxjdWxhdGVkIGFycmF5IG9mIHRyYW5zZm9ybWF0aW9uIGRlZmluaXRpb25zIGZvciB0aGUgYW5pbWF0aW9uCiAgICAgKiBvZiBzaGFkb3cgcmVzaXppbmcuIEZ1bmN0aW9uIGRlZmluZXMgb25lIHRyYW5zZm9ybSBmb3IgZXZlcnkgcGl4ZWwgb2YKICAgICAqIHNoYWRvdyByZXNpemluZy4KICAgICAqCiAgICAgKiBAcGFyYW0geCAgICAgICAgICAgICAgICAgeCBjb29yZGluYXRlIG9mIG9yaWdpbmFsIHBvc2l0aW9uIG9mIG1hcmtlcgogICAgICogQHBhcmFtIHkgICAgICAgICAgICAgICAgIHkgY29vcmRpbmF0ZSBvZiBvcmlnaW5hbCBwb3NpdGlvbiBvZiBtYXJrZXIKICAgICAqIEBwYXJhbSB3aWR0aCAgICAgICAgICAgICBvcmlnaW5hbCBtYXJrZXIgd2lkdGggKHB4KQogICAgICogQHBhcmFtIGhlaWdodCAgICAgICAgICAgIG9yaWdpbmFsIG1hcmtlciBoZWlnaHQgKHB4KQogICAgICogQHBhcmFtIGNvbnRyYWN0SGVpZ2h0ICAgIGhlaWdodCBvZiBtYXJrZXIgY29udHJhY3Rpb24gKHB4KQogICAgICogQHBhcmFtIGFuZ2xlICAgICAgICAgICAgIHNoYWRvdyBpbmNsaW5hdGlvbiBhbmdsZSAocmFkaWFucykKICAgICAqCiAgICAgKiBAcmV0dXJuIGFycmF5IG9mIHRyYW5zZm9ybWF0aW9uIGRlZmluaXRpb25zCiAgICAgKi8KICAgIC8vIFRPRE86IGZpeCAmIGRlcGxveSB0aGlzIGZ1bmN0aW9uCiAgICBmdW5jdGlvbiBjYWxjdWxhdGVTaGFkb3dSZXNpemVUcmFuc2Zvcm1zKHgsIHksIHdpZHRoLCBoZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyYWN0SGVpZ2h0LCBhbmdsZSkgewogICAgICAgIHZhciB0ID0gW10sICAgICAgICAgICAgICAgICAgICAgLy8gYXJyYXkgb2YgdHJhbnNmb3JtYXRpb24gZGVmaW5pdGlvbnMKICAgICAgICAgICAgcCA9IGNhbGN1bGF0ZUxpbmUod2lkdGgsIGhlaWdodCwgYW5nbGUgKyBNYXRoLlBJLCBjb250cmFjdEhlaWdodCksCiAgICAgICAgICAgIGRIID0gY29udHJhY3RIZWlnaHQgKyAxOyAgICAvLyBkZWx0YSBoZWlnaHQKCiAgICAgICAgLyogVXNlIGZhc3QgaW52ZXJzZSB3aGlsZSBsb29wIHRvIGZpbGwgdGhlIGFycmF5ICovCiAgICAgICAgd2hpbGUgKGRILS0pIHsKCiAgICAgICAgICAgIC8qIFVzZSBtYXRyaXgzZCBmb3IgaGFyZHdhcmUgYWNjZWxlcmF0aW9uICovCiAgICAgICAgICAgIHRbZEhdID0gJyBtYXRyaXgzZCgnICsgKHdpZHRoIC8gcFtkSF1bMF0pICsgICcsMCwwLDAsMCwnCiAgICAgICAgICAgICAgICArIChwW2RIXVsxXSAvIGhlaWdodCkgKyAnLDAsMCwwLDAsMSwwLCcgKyB4ICsgJywnCiAgICAgICAgICAgICAgICArICh5ICsgaGVpZ2h0IC0gcFtkSF1bMV0pICsgJywwLDEpICc7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgY2FsY3VsYXRlZCBhcnJheSBvZiBhbmluYXRpb24gc3RlcHMuIFRoaXMgZnVuY3Rpb24gdXNlZCB0bwogICAgICogY2FsY3VsYXRlIGJvdGggbW92ZW1lbnQgYW5kIHJlc2l6aW5nIGFuaW1hdGlvbnMuIEFycmF5cyBvZiBzdGVwcyBhcmUgdGhlbgogICAgICogY2FjaGVkIGluIF9ib3VuY2luZ01vdGlvbnNDYWNoZS4gRnVuY3Rpb24gY2hlY2tzIHRoaXMgY2FjaGUgYmVmb3JlIG1ha2UKICAgICAqIGFueSBjYWxjdWxhdGlvbnMuCiAgICAgKgogICAgICogQHBhcmFtIGhlaWdodCAgICBoZWlnaHQgb2YgbW92ZW1lbnQgb3IgcmVzaXppbmcgKHB4KQogICAgICogQHBhcmFtIHByZWZpeCAgICBwcmVmaXggb2YgdGhlIGtleSBpbiB0aGUgY2FjaGUuIE11c3QgYmUgYW55IHN0cmluZyB3aXRoCiAgICAgKiAgICAgICAgICAgICAgICAgIHRyYWlsaW5nICJfIiBjYXJhY3Rlci4KICAgICAqCiAgICAgKiBAcmV0dXJuIGFycmF5IG9mIGFuaW1hdGlvbiBzdGVwcwogICAgICovCiAgICBmdW5jdGlvbiBjYWxjdWxhdGVTdGVwcyhoZWlnaHQsIHByZWZpeCkgewogICAgICAgIHZhciBrZXkgPSBwcmVmaXggKyBoZWlnaHQsCiAgICAgICAgICAgIHN0ZXBzID0gW10sCiAgICAgICAgICAgIGk7CgogICAgICAgIC8qIENoZWNrIHRoZSBjYWNoZSAqLwogICAgICAgIGlmIChfYm91bmNpbmdNb3Rpb25zQ2FjaGVba2V5XSkgewogICAgICAgICAgICByZXR1cm4gX2JvdW5jaW5nTW90aW9uc0NhY2hlW2tleV07CiAgICAgICAgfQoKICAgICAgICAvKiBDYWxjdWxhdGUgdGhlIHNlcXVlbmNlIG9mIGFuaW1hdGlvbiBzdGVwczoKICAgICAgICAgKiBzdGVwcyA9IFsxIC4uIGhlaWdodF0gY29uY2F0IFtoZWlnaHQtMSAuLiAwXQogICAgICAgICAqLwogICAgICAgIGkgPSAxOwogICAgICAgIHdoaWxlIChpIDw9IGhlaWdodCkgewogICAgICAgICAgICBzdGVwcy5wdXNoKGkrKyk7CiAgICAgICAgfQoKICAgICAgICBpID0gaGVpZ2h0OwogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgc3RlcHMucHVzaChpKTsKICAgICAgICB9CgogICAgICAgIC8qIFNhdmUgc3RlcHMgdG8gdGhlIGNhY2hlICovCiAgICAgICAgX2JvdW5jaW5nTW90aW9uc0NhY2hlW2tleV0gPSBzdGVwczsKCiAgICAgICAgcmV0dXJuIHN0ZXBzOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBjYWxjdWxhdGVkIGFycmF5IG9mIGRlbGF5cyBiZXR3ZWVuIGFuaW1hdGlvbiBzdGFydCBhbmQgdGhlIHN0ZXBzCiAgICAgKiBvZiBhbmltYXRpb24uIFRoaXMgZnVuY3Rpb24gdXNlZCB0byBjYWxjdWxhdGUgYm90aCBtb3ZlbWVudCBhbmQgcmVzaXppbmcKICAgICAqIGFuaW1hdGlvbnMuIEVsZW1lbnQgd2l0aCBpbmRleCBpIG9mIHRoaXMgYXJyYXkgY29udGFpbnMgdGhlIGRlbGF5IGluCiAgICAgKiBtaWxsaXNlY29uZHMgYmV0d2VlbiBhbmltYXRpb24gc3RhcnQgYW5kIHRoZSBzdGVwIG51bWJlciBpLiBUaG9zZSBkZWxheXMKICAgICAqIGFyZSBjYWNoZWQgaW4gX2JvdW5jaW5nTW90aW9uc0NhY2hlLiBGdW5jdGlvbiBjaGVja3MgdGhpcyBjYWNoZSBiZWZvcmUKICAgICAqIG1ha2UgYW55IGNhbGN1bGF0aW9ucy4KICAgICAqCiAgICAgKiBAcGFyYW0gaGVpZ2h0ICAgIGhlaWdodCBvZiBtb3ZlbWVudCBvciByZXNpemluZyAocHgpCiAgICAgKiBAcGFyYW0gc3BlZWQgICAgIHNwZWVkIGNvZWZmaWNpZW50CiAgICAgKiBAcGFyYW0gcHJlZml4ICAgIHByZWZpeCBvZiB0aGUga2V5IGluIHRoZSBjYWNoZS4gTXVzdCBiZSBhbnkgc3RyaW5nIHdpdGgKICAgICAqICAgICAgICAgICAgICAgICAgdHJhaWxpbmcgIl8iIGNhcmFjdGVyLgogICAgICoKICAgICAqIEByZXR1cm4gYXJyYXkgb2YgZGVsYXlzIGJlZm9yZSBzdGVwcyBvZiBhbmltYXRpb24KICAgICAqLwogICAgZnVuY3Rpb24gY2FsY3VsYXRlRGVsYXlzKGhlaWdodCwgc3BlZWQsIHByZWZpeCkgewogICAgICAgIHZhciBrZXkgPSBwcmVmaXggKyBoZWlnaHQgKyAnXycgKyBzcGVlZCwKICAgICAgICAgICAgZGVsdGFzID0gW10sICAgIC8vIHRpbWUgYmV0d2VlbiBzdGVwcyBvZiBhbmltYXRpb24KICAgICAgICAgICAgZGVsYXlzID0gW10sICAgIC8vIGRlbGF5cyBiZWZvcmUgc3RlcHMgZnJvbSBiZWdpbm5pbmcgb2YgYW5pbWF0aW9uCiAgICAgICAgICAgIHRvdGFsRGVsYXkgPSAwLAogICAgICAgICAgICBsLAogICAgICAgICAgICBpOwoKICAgICAgICAvKiBDaGVjayB0aGUgY2FjaGUgKi8KICAgICAgICBpZiAoX2JvdW5jaW5nTW90aW9uc0NhY2hlW2tleV0pIHsKICAgICAgICAgICAgcmV0dXJuIF9ib3VuY2luZ01vdGlvbnNDYWNoZVtrZXldOwogICAgICAgIH0KCiAgICAgICAgLyogQ2FsY3VsYXRlIGRlbHRhIHRpbWUgZm9yIGJvdW5jaW5nIGFuaW1hdGlvbiAqLwoKICAgICAgICAvKiBEZWx0YSB0aW1lIHRvIG1vdmVtZW50IGluIG9uZSBkaXJlY3Rpb24gKi8KICAgICAgICBkZWx0YXNbaGVpZ2h0XSA9IHNwZWVkOwogICAgICAgIGRlbHRhc1swXSA9IDA7CiAgICAgICAgaSA9IGhlaWdodDsKICAgICAgICB3aGlsZSAoLS1pKSB7CiAgICAgICAgICAgIGRlbHRhc1tpXSA9IE1hdGgucm91bmQoc3BlZWQgLyAoaGVpZ2h0IC0gaSkpOwogICAgICAgIH0KCiAgICAgICAgLyogRGVsdGEgdGltZSBmb3IgbW92ZW1lbnQgaW4gdHdvIGRpcmVjdGlvbnMgKi8KICAgICAgICBpID0gaGVpZ2h0OwogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgZGVsdGFzLnB1c2goZGVsdGFzW2ldKTsKICAgICAgICB9CgogICAgICAgIC8qIENhbGN1bGF0ZSBtb3ZlIGRlbGF5cyAoY3VtdWxhdGVkIGRlbHRhcykgKi8KICAgICAgICAvLyBUT0RPOiBpbnN0ZWFkIG9mIGRlbHRhcy5sZW5naHQgd3JpdGUgYm91bmNlSGVpZ2h0ICogMiAtIDEKICAgICAgICBmb3IgKGkgPSAwLCBsID0gZGVsdGFzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0b3RhbERlbGF5ICs9IGRlbHRhc1tpXTsKICAgICAgICAgICAgZGVsYXlzLnB1c2godG90YWxEZWxheSk7CiAgICAgICAgfQoKICAgICAgICAvKiBTYXZlIG1vdmUgZGVsYXlzIHRvIGNhY2hlICovCiAgICAgICAgX2JvdW5jaW5nTW90aW9uc0NhY2hlW2tleV0gPSBkZWxheXM7CgogICAgICAgIHJldHVybiBkZWxheXM7CiAgICB9CgogICAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICogICAgICAgICBDbGFzcyAic3RhdGljIiBtZXRob2RzCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKi8KCiAgICBMLk1hcmtlci5fYm91bmNpbmdNYXJrZXJzID0gW107ICAgICAvLyBhcnJheSBvZiBib3VuY2luZyBtYXJrZXJzCgogICAgLyoqCiAgICAgKiBSZWdpc3RlcnMgZGVmYXVsdCBvcHRpb25zIG9mIGJvdW5jaW5nIGFuaW1hdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0gb3B0aW9ucyAgICBvYmplY3Qgd2l0aCBvcHRpb25zCiAgICAgKi8KICAgIEwuTWFya2VyLnNldEJvdW5jaW5nT3B0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBMLmV4dGVuZChMLk1hcmtlci5wcm90b3R5cGUuX2JvdW5jaW5nT3B0aW9ucywgb3B0aW9ucyk7CiAgICB9OwoKICAgIC8qKgogICAgICogUmV0dXJucyBhcnJheSBvZiBjdXJyZW50bHkgYm91bmNpbmcgbWFya2Vycy4KICAgICAqCiAgICAgKiBAcmV0dXJuIGFycmF5IG9mIGJvdW5jaW5nIG1hcmtlcnMKICAgICAqLwogICAgTC5NYXJrZXIuZ2V0Qm91bmNpbmdNYXJrZXJzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIEwuTWFya2VyLl9ib3VuY2luZ01hcmtlcnM7CiAgICB9OwoKICAgIC8qKgogICAgICogU3RvcHMgdGhlIGJvdW5jaW5nIG9mIGFsbCBjdXJyZW50bHkgYm91bmNpbmcgbWFya2Vycy4gUHVyZ2UgdGhlIGFycmF5IG9mCiAgICAgKiBib3VuY2luZyBtYXJrZXJzLgogICAgICovCiAgICBMLk1hcmtlci5zdG9wQWxsQm91bmNpbmdNYXJrZXJzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG1hcmtlcjsKICAgICAgICB3aGlsZSAobWFya2VyID0gTC5NYXJrZXIuX2JvdW5jaW5nTWFya2Vycy5zaGlmdCgpKSB7CiAgICAgICAgICAgIG1hcmtlci5fYm91bmNpbmdNb3Rpb24uaXNCb3VuY2luZyA9IGZhbHNlOyAgICAvLyBzdG9wIGJvdW5jaW5nCiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEFkZHMgdGhlIG1hcmtlciB0byB0aGUgbGlzdCBvZiBib3VuY2luZyBtYXJrZXJzLiBJZiBmbGFnICdleGNsdXNpdmUnIGlzCiAgICAgKiBzZXQgdG8gdHJ1ZSwgc3RvcHMgYWxsIGJvdW5jaW5nIG1hcmtlcnMgYmVmb3JlLgogICAgICoKICAgICAqIEBwYXJhbSBtYXJrZXIgICAgICBtYXJrZXIgb2JqZWN0CiAgICAgKiBAcGFyYW0gZXhjbHVzaXZlICAgZmxhZyBvZiBleGNsdXNpdmUgYm91bmNpbmcuIElmIHNldCB0byB0cnVlLCBzdG9wcyB0aGUKICAgICAqICAgICAgICAgICAgICAgICAgICBib3VuY2luZyBvZiBhbGwgb3RoZXIgbWFya2Vycy4KICAgICAqLwogICAgTC5NYXJrZXIuX2FkZEJvdW5jaW5nTWFya2VyID0gZnVuY3Rpb24obWFya2VyLCBleGNsdXNpdmUpIHsKICAgICAgICBpZiAoZXhjbHVzaXZlIHx8IG1hcmtlci5fYm91bmNpbmdPcHRpb25zLmV4Y2x1c2l2ZSkgewogICAgICAgICAgICBMLk1hcmtlci5zdG9wQWxsQm91bmNpbmdNYXJrZXJzKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgTC5NYXJrZXIuX3N0b3BFY2x1c2l2ZU1hcmtlckJvdW5jaW5nKCk7CiAgICAgICAgfQogICAgICAgIEwuTWFya2VyLl9ib3VuY2luZ01hcmtlcnMucHVzaChtYXJrZXIpOwogICAgfTsKCiAgICAvKioKICAgICAqIFJlbW92ZXMgdGhlIG1hcmtlciBmcm9tIHRoZSBsaXN0IG9mIGJvdW5jaW5nIG1hcmtlcnMuCiAgICAgKgogICAgICogQHBhcmFtIG1hcmtlciAgICBtYXJrZXIgb2JqZWN0CiAgICAgKi8KICAgIEwuTWFya2VyLl9yZW1vdmVCb3VuY2luZ01hcmtlciA9IGZ1bmN0aW9uKG1hcmtlcikgewogICAgICAgIHZhciBpID0gTC5NYXJrZXIuX2JvdW5jaW5nTWFya2Vycy5sZW5ndGg7CgogICAgICAgIGlmIChpKSB7CiAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgIGlmIChMLk1hcmtlci5fYm91bmNpbmdNYXJrZXJzW2ldID09IG1hcmtlcikgewogICAgICAgICAgICAgICAgICAgIEwuTWFya2VyLl9ib3VuY2luZ01hcmtlcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIFN0b3BzIHRoZSBib3VuY2luZyBvZiBleGNsdXNpdmUgbWFya2VyLgogICAgICovCiAgICBMLk1hcmtlci5fc3RvcEVjbHVzaXZlTWFya2VyQm91bmNpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgaSA9IEwuTWFya2VyLl9ib3VuY2luZ01hcmtlcnMubGVuZ3RoOwoKICAgICAgICBpZiAoaSkgewogICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgICBpZiAoTC5NYXJrZXIuX2JvdW5jaW5nTWFya2Vyc1tpXS5fYm91bmNpbmdPcHRpb25zLmV4Y2x1c2l2ZSkgewogICAgICAgICAgICAgICAgICAgIEwuTWFya2VyLl9ib3VuY2luZ01hcmtlcnNbaV0uX2JvdW5jaW5nTW90aW9uLmlzQm91bmNpbmcgPQogICAgICAgICAgICAgICAgICAgICAgICBmYWxzZTsgICAgLy8gc3RvcCBib3VuY2luZwogICAgICAgICAgICAgICAgICAgIEwuTWFya2VyLl9ib3VuY2luZ01hcmtlcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKiAgICAgICAgIEwuTWFya2VyLnByb3RvdHlwZSBtZXRob2RzIChzaGFyZWQgYnkgYWxsIGluc3RhbmNlcykKICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAqLwoKICAgIEwuTWFya2VyLmluY2x1ZGUoewoKICAgICAgICAvKiBEZWZhdWx0IGJvdW5jaW5nIGFuaW1hdGlvbiBwcm9wZXJ0aWVzICovCiAgICAgICAgX2JvdW5jaW5nT3B0aW9uczogewogICAgICAgICAgICBib3VuY2VIZWlnaHQgICA6IDE1LCAgICAvLyBob3cgaGlnaCBtYXJrZXIgY2FuIGJvdW5jZSAocHgpCiAgICAgICAgICAgIGNvbnRyYWN0SGVpZ2h0IDogMTIsICAgIC8vIGhvdyBtdWNoIG1hcmtlciBjYW4gY29udHJhY3QgKHB4KQogICAgICAgICAgICBib3VuY2VTcGVlZCAgICA6IDUyLCAgICAvLyBib3VuY2luZyBzcGVlZCBjb2VmZmljaWVudAogICAgICAgICAgICBjb250cmFjdFNwZWVkICA6IDUyLCAgICAvLyBjb250cmFjdGluZyBzcGVlZCBjb2VmZmljaWVudAogICAgICAgICAgICBzaGFkb3dBbmdsZSAgICA6IC0gTWF0aC5QSSAvIDQsIC8vIHNoYWRvdyBpbmNsaW5hdGlvbiBhbmdsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIChyYWRpYW5zKTsgbnVsbCB2YWx1ZSBhbm51bGF0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzaGFkb3cgbW92ZW1lbnQKICAgICAgICAgICAgZWxhc3RpYyAgICAgICAgOiB0cnVlLCAgLy8gYWN0aXZhdGUgY29udHJhY3QgYW5pbWF0aW9uCiAgICAgICAgICAgIGV4Y2x1c2l2ZSAgICAgIDogZmFsc2UsIC8vIG1hbnkgbWFya2VycyBjYW4gYm91bmNlIGluIHRoZSBzYW1lIHRpbWUKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZWdpc3RlcnMgb3B0aW9ucyBvZiBib3VuY2luZyBhbmltYXRpb24gZm9yIHRoaXMgbWFya2VyLiBBZnRlcgogICAgICAgICAqIHJlZ2lzdHJhdGlvbiBvZiBvcHRpb25zIGZvciBjb25jcmVldCBtYXJrZXIsIGl0IHdpbGwgaWdub3JlIHRoZQogICAgICAgICAqIGNoYW5nZXMgb2YgZGVmYXVsdCBvcHRpb25zLiBGdW5jdGlvbiBhdXRvbWF0aWNhbGx5IHJlY2FsY3VsYXRlcwogICAgICAgICAqIGFuaW1hdGlvbiBzdGVwcyBhbmQgZGVsYXlzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMgICAgb3B0aW9ucyBvYmplY3QKICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4gdGhpcyBtYXJrZXIKICAgICAgICAgKi8KICAgICAgICBzZXRCb3VuY2luZ09wdGlvbnM6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCiAgICAgICAgICAgIC8qIElmIF9ib3VuY2luZ09wdGlvbnMgd2FzIG5vdCByZWRlZmluZWQgeWV0IGZvciB0aGlzIG1hcmtlciBjcmVhdGUKICAgICAgICAgICAgICogb3duIHByb3BlcnR5IGFuZCBjbG9uZSBfYm91bmNpbmdPcHRpb25zIG9mIHByb3RvdHlwZS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGlmICghdGhpcy5oYXNPd25Qcm9wZXJ0eSgnX2JvdW5jaW5nT3B0aW9ucycpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9ib3VuY2luZ09wdGlvbnMgPSBMLmV4dGVuZCgKICAgICAgICAgICAgICAgICAgICB7fSwKICAgICAgICAgICAgICAgICAgICBMLk1hcmtlci5wcm90b3R5cGUuX2JvdW5jaW5nT3B0aW9ucwogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogQ29weSBvcHRpb25zIHBhc3NlZCBhcyBwYXJhbSAqLwogICAgICAgICAgICBMLmV4dGVuZCh0aGlzLl9ib3VuY2luZ09wdGlvbnMsIG9wdGlvbnMpOwoKICAgICAgICAgICAgLyogUmVjYWxjdWxhdGUgc3RlcHMgJiBkZWxheXMgb2YgbW92ZW1lbnQgJiByZXNpemUgYW5pbWF0aW9ucyAqLwogICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVUaW1lbGluZSgpOwoKICAgICAgICAgICAgLyogUmVjYWxjdWxhdGUgdHJhbnNmb3JtYXRpb25zICovCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZVRyYW5zZm9ybXMoKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOyAgICAvLyBmbHVlbnQgQVBJCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0cnVlIGlmIHRoaXMgbWFya2VyIGlzIGJvdW5jaW5nLiBJZiB0aGlzIG1hcmtlciBpcyBub3QKICAgICAgICAgKiBib3VuY2luZyByZXR1cm5zIGZhbHNlLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB0cnVlIGlmIG1hcmtlciBpcyBib3VuY2luZywgZmFsc2UgaWYgbm90CiAgICAgICAgICovCiAgICAgICAgaXNCb3VuY2luZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9ib3VuY2luZ01vdGlvbi5pc0JvdW5jaW5nOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIExldCdzIGJvdW5jZSBub3chCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gdGltZXMgICAgbnVtYmVyIG9mIGFuaW1hdGlvbiByZXBlYXRpb25zIChvcHRpb25hbCkKICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4gdGhpcyBtYXJrZXIKICAgICAgICAgKi8KICAgICAgICBib3VuY2U6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgbWFya2VyID0gdGhpcywKICAgICAgICAgICAgICAgIGljb24gICA9IHRoaXMuX2ljb24sCiAgICAgICAgICAgICAgICBzaGFkb3cgPSB0aGlzLl9zaGFkb3csCgogICAgICAgICAgICAgICAgYm91bmNpbmdPcHRpb25zID0gbWFya2VyLl9ib3VuY2luZ09wdGlvbnMsCiAgICAgICAgICAgICAgICBtb3Rpb24gICAgICAgICAgPSBtYXJrZXIuX2JvdW5jaW5nTW90aW9uLAoKICAgICAgICAgICAgICAgIGJvdW5jZUhlaWdodCAgID0gYm91bmNpbmdPcHRpb25zLmJvdW5jZUhlaWdodCwKICAgICAgICAgICAgICAgIGNvbnRyYWN0SGVpZ2h0ID0gYm91bmNpbmdPcHRpb25zLmNvbnRyYWN0SGVpZ2h0LAogICAgICAgICAgICAgICAgYm91bmNlU3BlZWQgICAgPSBib3VuY2luZ09wdGlvbnMuYm91bmNlU3BlZWQsCiAgICAgICAgICAgICAgICBjb250cmFjdFNwZWVkICA9IGJvdW5jaW5nT3B0aW9ucy5jb250cmFjdFNwZWVkLAogICAgICAgICAgICAgICAgc2hhZG93QW5nbGUgICAgPSBib3VuY2luZ09wdGlvbnMuc2hhZG93QW5nbGUsCiAgICAgICAgICAgICAgICBlbGFzdGljICAgICAgICA9IGJvdW5jaW5nT3B0aW9ucy5lbGFzdGljLAogICAgICAgICAgICAgICAgZXhjbHVzaXZlICAgICAgPSBib3VuY2luZ09wdGlvbnMuZXhjbHVzaXZlLAoKICAgICAgICAgICAgICAgIG1vdmVTdGVwcyAgICA9IG1vdGlvbi5tb3ZlU3RlcHMsCiAgICAgICAgICAgICAgICBtb3ZlRGVsYXlzICAgPSBtb3Rpb24ubW92ZURlbGF5cywKICAgICAgICAgICAgICAgIHJlc2l6ZVN0ZXBzICA9IG1vdGlvbi5yZXNpemVTdGVwcywKICAgICAgICAgICAgICAgIHJlc2l6ZURlbGF5cyA9IG1vdGlvbi5yZXNpemVEZWxheXMsCgogICAgICAgICAgICAgICAgbmJNb3ZlU3RlcHMgICA9IG1vdmVTdGVwcy5sZW5ndGgsCiAgICAgICAgICAgICAgICBuYlJlc2l6ZVN0ZXBzID0gcmVzaXplU3RlcHMubGVuZ3RoLAoKICAgICAgICAgICAgICAgIGJhc2VJY29uQ3NzVGV4dCAgID0gbW90aW9uLmJhc2VJY29uQ3NzVGV4dCwKICAgICAgICAgICAgICAgIGJhc2VTaGFkb3dDc3NUZXh0ID0gbW90aW9uLmJhc2VTaGFkb3dDc3NUZXh0LAoKICAgICAgICAgICAgICAgIGlzM2QgPSBMLkJyb3dzZXIuYW55M2QsCgogICAgICAgICAgICAgICAgdGltZXMgPSBudWxsOyAgICAvLyBudWxsIGZvciBpbmZpbml0ZSBib3VuY2luZwoKICAgICAgICAgICAgaWYgKG1vdGlvbi5ib3VuY2luZ0FuaW1hdGlvblBsYXlpbmcpIHsKICAgICAgICAgICAgICAgIG1vdGlvbi5pc0JvdW5jaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewogICAgICAgICAgICAgICAgdGltZXMgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBNYWtlcyB0aGUgc3RlcCBvZiB0aGUgbW92ZW1lbnQgYW5pbWF0aW9uLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0gc3RlcCAgICBzdGVwIG51bWJlcgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZnVuY3Rpb24gbWFrZU1vdmVTdGVwKHN0ZXApIHsKCiAgICAgICAgICAgICAgICAvKiBSZXNldCBpY29uJ3MgY3NzVGV4dCAqLwoJCQkJaWYoaWNvbil7CgkJCQkJaWNvbi5zdHlsZS5jc3NUZXh0ID0gYmFzZUljb25Dc3NUZXh0CgkJCQkJCSsgJ3otaW5kZXg6ICcgKyBtYXJrZXIuX3pJbmRleCArICc7JwoJCQkJCQkrIHRyYW5zZm9ybSArICc6ICcgKyBtb3Rpb24uaWNvbk1vdmVUcmFuc2Zvcm1zW3N0ZXBdOwoJCQkJfQogICAgICAgICAgICAgICAgLyogUmVzZXQgc2hhZG93J3MgY3NzVGV4dCAqLwogICAgICAgICAgICAgICAgaWYgKHNoYWRvdykgewogICAgICAgICAgICAgICAgICAgIHNoYWRvdy5zdHlsZS5jc3NUZXh0ID0gYmFzZVNoYWRvd0Nzc1RleHQKICAgICAgICAgICAgICAgICAgICAgICAgKyB0cmFuc2Zvcm0gKyAnOiAnCiAgICAgICAgICAgICAgICAgICAgICAgICsgbW90aW9uLnNoYWRvd01vdmVUcmFuc2Zvcm1zW3N0ZXBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogTWFrZXMgdGhlIHN0ZXAgb2YgdGhlIG1vdmVtZW50IGFuaW1hdGlvbiBpbiBubyAzRCBhYmxlIHdlYgogICAgICAgICAgICAgKiBicm93c2VyLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0gc3RlcCAgICBzdGVwIG51bWJlcgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZnVuY3Rpb24gbWFrZU1vdmVTdGVwTm8zRChzdGVwKSB7CgogICAgICAgICAgICAgICAgLyogUmVzZXQgaWNvbidzIGNzc1RleHQgKi8KICAgICAgICAgICAgICAgIGljb24uc3R5bGUuY3NzVGV4dCA9IGJhc2VJY29uQ3NzVGV4dAogICAgICAgICAgICAgICAgICAgICsgJ3otaW5kZXg6ICcgKyBtYXJrZXIuX3pJbmRleCArICc7JzsKICAgICAgICAgICAgICAgIGljb24uc3R5bGUubGVmdCA9IG1vdGlvbi5pY29uTW92ZVBvaW50c1tzdGVwXVswXSArICdweCc7CiAgICAgICAgICAgICAgICBpY29uLnN0eWxlLnRvcCAgPSBtb3Rpb24uaWNvbk1vdmVQb2ludHNbc3RlcF1bMV0gKyAncHgnOwoKICAgICAgICAgICAgICAgIC8qIFJlc2V0IHNoYWRvdydzIGNzc1RleHQgKi8KICAgICAgICAgICAgICAgIGlmIChzaGFkb3cpIHsKICAgICAgICAgICAgICAgICAgICBzaGFkb3cuc3R5bGUuY3NzVGV4dCA9IGJhc2VTaGFkb3dDc3NUZXh0OwogICAgICAgICAgICAgICAgICAgIHNoYWRvdy5zdHlsZS5sZWZ0ID0gbW90aW9uLnNoYWRvd01vdmVQb2ludHNbc3RlcF1bMF0gKyAncHgnOwogICAgICAgICAgICAgICAgICAgIHNoYWRvdy5zdHlsZS50b3AgID0gbW90aW9uLnNoYWRvd01vdmVQb2ludHNbc3RlcF1bMV0gKyAncHgnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogTWFrZXMgdGhlIHN0ZXAgb2YgcmVzaXppbmcgYW5pbWF0aW9uLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0gc3RlcCAgICBzdGVwIG51bWJlcgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZnVuY3Rpb24gbWFrZVJlc2l6ZVN0ZXAoc3RlcCkgewoKICAgICAgICAgICAgICAgIC8qIFJlc2V0IGljb24ncyBjc3NUZXh0ICovCgkJCQlpZihpY29uKXsKCQkJCQlpY29uLnN0eWxlLmNzc1RleHQgPSBiYXNlSWNvbkNzc1RleHQKCQkJCQkJKyAnei1pbmRleDogJyArIG1hcmtlci5fekluZGV4ICsgJzsnCgkJCQkJCSsgdHJhbnNmb3JtICsgJzogJyArIG1vdGlvbi5pY29uUmVzaXplVHJhbnNmb3Jtc1tzdGVwXTsKCQkJCX0KCiAgICAgICAgICAgICAgICAvKiBSZXNldCBzaGFkb3cncyBjc3NUZXh0ICovCiAgICAgICAgICAgICAgICBpZiAoc2hhZG93ICYmIHNoYWRvd0FuZ2xlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzaGFkb3cuc3R5bGUuY3NzVGV4dCA9IGJhc2VTaGFkb3dDc3NUZXh0CiAgICAgICAgICAgICAgICAgICAgICAgICsgdHJhbnNmb3JtICsgJzogJwogICAgICAgICAgICAgICAgICAgICAgICArIG1vdGlvbi5zaGFkb3dSZXNpemVUcmFuc2Zvcm1zW3N0ZXBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogTW92ZXMgdGhlIG1hcmtlciB1cCAmIGRvd24uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmdW5jdGlvbiBtb3ZlKCkgewogICAgICAgICAgICAgICAgaWYgKHRpbWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEtLXRpbWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1vdGlvbi5pc0JvdW5jaW5nID0gZmFsc2U7ICAvLyB0aGlzIGlzIHRoZSBsYXN0IGJvdW5jaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIG1vdGlvbi5ib3VuY2luZ0FuaW1hdGlvblBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIGkgPSBuYk1vdmVTdGVwczsKCiAgICAgICAgICAgICAgICAvKiBMYXVjaCB0aW1lb3V0cyBmb3IgZXZlcnkgc3RlcCBvZiB0aGUgbW92ZW1lbnQgYW5pbWF0aW9uICovCiAgICAgICAgICAgICAgICBpZiAoaXMzZCkgewogICAgICAgICAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ha2VNb3ZlU3RlcCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmVEZWxheXNbaV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlU3RlcHNbaV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFrZU1vdmVTdGVwTm8zRCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmVEZWxheXNbaV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlU3RlcHNbaV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvKiBBdCB0aGUgZW5kIG9mIG1vdmVtZW50IGFuaW1hdGlvbiBjaGVjayBpZiBjb250aW51ZSB0aGUKICAgICAgICAgICAgICAgICAqIGJvdW5jaW5nIHdpdGggcmV6aXNlIGFuaW1hdGlvbiwgbW92ZSBhbmltYXRpb24gb3Igc3RvcCBpdC4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgLy8gVE9ETzogbG9uZ2VyIHRpbWVvdXQgaWYgdGhlcmUgaXMgbm90IHJlc2l6ZSBwYXJ0IG9mIGFuaW1hdGlvbgogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZWxhc3RpYyAmJiBpczNkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc2l6ZSgpOyAgICAvLyBwb3NzaWJsZSBvbmx5IGluIDNEIGFibGUgYnJvd3NlcnMKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1vdGlvbi5pc0JvdW5jaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQobW92ZSwgYm91bmNlU3BlZWQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1vdGlvbi5ib3VuY2luZ0FuaW1hdGlvblBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCBtb3ZlRGVsYXlzW25iTW92ZVN0ZXBzIC0gMV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQ29udHJhY3RzICYgZXhwYW5kcyB0aGUgbWFya2VyLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZnVuY3Rpb24gcmVzaXplKCkgewogICAgICAgICAgICAgICAgdmFyIGkgPSBuYlJlc2l6ZVN0ZXBzOwoKICAgICAgICAgICAgICAgIC8qIFN0b3AgYW5pbWF0aW9uIGF0IHRoZSBlbmQgaWYgbmVjZXNzYXJ5ICovCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIW1vdGlvbi5pc0JvdW5jaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1vdGlvbi5ib3VuY2luZ0FuaW1hdGlvblBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCByZXNpemVEZWxheXNbaV0pOwoKICAgICAgICAgICAgICAgIC8qIExhdWNoIHRpbWVvdXRzIGZvciBldmVyeSBzdGVwIG9mIHRoZSBjb250cmFjdGlvbiBhbmltYXRpb24gKi8KICAgICAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KAogICAgICAgICAgICAgICAgICAgICAgICBtYWtlUmVzaXplU3RlcCwKICAgICAgICAgICAgICAgICAgICAgICAgcmVzaXplRGVsYXlzW2ldLAogICAgICAgICAgICAgICAgICAgICAgICByZXNpemVTdGVwc1tpXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyogQXQgdGhlIGVuZCBvZiBjb250cmFjdGlvbiBhbmltYXRpb24gY2hlY2sgaWYgY29udGludWUgdGhlCiAgICAgICAgICAgICAgICAgKiBib3VuY2luZyB3aXRoIG1vdmUgYW5pbWF0aW9uIG9yIHN0b3AgaXQuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1vdGlvbi5pc0JvdW5jaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBtYXJrZXIuZmlyZSgnYm91bmNlZW5kJyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHJlc2l6ZURlbGF5c1tuYlJlc2l6ZVN0ZXBzIC0gMV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBMLk1hcmtlci5fYWRkQm91bmNpbmdNYXJrZXIobWFya2VyLCBleGNsdXNpdmUpOwogICAgICAgICAgICBtb3Rpb24uaXNCb3VuY2luZyA9IHRydWU7CiAgICAgICAgICAgIG1vdGlvbi5ib3VuY2luZ0FuaW1hdGlvblBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICBtb3ZlKCk7ICAgICAgICAvLyBzdGFydCBhbmltYXRpb24KCiAgICAgICAgICAgIHJldHVybiBtYXJrZXI7ICAgIC8vIGZsdWVudCBBUEkKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTdG9wcyBib3VuY2luZyBvZiB0aGlzIG1hcmtlci4gTm90ZTogdGhlIGJvdW5jaW5nIG5vdCBzdG9wcwogICAgICAgICAqIGltbWVkaWF0bHkgYWZ0ZXIgdGhlIGNhbGwgb2YgdGhpcyBtZXRob2QuIEluc3RlYWQsIHRoZSBhbmltYXRpb24gaXMKICAgICAgICAgKiBleGVjdXRlZCB1bnRpbCBtYXJrZXIgcmV0dXJucyB0byBpdCdzIG9yaWdpbmFsIHBvc2l0aW9uIGFuZCB0YWtlcwogICAgICAgICAqIGl0J3MgZnVsbCBzaXplLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB0aGlzIG1hcmtlcgogICAgICAgICAqLwogICAgICAgIHN0b3BCb3VuY2luZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nTW90aW9uLmlzQm91bmNpbmcgPSBmYWxzZTsKICAgICAgICAgICAgTC5NYXJrZXIuX3JlbW92ZUJvdW5jaW5nTWFya2VyKHRoaXMpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7ICAgIC8vIGZsdWVudCBBUEkKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTdGFydHMvc3RvcHMgYm91bmNpbmcgb2YgdGhpcyBtYXJrZXIuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHRoaXMgbWFya2VyCiAgICAgICAgICovCiAgICAgICAgdG9nZ2xlQm91bmNpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5fYm91bmNpbmdNb3Rpb24uaXNCb3VuY2luZykgewogICAgICAgICAgICAgICAgdGhpcy5zdG9wQm91bmNpbmcoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYm91bmNlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzOyAgICAvLyBmbHVlbnQgQVBJCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ2FsY3VsYXRlcyBtb3ZlU3RlcHMsIG1vdmVEZWxheXMsIHJlc2l6ZVN0ZXBzICYgcmVzaXplRGVsYXlzIGZvcgogICAgICAgICAqIGFuaW1hdGlvbiBvZiB0aGlzIG1hcmtlci4KICAgICAgICAgKi8KICAgICAgICBfY2FsY3VsYXRlVGltZWxpbmU6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgLyoKICAgICAgICAgICAgICogQW5pbWF0aW9uIGlzIGRlZmluZWQgYnkgc2hpZnRzIG9mIHRoZSBtYXJrZXIgZnJvbSBpdCdzIG9yaWdpbmFsCiAgICAgICAgICAgICAqIHBvc2l0aW9uLiBFYWNoIHN0ZXAgb2YgdGhlIGFuaW1hdGlvbiBpcyBhIHNoaWZ0IG9mIDFweC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogV2UgZGVmaW5lIGZ1bmN0aW9uIGYoeCkgLSB0aW1lIG9mIHdhaXRpbmcgYmV0d2VlbiBzaGlmdCBvZiB4IHB4CiAgICAgICAgICAgICAqIGFuZCBzaGlmdCBvZiB4KzEgcHguCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFdlIHVzZSBmb3IgdGhpcyB0aGUgaW52ZXJzZSBmdW5jdGlvbiBmKHgpID0gYSAvIHg7IHdoZXJlIGEgaXMgdGhlCiAgICAgICAgICAgICAqIGFuaW1hdGlvbiBzcGVlZCBhbmQgeCBpcyB0aGUgc2hpZnQgZnJvbSBvcmlnaW5hbCBwb3NpdGlvbiBpbiBweC4KICAgICAgICAgICAgICovCgogICAgICAgICAgICAvKiByZWNhbGN1bGF0ZSBzdGVwcyAmIGRlbGF5cyBvZiBtb3ZlbWVudCAmIHJlc2l6ZSBhbmltYXRpb25zICovCiAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nTW90aW9uLm1vdmVTdGVwcyA9IGNhbGN1bGF0ZVN0ZXBzKAogICAgICAgICAgICAgICAgdGhpcy5fYm91bmNpbmdPcHRpb25zLmJvdW5jZUhlaWdodCwKICAgICAgICAgICAgICAgICdtb3ZlU3RlcHNfJwogICAgICAgICAgICApOwoKICAgICAgICAgICAgdGhpcy5fYm91bmNpbmdNb3Rpb24ubW92ZURlbGF5cyA9IGNhbGN1bGF0ZURlbGF5cygKICAgICAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nT3B0aW9ucy5ib3VuY2VIZWlnaHQsCiAgICAgICAgICAgICAgICB0aGlzLl9ib3VuY2luZ09wdGlvbnMuYm91bmNlU3BlZWQsCiAgICAgICAgICAgICAgICAnbW92ZURlbGF5c18nCiAgICAgICAgICAgICk7CgogICAgICAgICAgICAvKiBDYWxjdWxhdGUgcmVzaXplIHN0ZXBzICYgZGVsYXlzIG9ubHkgaWYgZWxhc3RpYyBhbmltYXRpb24gaXMKICAgICAgICAgICAgICogZW5hYmxlZCAqLwogICAgICAgICAgICBpZiAodGhpcy5fYm91bmNpbmdPcHRpb25zLmVsYXN0aWMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nTW90aW9uLnJlc2l6ZVN0ZXBzID0gY2FsY3VsYXRlU3RlcHMoCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYm91bmNpbmdPcHRpb25zLmNvbnRyYWN0SGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICdyZXNpemVTdGVwc18nCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nTW90aW9uLnJlc2l6ZURlbGF5cyA9IGNhbGN1bGF0ZURlbGF5cygKICAgICAgICAgICAgICAgICAgICB0aGlzLl9ib3VuY2luZ09wdGlvbnMuY29udHJhY3RIZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYm91bmNpbmdPcHRpb25zLmNvbnRyYWN0U3BlZWQsCiAgICAgICAgICAgICAgICAgICAgJ3Jlc2l6ZURlbGF5c18nCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ2FsY3VsYXRlZCB0aGUgdHJhbnNmb3JtYXRpb25zIG9mIHRoaXMgbWFya2VyLgogICAgICAgICAqLwogICAgICAgIF9jYWxjdWxhdGVUcmFuc2Zvcm1zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKEwuQnJvd3Nlci5hbnkzZCkgewoKICAgICAgICAgICAgICAgIC8qIENhbGN1bGF0ZSB0cmFuc2Zvcm1zIGZvciAzRCBicm93c2VycyAqLwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuaWNvbi5vcHRpb25zLmljb25TaXplKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGljb25IZWlnaHQgPSB0aGlzLm9wdGlvbnMuaWNvbi5vcHRpb25zLmljb25TaXplWzFdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAgICAgLyogVG8gZml4IHRoZSBjYXNlIHdoZW4gaWNvbiBpcyBpbiBfaWNvbk9iaiAqLwogICAgICAgICAgICAgICAgICAgIHZhciBpY29uSGVpZ2h0ID0gdGhpcy5faWNvbk9iai5vcHRpb25zLmljb25TaXplWzFdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8qIENhbGN1bGF0ZSBtb3ZlIHRyYW5zZm9ybXMgb2YgaWNvbiAqLwogICAgICAgICAgICAgICAgdGhpcy5fYm91bmNpbmdNb3Rpb24uaWNvbk1vdmVUcmFuc2Zvcm1zID0KICAgICAgICAgICAgICAgICAgICBjYWxjdWxhdGVJY29uTW92ZVRyYW5zZm9ybXMoCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nTW90aW9uLngsCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nTW90aW9uLnksCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nT3B0aW9ucy5ib3VuY2VIZWlnaHQKICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIC8qIENhbGN1bGF0ZSByZXNpemUgdHJhbnNmb3JtcyBvZiBpY29uICovCiAgICAgICAgICAgICAgICB0aGlzLl9ib3VuY2luZ01vdGlvbi5pY29uUmVzaXplVHJhbnNmb3JtcyA9CiAgICAgICAgICAgICAgICAgICAgY2FsY3VsYXRlSWNvblJlc2l6ZVRyYW5zZm9ybXMoCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nTW90aW9uLngsCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nTW90aW9uLnksCiAgICAgICAgICAgICAgICAgICAgICAgIGljb25IZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nT3B0aW9ucy5jb250cmFjdEhlaWdodAogICAgICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3NoYWRvdykgewoKICAgICAgICAgICAgICAgICAgICAvKiBDYWxjdWxhdGUgbW92ZSB0cmFuc2Zvcm1hdGlvbnMgb2Ygc2hhZG93ICovCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYm91bmNpbmdNb3Rpb24uc2hhZG93TW92ZVRyYW5zZm9ybXMgPQogICAgICAgICAgICAgICAgICAgICAgICBjYWxjdWxhdGVTaGFkb3dNb3ZlVHJhbnNmb3JtcygKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nTW90aW9uLngsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9ib3VuY2luZ01vdGlvbi55LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYm91bmNpbmdPcHRpb25zLmJvdW5jZUhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nT3B0aW9ucy5zaGFkb3dBbmdsZQogICAgICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgICAgICAvKiBDYWxjdWxhdGUgcmVzaXplIHRyYW5zZm9ybXMgb2Ygc2hhZG93ICovCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogdXNlIGZ1bmN0aW9uIGNhbGN1bGF0ZVNoYWRvd1Jlc2l6ZVRyYW5zZm9ybXMKICAgICAgICAgICAgICAgICAgICB0aGlzLl9ib3VuY2luZ01vdGlvbi5zaGFkb3dSZXNpemVUcmFuc2Zvcm1zID0KICAgICAgICAgICAgICAgICAgICAgICAgY2FsY3VsYXRlSWNvblJlc2l6ZVRyYW5zZm9ybXMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9ib3VuY2luZ01vdGlvbi54LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYm91bmNpbmdNb3Rpb24ueSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5pY29uLm9wdGlvbnMuc2hhZG93U2l6ZVsxXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nT3B0aW9ucy5jb250cmFjdEhlaWdodAogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAvKiBDYWxjdWxhdGUgbW92ZSBwb2ludHMgKi8KCiAgICAgICAgICAgICAgICAvKiBGb3IgdGhlIGljb24gKi8KICAgICAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nTW90aW9uLmljb25Nb3ZlUG9pbnRzID0KICAgICAgICAgICAgICAgICAgICBjYWxjdWxhdGVJY29uTW92ZVBvaW50cygKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYm91bmNpbmdNb3Rpb24ueCwKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYm91bmNpbmdNb3Rpb24ueSwKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYm91bmNpbmdPcHRpb25zLmJvdW5jZUhlaWdodAogICAgICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgLyogQW5kIGZvciB0aGUgc2hhZG93ICovCiAgICAgICAgICAgICAgICB0aGlzLl9ib3VuY2luZ01vdGlvbi5zaGFkb3dNb3ZlUG9pbnRzID0KICAgICAgICAgICAgICAgICAgICBjYWxjdWxhdGVTaGFkb3dNb3ZlUG9pbnRzKAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9ib3VuY2luZ01vdGlvbi54LAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9ib3VuY2luZ01vdGlvbi55LAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9ib3VuY2luZ09wdGlvbnMuYm91bmNlSGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9ib3VuY2luZ09wdGlvbnMuc2hhZG93QW5nbGUKICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9KTsKCiAgICAvKioKICAgICAqIEFkZCBpbml0IGhvb2sgdG8gY2FsY3VsYXRlIGFuaW1hdGlvbiB0aW1lbGluZS4KICAgICAqLwogICAgTC5NYXJrZXIuYWRkSW5pdEhvb2soZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5fYm91bmNpbmdNb3Rpb24gPSB7CiAgICAgICAgICAgIGlzQm91bmNpbmc6IGZhbHNlLAogICAgICAgICAgICBib3VuY2luZ0FuaW1hdGlvblBsYXlpbmc6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICB0aGlzLl9jYWxjdWxhdGVUaW1lbGluZSgpOwogICAgfSk7CgogICAgLy8gVE9ETzogZGVjaWRlIHRvIHJlZGVjbGFyZSBldGhlciBvbmx5IHB1YmxpYyBvciBvbmx5IHByaXZhdGUgbWV0aG9kcwogICAgdmFyIG9sZFNldFBvcyA9IEwuTWFya2VyLnByb3RvdHlwZS5fc2V0UG9zOwogICAgdmFyIG9sZE9uQWRkID0gTC5NYXJrZXIucHJvdG90eXBlLm9uQWRkOwogICAgdmFyIG9sZFNldEljb24gPSBMLk1hcmtlci5wcm90b3R5cGUuc2V0SWNvbjsKICAgIHZhciBvbGRPbiA9IEwuTWFya2VyLnByb3RvdHlwZS5fb247CgogICAgLyoqCiAgICAgKiBSZWRlY2xhcmF0aW9uIG9mIF9zZXRQb3MgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHBhcmFtIHBvcyAgICBwb3NpdGlvbiBvYmplY3QKICAgICAqLwogICAgTC5NYXJrZXIucHJvdG90eXBlLl9zZXRQb3MgPSBmdW5jdGlvbihwb3MpIHsKICAgICAgICBvbGRTZXRQb3MuY2FsbCh0aGlzLCBwb3MpOwogICAgICAgIHRoaXMuX2JvdW5jaW5nTW90aW9uLnggPSBwb3MueDsKICAgICAgICB0aGlzLl9ib3VuY2luZ01vdGlvbi55ID0gcG9zLnk7CiAgICAgICAgdGhpcy5fY2FsY3VsYXRlVHJhbnNmb3JtcygpOwogICAgfTsKCiAgICAvKioKICAgICAqIFJlZGVjbGFyYXRpb24gb2Ygb25BZGQgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHBhcmFtIG1hcCAgICBtYXAgb2JqZWN0CiAgICAgKi8KICAgIEwuTWFya2VyLnByb3RvdHlwZS5vbkFkZCA9IGZ1bmN0aW9uKG1hcCkgewogICAgICAgIG9sZE9uQWRkLmNhbGwodGhpcywgbWFwKTsKCiAgICAgICAgLyogQ3JlYXRlIGJhc2UgY3NzVGV4dCAqLwogICAgICAgIHZhciBzdHlsZXMgPSBwYXJzZUNzc1RleHQodGhpcy5faWNvbi5zdHlsZS5jc3NUZXh0KTsKICAgICAgICBkZWxldGUgc3R5bGVzW3RyYW5zZm9ybV07ICAgIC8vIGRlbGV0ZSBvbGQgdHJhc2Zvcm0gc3R5bGUgZGVmaW5pdGlvbgogICAgICAgIGRlbGV0ZSBzdHlsZXNbJ3otaW5kZXgnXTsgICAgLy8gZGVsZXRlIG9sZCB6LWluZGV4CgogICAgICAgIC8qIFJlc3RvcmVzIG9wYWNpdHkgd2hlbiBtYXJrZXIgKHJlKWFkZGVkIDoKICAgICAgICAgKiAxKSBjaGVja3Mgb3BhY2l0eVdoZW5VbmNsdXN0ZXJlZCBvcHRpb24gdXNlZCBieSBjbHVzdGVyIHBsdWdpbgogICAgICAgICAqIDIpIGNoZWNrcyBvcGFjaXR5IG9wdGlvbgogICAgICAgICAqIDMpIGFzc3VtZXMgb3BhY2l0eSBpcyAxICovCiAgICAgICAgc3R5bGVzLm9wYWNpdHkgPSB0aGlzLm9wdGlvbnMub3BhY2l0eVdoZW5VbmNsdXN0ZXJlZAogICAgICAgICAgICB8fCB0aGlzLm9wdGlvbnMub3BhY2l0eQogICAgICAgICAgICB8fCAxOwoKICAgICAgICB0aGlzLl9ib3VuY2luZ01vdGlvbi5iYXNlSWNvbkNzc1RleHQgPSByZW5kZXJDc3NUZXh0KHN0eWxlcyk7CgogICAgICAgIC8qIENyZWF0ZSBiYXNlIGNzc1RleHQgZm9yIHNoYWRvdyAqLwogICAgICAgIGlmICh0aGlzLl9zaGFkb3cpIHsKICAgICAgICAgICAgc3R5bGVzID0gcGFyc2VDc3NUZXh0KHRoaXMuX3NoYWRvdy5zdHlsZS5jc3NUZXh0KTsKICAgICAgICAgICAgZGVsZXRlIHN0eWxlc1t0cmFuc2Zvcm1dOyAgICAvLyBkZWxldGUgb2xkIHRyYXNmb3JtIHN0eWxlIGRlZmluaXRpb24KICAgICAgICAgICAgZGVsZXRlIHN0eWxlc1snb3BhY2l0eSddOwogICAgICAgICAgICB0aGlzLl9ib3VuY2luZ01vdGlvbi5iYXNlU2hhZG93Q3NzVGV4dCA9IHJlbmRlckNzc1RleHQoc3R5bGVzKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2JvdW5jaW5nTW90aW9uLmJvdW5jaW5nQW5pbWF0aW9uUGxheWluZyA9IGZhbHNlOwogICAgICAgIGlmICh0aGlzLl9ib3VuY2luZ01vdGlvbi5pc0JvdW5jaW5nKSB7CiAgICAgICAgICAgIHRoaXMuYm91bmNlKCk7CiAgICAgICAgfQogICAgfTsKCiAgICBMLk1hcmtlci5wcm90b3R5cGUuc2V0SWNvbiA9IGZ1bmN0aW9uKGljb24pIHsKICAgICAgICBvbGRTZXRJY29uLmNhbGwodGhpcywgaWNvbik7CgogICAgICAgIHZhciBzdHlsZXMgPSB7fTsKCiAgICAgICAgaWYgKHRoaXMuX2ljb24pIHsKCiAgICAgICAgICAgIC8qIENyZWF0ZSBiYXNlIGNzc1RleHQgKi8KICAgICAgICAgICAgc3R5bGVzID0gcGFyc2VDc3NUZXh0KHRoaXMuX2ljb24uc3R5bGUuY3NzVGV4dCk7CiAgICAgICAgICAgIGRlbGV0ZSBzdHlsZXNbdHJhbnNmb3JtXTsgICAgLy8gZGVsZXRlIG9sZCB0cmFzZm9ybSBzdHlsZSBkZWZpbml0aW9uCiAgICAgICAgICAgIGRlbGV0ZSBzdHlsZXNbJ3otaW5kZXgnXTsgICAgLy8gZGVsZXRlIG9sZCB6LWluZGV4CgogICAgICAgICAgICAvKiBSZXN0b3JlcyBvcGFjaXR5IHdoZW4gbWFya2VyIChyZSlhZGRlZCA6CiAgICAgICAgICAgICAqIDEpIGNoZWNrcyBvcGFjaXR5V2hlblVuY2x1c3RlcmVkIG9wdGlvbiB1c2VkIGJ5IGNsdXN0ZXIgcGx1Z2luCiAgICAgICAgICAgICAqIDIpIGNoZWNrcyBvcGFjaXR5IG9wdGlvbgogICAgICAgICAgICAgKiAzKSBhc3N1bWVzIG9wYWNpdHkgaXMgMSAqLwogICAgICAgICAgICBzdHlsZXMub3BhY2l0eSA9IHRoaXMub3B0aW9ucy5vcGFjaXR5V2hlblVuY2x1c3RlcmVkCiAgICAgICAgICAgICAgICB8fCB0aGlzLm9wdGlvbnMub3BhY2l0eQogICAgICAgICAgICAgICAgfHwgMTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2JvdW5jaW5nTW90aW9uLmJhc2VJY29uQ3NzVGV4dCA9IHJlbmRlckNzc1RleHQoc3R5bGVzKTsKCiAgICAgICAgaWYgKHRoaXMuX3NoYWRvdykgewogICAgICAgICAgICBzdHlsZXMgPSBwYXJzZUNzc1RleHQodGhpcy5fc2hhZG93LnN0eWxlLmNzc1RleHQpOwogICAgICAgICAgICBkZWxldGUgc3R5bGVzW3RyYW5zZm9ybV07ICAgIC8vIGRlbGV0ZSBvbGQgdHJhc2Zvcm0gc3R5bGUgZGVmaW5pdGlvbgogICAgICAgICAgICBkZWxldGUgc3R5bGVzWydvcGFjaXR5J107CiAgICAgICAgICAgIHRoaXMuX2JvdW5jaW5nTW90aW9uLmJhc2VTaGFkb3dDc3NUZXh0ID0gcmVuZGVyQ3NzVGV4dChzdHlsZXMpOwogICAgICAgIH0KICAgIH07CgogICAgTC5NYXJrZXIucHJvdG90eXBlLl9vbiA9IGZ1bmN0aW9uICh0eXBlLCBmbiwgY29udGV4dCkgewogICAgICAgIHZhciBuZXdGbiA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2NsaWNrJykgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ibHVyKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZuLmNhbGwodGhpcywgZXZlbnQpOwogICAgICAgIH07CgogICAgICAgIG9sZE9uLmNhbGwodGhpcywgdHlwZSwgbmV3Rm4sIGNvbnRleHQpOwogICAgfTsKCn0sIHdpbmRvdykpOwo=