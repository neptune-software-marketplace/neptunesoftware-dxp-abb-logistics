data:application/x-javascript;base64,LyoKICogTGVhZmxldC5tYXJrZXJjbHVzdGVyIDEuNC4xK21hc3Rlci4zN2FiOWEyLAogKiBQcm92aWRlcyBCZWF1dGlmdWwgQW5pbWF0ZWQgTWFya2VyIENsdXN0ZXJpbmcgZnVuY3Rpb25hbGl0eSBmb3IgTGVhZmxldCwgYSBKUyBsaWJyYXJ5IGZvciBpbnRlcmFjdGl2ZSBtYXBzLgogKiBodHRwczovL2dpdGh1Yi5jb20vTGVhZmxldC9MZWFmbGV0Lm1hcmtlcmNsdXN0ZXIKICogKGMpIDIwMTItMjAxNywgRGF2ZSBMZWF2ZXIsIHNtYXJ0cmFrCiAqLwooZnVuY3Rpb24gKGdsb2JhbCwgZmFjdG9yeSkgewoJdHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnID8gZmFjdG9yeShleHBvcnRzKSA6Cgl0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgPyBkZWZpbmUoWydleHBvcnRzJ10sIGZhY3RvcnkpIDoKCShmYWN0b3J5KChnbG9iYWwuTGVhZmxldCA9IGdsb2JhbC5MZWFmbGV0IHx8IHt9LCBnbG9iYWwuTGVhZmxldC5tYXJrZXJjbHVzdGVyID0gZ2xvYmFsLkxlYWZsZXQubWFya2VyY2x1c3RlciB8fCB7fSkpKTsKfSh0aGlzLCAoZnVuY3Rpb24gKGV4cG9ydHMpIHsgJ3VzZSBzdHJpY3QnOwoKLyoKICogTC5NYXJrZXJDbHVzdGVyR3JvdXAgZXh0ZW5kcyBMLkZlYXR1cmVHcm91cCBieSBjbHVzdGVyaW5nIHRoZSBtYXJrZXJzIGNvbnRhaW5lZCB3aXRoaW4KICovCgp2YXIgTWFya2VyQ2x1c3Rlckdyb3VwID0gTC5NYXJrZXJDbHVzdGVyR3JvdXAgPSBMLkZlYXR1cmVHcm91cC5leHRlbmQoewoKCW9wdGlvbnM6IHsKCQltYXhDbHVzdGVyUmFkaXVzOiA4MCwgLy9BIGNsdXN0ZXIgd2lsbCBjb3ZlciBhdCBtb3N0IHRoaXMgbWFueSBwaXhlbHMgZnJvbSBpdHMgY2VudGVyCgkJaWNvbkNyZWF0ZUZ1bmN0aW9uOiBudWxsLAoJCWNsdXN0ZXJQYW5lOiBMLk1hcmtlci5wcm90b3R5cGUub3B0aW9ucy5wYW5lLAoKCQlzcGlkZXJmeU9uTWF4Wm9vbTogdHJ1ZSwKCQlzaG93Q292ZXJhZ2VPbkhvdmVyOiB0cnVlLAoJCXpvb21Ub0JvdW5kc09uQ2xpY2s6IHRydWUsCgkJc2luZ2xlTWFya2VyTW9kZTogZmFsc2UsCgoJCWRpc2FibGVDbHVzdGVyaW5nQXRab29tOiBudWxsLAoKCQkvLyBTZXR0aW5nIHRoaXMgdG8gZmFsc2UgcHJldmVudHMgdGhlIHJlbW92YWwgb2YgYW55IGNsdXN0ZXJzIG91dHNpZGUgb2YgdGhlIHZpZXdwb2ludCwgd2hpY2gKCQkvLyBpcyB0aGUgZGVmYXVsdCBiZWhhdmlvdXIgZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMuCgkJcmVtb3ZlT3V0c2lkZVZpc2libGVCb3VuZHM6IHRydWUsCgoJCS8vIFNldCB0byBmYWxzZSB0byBkaXNhYmxlIGFsbCBhbmltYXRpb25zICh6b29tIGFuZCBzcGlkZXJmeSkuCgkJLy8gSWYgZmFsc2UsIG9wdGlvbiBhbmltYXRlQWRkaW5nTWFya2VycyBiZWxvdyBoYXMgbm8gZWZmZWN0LgoJCS8vIElmIEwuRG9tVXRpbC5UUkFOU0lUSU9OIGlzIGZhbHN5LCB0aGlzIG9wdGlvbiBoYXMgbm8gZWZmZWN0LgoJCWFuaW1hdGU6IHRydWUsCgoJCS8vV2hldGhlciB0byBhbmltYXRlIGFkZGluZyBtYXJrZXJzIGFmdGVyIGFkZGluZyB0aGUgTWFya2VyQ2x1c3Rlckdyb3VwIHRvIHRoZSBtYXAKCQkvLyBJZiB5b3UgYXJlIGFkZGluZyBpbmRpdmlkdWFsIG1hcmtlcnMgc2V0IHRvIHRydWUsIGlmIGFkZGluZyBidWxrIG1hcmtlcnMgbGVhdmUgZmFsc2UgZm9yIG1hc3NpdmUgcGVyZm9ybWFuY2UgZ2FpbnMuCgkJYW5pbWF0ZUFkZGluZ01hcmtlcnM6IGZhbHNlLAoKCQkvL0luY3JlYXNlIHRvIGluY3JlYXNlIHRoZSBkaXN0YW5jZSBhd2F5IHRoYXQgc3BpZGVyZmllZCBtYXJrZXJzIGFwcGVhciBmcm9tIHRoZSBjZW50ZXIKCQlzcGlkZXJmeURpc3RhbmNlTXVsdGlwbGllcjogMSwKCgkJLy8gTWFrZSBpdCBwb3NzaWJsZSB0byBzcGVjaWZ5IGEgcG9seWxpbmUgb3B0aW9ucyBvbiBhIHNwaWRlciBsZWcKCQlzcGlkZXJMZWdQb2x5bGluZU9wdGlvbnM6IHsgd2VpZ2h0OiAxLjUsIGNvbG9yOiAnIzIyMicsIG9wYWNpdHk6IDAuNSB9LAoKCQkvLyBXaGVuIGJ1bGsgYWRkaW5nIGxheWVycywgYWRkcyBtYXJrZXJzIGluIGNodW5rcy4gTWVhbnMgYWRkTGF5ZXJzIG1heSBub3QgYWRkIGFsbCB0aGUgbGF5ZXJzIGluIHRoZSBjYWxsLCBvdGhlcnMgd2lsbCBiZSBsb2FkZWQgZHVyaW5nIHNldFRpbWVvdXRzCgkJY2h1bmtlZExvYWRpbmc6IGZhbHNlLAoJCWNodW5rSW50ZXJ2YWw6IDIwMCwgLy8gcHJvY2VzcyBtYXJrZXJzIGZvciBhIG1heGltdW0gb2YgfiBuIG1pbGxpc2Vjb25kcyAodGhlbiB0cmlnZ2VyIHRoZSBjaHVua1Byb2dyZXNzIGNhbGxiYWNrKQoJCWNodW5rRGVsYXk6IDUwLCAvLyBhdCB0aGUgZW5kIG9mIGVhY2ggaW50ZXJ2YWwsIGdpdmUgbiBtaWxsaXNlY29uZHMgYmFjayB0byBzeXN0ZW0vYnJvd3NlcgoJCWNodW5rUHJvZ3Jlc3M6IG51bGwsIC8vIHByb2dyZXNzIGNhbGxiYWNrOiBmdW5jdGlvbihwcm9jZXNzZWQsIHRvdGFsLCBlbGFwc2VkKSAoZS5nLiBmb3IgYSBwcm9ncmVzcyBpbmRpY2F0b3IpCgoJCS8vT3B0aW9ucyB0byBwYXNzIHRvIHRoZSBMLlBvbHlnb24gY29uc3RydWN0b3IKCQlwb2x5Z29uT3B0aW9uczoge30KCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24gKG9wdGlvbnMpIHsKCQlMLlV0aWwuc2V0T3B0aW9ucyh0aGlzLCBvcHRpb25zKTsKCQlpZiAoIXRoaXMub3B0aW9ucy5pY29uQ3JlYXRlRnVuY3Rpb24pIHsKCQkJdGhpcy5vcHRpb25zLmljb25DcmVhdGVGdW5jdGlvbiA9IHRoaXMuX2RlZmF1bHRJY29uQ3JlYXRlRnVuY3Rpb247CgkJfQoKCQl0aGlzLl9mZWF0dXJlR3JvdXAgPSBMLmZlYXR1cmVHcm91cCgpOwoJCXRoaXMuX2ZlYXR1cmVHcm91cC5hZGRFdmVudFBhcmVudCh0aGlzKTsKCgkJdGhpcy5fbm9uUG9pbnRHcm91cCA9IEwuZmVhdHVyZUdyb3VwKCk7CgkJdGhpcy5fbm9uUG9pbnRHcm91cC5hZGRFdmVudFBhcmVudCh0aGlzKTsKCgkJdGhpcy5faW5ab29tQW5pbWF0aW9uID0gMDsKCQl0aGlzLl9uZWVkc0NsdXN0ZXJpbmcgPSBbXTsKCQl0aGlzLl9uZWVkc1JlbW92aW5nID0gW107IC8vTWFya2VycyByZW1vdmVkIHdoaWxlIHdlIGFyZW4ndCBvbiB0aGUgbWFwIG5lZWQgdG8gYmUga2VwdCB0cmFjayBvZgoJCS8vVGhlIGJvdW5kcyBvZiB0aGUgY3VycmVudGx5IHNob3duIGFyZWEgKGZyb20gX2dldEV4cGFuZGVkVmlzaWJsZUJvdW5kcykgVXBkYXRlZCBvbiB6b29tL21vdmUKCQl0aGlzLl9jdXJyZW50U2hvd25Cb3VuZHMgPSBudWxsOwoKCQl0aGlzLl9xdWV1ZSA9IFtdOwoKCQl0aGlzLl9jaGlsZE1hcmtlckV2ZW50SGFuZGxlcnMgPSB7CgkJCSdkcmFnc3RhcnQnOiB0aGlzLl9jaGlsZE1hcmtlckRyYWdTdGFydCwKCQkJJ21vdmUnOiB0aGlzLl9jaGlsZE1hcmtlck1vdmVkLAoJCQknZHJhZ2VuZCc6IHRoaXMuX2NoaWxkTWFya2VyRHJhZ0VuZCwKCQl9OwoKCQkvLyBIb29rIHRoZSBhcHByb3ByaWF0ZSBhbmltYXRpb24gbWV0aG9kcy4KCQl2YXIgYW5pbWF0ZSA9IEwuRG9tVXRpbC5UUkFOU0lUSU9OICYmIHRoaXMub3B0aW9ucy5hbmltYXRlOwoJCUwuZXh0ZW5kKHRoaXMsIGFuaW1hdGUgPyB0aGlzLl93aXRoQW5pbWF0aW9uIDogdGhpcy5fbm9BbmltYXRpb24pOwoJCS8vIFJlbWVtYmVyIHdoaWNoIE1hcmtlckNsdXN0ZXIgY2xhc3MgdG8gaW5zdGFudGlhdGUgKGFuaW1hdGVkIG9yIG5vdCkuCgkJdGhpcy5fbWFya2VyQ2x1c3RlciA9IGFuaW1hdGUgPyBMLk1hcmtlckNsdXN0ZXIgOiBMLk1hcmtlckNsdXN0ZXJOb25BbmltYXRlZDsKCX0sCgoJYWRkTGF5ZXI6IGZ1bmN0aW9uIChsYXllcikgewoKCQlpZiAobGF5ZXIgaW5zdGFuY2VvZiBMLkxheWVyR3JvdXApIHsKCQkJcmV0dXJuIHRoaXMuYWRkTGF5ZXJzKFtsYXllcl0pOwoJCX0KCgkJLy9Eb24ndCBjbHVzdGVyIG5vbiBwb2ludCBkYXRhCgkJaWYgKCFsYXllci5nZXRMYXRMbmcpIHsKCQkJdGhpcy5fbm9uUG9pbnRHcm91cC5hZGRMYXllcihsYXllcik7CgkJCXRoaXMuZmlyZSgnbGF5ZXJhZGQnLCB7IGxheWVyOiBsYXllciB9KTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoIXRoaXMuX21hcCkgewoJCQl0aGlzLl9uZWVkc0NsdXN0ZXJpbmcucHVzaChsYXllcik7CgkJCXRoaXMuZmlyZSgnbGF5ZXJhZGQnLCB7IGxheWVyOiBsYXllciB9KTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAodGhpcy5oYXNMYXllcihsYXllcikpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCgkJLy9JZiB3ZSBoYXZlIGFscmVhZHkgY2x1c3RlcmVkIHdlJ2xsIG5lZWQgdG8gYWRkIHRoaXMgb25lIHRvIGEgY2x1c3RlcgoKCQlpZiAodGhpcy5fdW5zcGlkZXJmeSkgewoJCQl0aGlzLl91bnNwaWRlcmZ5KCk7CgkJfQoKCQl0aGlzLl9hZGRMYXllcihsYXllciwgdGhpcy5fbWF4Wm9vbSk7CgkJdGhpcy5maXJlKCdsYXllcmFkZCcsIHsgbGF5ZXI6IGxheWVyIH0pOwoKCQkvLyBSZWZyZXNoIGJvdW5kcyBhbmQgd2VpZ2h0ZWQgcG9zaXRpb25zLgoJCXRoaXMuX3RvcENsdXN0ZXJMZXZlbC5fcmVjYWxjdWxhdGVCb3VuZHMoKTsKCgkJdGhpcy5fcmVmcmVzaENsdXN0ZXJzSWNvbnMoKTsKCgkJLy9Xb3JrIG91dCB3aGF0IGlzIHZpc2libGUKCQl2YXIgdmlzaWJsZUxheWVyID0gbGF5ZXIsCgkJICAgIGN1cnJlbnRab29tID0gdGhpcy5fem9vbTsKCQlpZiAobGF5ZXIuX19wYXJlbnQpIHsKCQkJd2hpbGUgKHZpc2libGVMYXllci5fX3BhcmVudC5fem9vbSA+PSBjdXJyZW50Wm9vbSkgewoJCQkJdmlzaWJsZUxheWVyID0gdmlzaWJsZUxheWVyLl9fcGFyZW50OwoJCQl9CgkJfQoKCQlpZiAodGhpcy5fY3VycmVudFNob3duQm91bmRzLmNvbnRhaW5zKHZpc2libGVMYXllci5nZXRMYXRMbmcoKSkpIHsKCQkJaWYgKHRoaXMub3B0aW9ucy5hbmltYXRlQWRkaW5nTWFya2VycykgewoJCQkJdGhpcy5fYW5pbWF0aW9uQWRkTGF5ZXIobGF5ZXIsIHZpc2libGVMYXllcik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9hbmltYXRpb25BZGRMYXllck5vbkFuaW1hdGVkKGxheWVyLCB2aXNpYmxlTGF5ZXIpOwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVMYXllcjogZnVuY3Rpb24gKGxheWVyKSB7CgoJCWlmIChsYXllciBpbnN0YW5jZW9mIEwuTGF5ZXJHcm91cCkgewoJCQlyZXR1cm4gdGhpcy5yZW1vdmVMYXllcnMoW2xheWVyXSk7CgkJfQoKCQkvL05vbiBwb2ludCBsYXllcnMKCQlpZiAoIWxheWVyLmdldExhdExuZykgewoJCQl0aGlzLl9ub25Qb2ludEdyb3VwLnJlbW92ZUxheWVyKGxheWVyKTsKCQkJdGhpcy5maXJlKCdsYXllcnJlbW92ZScsIHsgbGF5ZXI6IGxheWVyIH0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmICghdGhpcy5fbWFwKSB7CgkJCWlmICghdGhpcy5fYXJyYXlTcGxpY2UodGhpcy5fbmVlZHNDbHVzdGVyaW5nLCBsYXllcikgJiYgdGhpcy5oYXNMYXllcihsYXllcikpIHsKCQkJCXRoaXMuX25lZWRzUmVtb3ZpbmcucHVzaCh7IGxheWVyOiBsYXllciwgbGF0bG5nOiBsYXllci5fbGF0bG5nIH0pOwoJCQl9CgkJCXRoaXMuZmlyZSgnbGF5ZXJyZW1vdmUnLCB7IGxheWVyOiBsYXllciB9KTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoIWxheWVyLl9fcGFyZW50KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKHRoaXMuX3Vuc3BpZGVyZnkpIHsKCQkJdGhpcy5fdW5zcGlkZXJmeSgpOwoJCQl0aGlzLl91bnNwaWRlcmZ5TGF5ZXIobGF5ZXIpOwoJCX0KCgkJLy9SZW1vdmUgdGhlIG1hcmtlciBmcm9tIGNsdXN0ZXJzCgkJdGhpcy5fcmVtb3ZlTGF5ZXIobGF5ZXIsIHRydWUpOwoJCXRoaXMuZmlyZSgnbGF5ZXJyZW1vdmUnLCB7IGxheWVyOiBsYXllciB9KTsKCgkJLy8gUmVmcmVzaCBib3VuZHMgYW5kIHdlaWdodGVkIHBvc2l0aW9ucy4KCQl0aGlzLl90b3BDbHVzdGVyTGV2ZWwuX3JlY2FsY3VsYXRlQm91bmRzKCk7CgoJCXRoaXMuX3JlZnJlc2hDbHVzdGVyc0ljb25zKCk7CgoJCWxheWVyLm9mZih0aGlzLl9jaGlsZE1hcmtlckV2ZW50SGFuZGxlcnMsIHRoaXMpOwoKCQlpZiAodGhpcy5fZmVhdHVyZUdyb3VwLmhhc0xheWVyKGxheWVyKSkgewoJCQl0aGlzLl9mZWF0dXJlR3JvdXAucmVtb3ZlTGF5ZXIobGF5ZXIpOwoJCQlpZiAobGF5ZXIuY2x1c3RlclNob3cpIHsKCQkJCWxheWVyLmNsdXN0ZXJTaG93KCk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgkvL1Rha2VzIGFuIGFycmF5IG9mIG1hcmtlcnMgYW5kIGFkZHMgdGhlbSBpbiBidWxrCglhZGRMYXllcnM6IGZ1bmN0aW9uIChsYXllcnNBcnJheSwgc2tpcExheWVyQWRkRXZlbnQpIHsKCQlpZiAoIUwuVXRpbC5pc0FycmF5KGxheWVyc0FycmF5KSkgewoJCQlyZXR1cm4gdGhpcy5hZGRMYXllcihsYXllcnNBcnJheSk7CgkJfQoKCQl2YXIgZmcgPSB0aGlzLl9mZWF0dXJlR3JvdXAsCgkJICAgIG5wZyA9IHRoaXMuX25vblBvaW50R3JvdXAsCgkJICAgIGNodW5rZWQgPSB0aGlzLm9wdGlvbnMuY2h1bmtlZExvYWRpbmcsCgkJICAgIGNodW5rSW50ZXJ2YWwgPSB0aGlzLm9wdGlvbnMuY2h1bmtJbnRlcnZhbCwKCQkgICAgY2h1bmtQcm9ncmVzcyA9IHRoaXMub3B0aW9ucy5jaHVua1Byb2dyZXNzLAoJCSAgICBsID0gbGF5ZXJzQXJyYXkubGVuZ3RoLAoJCSAgICBvZmZzZXQgPSAwLAoJCSAgICBvcmlnaW5hbEFycmF5ID0gdHJ1ZSwKCQkgICAgbTsKCgkJaWYgKHRoaXMuX21hcCkgewoJCQl2YXIgc3RhcnRlZCA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7CgkJCXZhciBwcm9jZXNzID0gTC5iaW5kKGZ1bmN0aW9uICgpIHsKCQkJCXZhciBzdGFydCA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7CgkJCQlmb3IgKDsgb2Zmc2V0IDwgbDsgb2Zmc2V0KyspIHsKCQkJCQlpZiAoY2h1bmtlZCAmJiBvZmZzZXQgJSAyMDAgPT09IDApIHsKCQkJCQkJLy8gZXZlcnkgY291cGxlIGh1bmRyZWQgbWFya2VycywgaW5zdHJ1bWVudCB0aGUgdGltZSBlbGFwc2VkIHNpbmNlIHByb2Nlc3Npbmcgc3RhcnRlZDoKCQkJCQkJdmFyIGVsYXBzZWQgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpIC0gc3RhcnQ7CgkJCQkJCWlmIChlbGFwc2VkID4gY2h1bmtJbnRlcnZhbCkgewoJCQkJCQkJYnJlYWs7IC8vIGJlZW4gd29ya2luZyB0b28gaGFyZCwgdGltZSB0byB0YWtlIGEgYnJlYWsgOi0pCgkJCQkJCX0KCQkJCQl9CgoJCQkJCW0gPSBsYXllcnNBcnJheVtvZmZzZXRdOwoKCQkJCQkvLyBHcm91cCBvZiBsYXllcnMsIGFwcGVuZCBjaGlsZHJlbiB0byBsYXllcnNBcnJheSBhbmQgc2tpcC4KCQkJCQkvLyBTaWRlIGVmZmVjdHM6CgkJCQkJLy8gLSBUb3RhbCBpbmNyZWFzZXMsIHNvIGNodW5rUHJvZ3Jlc3MgcmF0aW8ganVtcHMgYmFja3dhcmQuCgkJCQkJLy8gLSBHcm91cHMgYXJlIG5vdCBpbmNsdWRlZCBpbiB0aGlzIGdyb3VwLCBvbmx5IHRoZWlyIG5vbi1ncm91cCBjaGlsZCBsYXllcnMgKGhhc0xheWVyKS4KCQkJCQkvLyBDaGFuZ2luZyBhcnJheSBsZW5ndGggd2hpbGUgbG9vcGluZyBkb2VzIG5vdCBhZmZlY3QgcGVyZm9ybWFuY2UgaW4gY3VycmVudCBicm93c2VyczoKCQkJCQkvLyBodHRwOi8vanNwZXJmLmNvbS9mb3ItbG9vcC1jaGFuZ2luZy1sZW5ndGgvNgoJCQkJCWlmIChtIGluc3RhbmNlb2YgTC5MYXllckdyb3VwKSB7CgkJCQkJCWlmIChvcmlnaW5hbEFycmF5KSB7CgkJCQkJCQlsYXllcnNBcnJheSA9IGxheWVyc0FycmF5LnNsaWNlKCk7CgkJCQkJCQlvcmlnaW5hbEFycmF5ID0gZmFsc2U7CgkJCQkJCX0KCQkJCQkJdGhpcy5fZXh0cmFjdE5vbkdyb3VwTGF5ZXJzKG0sIGxheWVyc0FycmF5KTsKCQkJCQkJbCA9IGxheWVyc0FycmF5Lmxlbmd0aDsKCQkJCQkJY29udGludWU7CgkJCQkJfQoKCQkJCQkvL05vdCBwb2ludCBkYXRhLCBjYW4ndCBiZSBjbHVzdGVyZWQKCQkJCQlpZiAoIW0uZ2V0TGF0TG5nKSB7CgkJCQkJCW5wZy5hZGRMYXllcihtKTsKCQkJCQkJaWYgKCFza2lwTGF5ZXJBZGRFdmVudCkgewoJCQkJCQkJdGhpcy5maXJlKCdsYXllcmFkZCcsIHsgbGF5ZXI6IG0gfSk7CgkJCQkJCX0KCQkJCQkJY29udGludWU7CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5oYXNMYXllcihtKSkgewoJCQkJCQljb250aW51ZTsKCQkJCQl9CgoJCQkJCXRoaXMuX2FkZExheWVyKG0sIHRoaXMuX21heFpvb20pOwoJCQkJCWlmICghc2tpcExheWVyQWRkRXZlbnQpIHsKCQkJCQkJdGhpcy5maXJlKCdsYXllcmFkZCcsIHsgbGF5ZXI6IG0gfSk7CgkJCQkJfQoKCQkJCQkvL0lmIHdlIGp1c3QgbWFkZSBhIGNsdXN0ZXIgb2Ygc2l6ZSAyIHRoZW4gd2UgbmVlZCB0byByZW1vdmUgdGhlIG90aGVyIG1hcmtlciBmcm9tIHRoZSBtYXAgKGlmIGl0IGlzKSBvciB3ZSBuZXZlciB3aWxsCgkJCQkJaWYgKG0uX19wYXJlbnQpIHsKCQkJCQkJaWYgKG0uX19wYXJlbnQuZ2V0Q2hpbGRDb3VudCgpID09PSAyKSB7CgkJCQkJCQl2YXIgbWFya2VycyA9IG0uX19wYXJlbnQuZ2V0QWxsQ2hpbGRNYXJrZXJzKCksCgkJCQkJCQkgICAgb3RoZXJNYXJrZXIgPSBtYXJrZXJzWzBdID09PSBtID8gbWFya2Vyc1sxXSA6IG1hcmtlcnNbMF07CgkJCQkJCQlmZy5yZW1vdmVMYXllcihvdGhlck1hcmtlcik7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJaWYgKGNodW5rUHJvZ3Jlc3MpIHsKCQkJCQkvLyByZXBvcnQgcHJvZ3Jlc3MgYW5kIHRpbWUgZWxhcHNlZDoKCQkJCQljaHVua1Byb2dyZXNzKG9mZnNldCwgbCwgKG5ldyBEYXRlKCkpLmdldFRpbWUoKSAtIHN0YXJ0ZWQpOwoJCQkJfQoKCQkJCS8vIENvbXBsZXRlZCBwcm9jZXNzaW5nIGFsbCBtYXJrZXJzLgoJCQkJaWYgKG9mZnNldCA9PT0gbCkgewoKCQkJCQkvLyBSZWZyZXNoIGJvdW5kcyBhbmQgd2VpZ2h0ZWQgcG9zaXRpb25zLgoJCQkJCXRoaXMuX3RvcENsdXN0ZXJMZXZlbC5fcmVjYWxjdWxhdGVCb3VuZHMoKTsKCgkJCQkJdGhpcy5fcmVmcmVzaENsdXN0ZXJzSWNvbnMoKTsKCgkJCQkJdGhpcy5fdG9wQ2x1c3RlckxldmVsLl9yZWN1cnNpdmVseUFkZENoaWxkcmVuVG9NYXAobnVsbCwgdGhpcy5fem9vbSwgdGhpcy5fY3VycmVudFNob3duQm91bmRzKTsKCQkJCX0gZWxzZSB7CgkJCQkJc2V0VGltZW91dChwcm9jZXNzLCB0aGlzLm9wdGlvbnMuY2h1bmtEZWxheSk7CgkJCQl9CgkJCX0sIHRoaXMpOwoKCQkJcHJvY2VzcygpOwoJCX0gZWxzZSB7CgkJCXZhciBuZWVkc0NsdXN0ZXJpbmcgPSB0aGlzLl9uZWVkc0NsdXN0ZXJpbmc7CgoJCQlmb3IgKDsgb2Zmc2V0IDwgbDsgb2Zmc2V0KyspIHsKCQkJCW0gPSBsYXllcnNBcnJheVtvZmZzZXRdOwoKCQkJCS8vIEdyb3VwIG9mIGxheWVycywgYXBwZW5kIGNoaWxkcmVuIHRvIGxheWVyc0FycmF5IGFuZCBza2lwLgoJCQkJaWYgKG0gaW5zdGFuY2VvZiBMLkxheWVyR3JvdXApIHsKCQkJCQlpZiAob3JpZ2luYWxBcnJheSkgewoJCQkJCQlsYXllcnNBcnJheSA9IGxheWVyc0FycmF5LnNsaWNlKCk7CgkJCQkJCW9yaWdpbmFsQXJyYXkgPSBmYWxzZTsKCQkJCQl9CgkJCQkJdGhpcy5fZXh0cmFjdE5vbkdyb3VwTGF5ZXJzKG0sIGxheWVyc0FycmF5KTsKCQkJCQlsID0gbGF5ZXJzQXJyYXkubGVuZ3RoOwoJCQkJCWNvbnRpbnVlOwoJCQkJfQoKCQkJCS8vTm90IHBvaW50IGRhdGEsIGNhbid0IGJlIGNsdXN0ZXJlZAoJCQkJaWYgKCFtLmdldExhdExuZykgewoJCQkJCW5wZy5hZGRMYXllcihtKTsKCQkJCQljb250aW51ZTsKCQkJCX0KCgkJCQlpZiAodGhpcy5oYXNMYXllcihtKSkgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoKCQkJCW5lZWRzQ2x1c3RlcmluZy5wdXNoKG0pOwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCgkvL1Rha2VzIGFuIGFycmF5IG9mIG1hcmtlcnMgYW5kIHJlbW92ZXMgdGhlbSBpbiBidWxrCglyZW1vdmVMYXllcnM6IGZ1bmN0aW9uIChsYXllcnNBcnJheSkgewoJCXZhciBpLCBtLAoJCSAgICBsID0gbGF5ZXJzQXJyYXkubGVuZ3RoLAoJCSAgICBmZyA9IHRoaXMuX2ZlYXR1cmVHcm91cCwKCQkgICAgbnBnID0gdGhpcy5fbm9uUG9pbnRHcm91cCwKCQkgICAgb3JpZ2luYWxBcnJheSA9IHRydWU7CgoJCWlmICghdGhpcy5fbWFwKSB7CgkJCWZvciAoaSA9IDA7IGkgPCBsOyBpKyspIHsKCQkJCW0gPSBsYXllcnNBcnJheVtpXTsKCgkJCQkvLyBHcm91cCBvZiBsYXllcnMsIGFwcGVuZCBjaGlsZHJlbiB0byBsYXllcnNBcnJheSBhbmQgc2tpcC4KCQkJCWlmIChtIGluc3RhbmNlb2YgTC5MYXllckdyb3VwKSB7CgkJCQkJaWYgKG9yaWdpbmFsQXJyYXkpIHsKCQkJCQkJbGF5ZXJzQXJyYXkgPSBsYXllcnNBcnJheS5zbGljZSgpOwoJCQkJCQlvcmlnaW5hbEFycmF5ID0gZmFsc2U7CgkJCQkJfQoJCQkJCXRoaXMuX2V4dHJhY3ROb25Hcm91cExheWVycyhtLCBsYXllcnNBcnJheSk7CgkJCQkJbCA9IGxheWVyc0FycmF5Lmxlbmd0aDsKCQkJCQljb250aW51ZTsKCQkJCX0KCgkJCQl0aGlzLl9hcnJheVNwbGljZSh0aGlzLl9uZWVkc0NsdXN0ZXJpbmcsIG0pOwoJCQkJbnBnLnJlbW92ZUxheWVyKG0pOwoJCQkJaWYgKHRoaXMuaGFzTGF5ZXIobSkpIHsKCQkJCQl0aGlzLl9uZWVkc1JlbW92aW5nLnB1c2goeyBsYXllcjogbSwgbGF0bG5nOiBtLl9sYXRsbmcgfSk7CgkJCQl9CgkJCQl0aGlzLmZpcmUoJ2xheWVycmVtb3ZlJywgeyBsYXllcjogbSB9KTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmICh0aGlzLl91bnNwaWRlcmZ5KSB7CgkJCXRoaXMuX3Vuc3BpZGVyZnkoKTsKCgkJCS8vIFdvcmsgb24gYSBjb3B5IG9mIHRoZSBhcnJheSwgc28gdGhhdCBuZXh0IGxvb3AgaXMgbm90IGFmZmVjdGVkLgoJCQl2YXIgbGF5ZXJzQXJyYXkyID0gbGF5ZXJzQXJyYXkuc2xpY2UoKSwKCQkJICAgIGwyID0gbDsKCQkJZm9yIChpID0gMDsgaSA8IGwyOyBpKyspIHsKCQkJCW0gPSBsYXllcnNBcnJheTJbaV07CgoJCQkJLy8gR3JvdXAgb2YgbGF5ZXJzLCBhcHBlbmQgY2hpbGRyZW4gdG8gbGF5ZXJzQXJyYXkgYW5kIHNraXAuCgkJCQlpZiAobSBpbnN0YW5jZW9mIEwuTGF5ZXJHcm91cCkgewoJCQkJCXRoaXMuX2V4dHJhY3ROb25Hcm91cExheWVycyhtLCBsYXllcnNBcnJheTIpOwoJCQkJCWwyID0gbGF5ZXJzQXJyYXkyLmxlbmd0aDsKCQkJCQljb250aW51ZTsKCQkJCX0KCgkJCQl0aGlzLl91bnNwaWRlcmZ5TGF5ZXIobSk7CgkJCX0KCQl9CgoJCWZvciAoaSA9IDA7IGkgPCBsOyBpKyspIHsKCQkJbSA9IGxheWVyc0FycmF5W2ldOwoKCQkJLy8gR3JvdXAgb2YgbGF5ZXJzLCBhcHBlbmQgY2hpbGRyZW4gdG8gbGF5ZXJzQXJyYXkgYW5kIHNraXAuCgkJCWlmIChtIGluc3RhbmNlb2YgTC5MYXllckdyb3VwKSB7CgkJCQlpZiAob3JpZ2luYWxBcnJheSkgewoJCQkJCWxheWVyc0FycmF5ID0gbGF5ZXJzQXJyYXkuc2xpY2UoKTsKCQkJCQlvcmlnaW5hbEFycmF5ID0gZmFsc2U7CgkJCQl9CgkJCQl0aGlzLl9leHRyYWN0Tm9uR3JvdXBMYXllcnMobSwgbGF5ZXJzQXJyYXkpOwoJCQkJbCA9IGxheWVyc0FycmF5Lmxlbmd0aDsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlpZiAoIW0uX19wYXJlbnQpIHsKCQkJCW5wZy5yZW1vdmVMYXllcihtKTsKCQkJCXRoaXMuZmlyZSgnbGF5ZXJyZW1vdmUnLCB7IGxheWVyOiBtIH0pOwoJCQkJY29udGludWU7CgkJCX0KCgkJCXRoaXMuX3JlbW92ZUxheWVyKG0sIHRydWUsIHRydWUpOwoJCQl0aGlzLmZpcmUoJ2xheWVycmVtb3ZlJywgeyBsYXllcjogbSB9KTsKCgkJCWlmIChmZy5oYXNMYXllcihtKSkgewoJCQkJZmcucmVtb3ZlTGF5ZXIobSk7CgkJCQlpZiAobS5jbHVzdGVyU2hvdykgewoJCQkJCW0uY2x1c3RlclNob3coKTsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gUmVmcmVzaCBib3VuZHMgYW5kIHdlaWdodGVkIHBvc2l0aW9ucy4KCQl0aGlzLl90b3BDbHVzdGVyTGV2ZWwuX3JlY2FsY3VsYXRlQm91bmRzKCk7CgoJCXRoaXMuX3JlZnJlc2hDbHVzdGVyc0ljb25zKCk7CgoJCS8vRml4IHVwIHRoZSBjbHVzdGVycyBhbmQgbWFya2VycyBvbiB0aGUgbWFwCgkJdGhpcy5fdG9wQ2x1c3RlckxldmVsLl9yZWN1cnNpdmVseUFkZENoaWxkcmVuVG9NYXAobnVsbCwgdGhpcy5fem9vbSwgdGhpcy5fY3VycmVudFNob3duQm91bmRzKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8vUmVtb3ZlcyBhbGwgbGF5ZXJzIGZyb20gdGhlIE1hcmtlckNsdXN0ZXJHcm91cAoJY2xlYXJMYXllcnM6IGZ1bmN0aW9uICgpIHsKCQkvL05lZWQgb3VyIG93biBzcGVjaWFsIGltcGxlbWVudGF0aW9uIGFzIHRoZSBMYXllckdyb3VwIG9uZSBkb2Vzbid0IHdvcmsgZm9yIHVzCgoJCS8vSWYgd2UgYXJlbid0IG9uIHRoZSBtYXAgKHlldCksIGJsb3cgYXdheSB0aGUgbWFya2VycyB3ZSBrbm93IG9mCgkJaWYgKCF0aGlzLl9tYXApIHsKCQkJdGhpcy5fbmVlZHNDbHVzdGVyaW5nID0gW107CgkJCXRoaXMuX25lZWRzUmVtb3ZpbmcgPSBbXTsKCQkJZGVsZXRlIHRoaXMuX2dyaWRDbHVzdGVyczsKCQkJZGVsZXRlIHRoaXMuX2dyaWRVbmNsdXN0ZXJlZDsKCQl9CgoJCWlmICh0aGlzLl9ub2FuaW1hdGlvblVuc3BpZGVyZnkpIHsKCQkJdGhpcy5fbm9hbmltYXRpb25VbnNwaWRlcmZ5KCk7CgkJfQoKCQkvL1JlbW92ZSBhbGwgdGhlIHZpc2libGUgbGF5ZXJzCgkJdGhpcy5fZmVhdHVyZUdyb3VwLmNsZWFyTGF5ZXJzKCk7CgkJdGhpcy5fbm9uUG9pbnRHcm91cC5jbGVhckxheWVycygpOwoKCQl0aGlzLmVhY2hMYXllcihmdW5jdGlvbiAobWFya2VyKSB7CgkJCW1hcmtlci5vZmYodGhpcy5fY2hpbGRNYXJrZXJFdmVudEhhbmRsZXJzLCB0aGlzKTsKCQkJZGVsZXRlIG1hcmtlci5fX3BhcmVudDsKCQl9LCB0aGlzKTsKCgkJaWYgKHRoaXMuX21hcCkgewoJCQkvL1Jlc2V0IF90b3BDbHVzdGVyTGV2ZWwgYW5kIHRoZSBEaXN0YW5jZUdyaWRzCgkJCXRoaXMuX2dlbmVyYXRlSW5pdGlhbENsdXN0ZXJzKCk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJLy9PdmVycmlkZSBGZWF0dXJlR3JvdXAuZ2V0Qm91bmRzIGFzIGl0IGRvZXNuJ3Qgd29yawoJZ2V0Qm91bmRzOiBmdW5jdGlvbiAoKSB7CgkJdmFyIGJvdW5kcyA9IG5ldyBMLkxhdExuZ0JvdW5kcygpOwoKCQlpZiAodGhpcy5fdG9wQ2x1c3RlckxldmVsKSB7CgkJCWJvdW5kcy5leHRlbmQodGhpcy5fdG9wQ2x1c3RlckxldmVsLl9ib3VuZHMpOwoJCX0KCgkJZm9yICh2YXIgaSA9IHRoaXMuX25lZWRzQ2x1c3RlcmluZy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewoJCQlib3VuZHMuZXh0ZW5kKHRoaXMuX25lZWRzQ2x1c3RlcmluZ1tpXS5nZXRMYXRMbmcoKSk7CgkJfQoKCQlib3VuZHMuZXh0ZW5kKHRoaXMuX25vblBvaW50R3JvdXAuZ2V0Qm91bmRzKCkpOwoKCQlyZXR1cm4gYm91bmRzOwoJfSwKCgkvL092ZXJyaWRlcyBMYXllckdyb3VwLmVhY2hMYXllcgoJZWFjaExheWVyOiBmdW5jdGlvbiAobWV0aG9kLCBjb250ZXh0KSB7CgkJdmFyIG1hcmtlcnMgPSB0aGlzLl9uZWVkc0NsdXN0ZXJpbmcuc2xpY2UoKSwKCQkJbmVlZHNSZW1vdmluZyA9IHRoaXMuX25lZWRzUmVtb3ZpbmcsCgkJCXRoaXNOZWVkc1JlbW92aW5nLCBpLCBqOwoKCQlpZiAodGhpcy5fdG9wQ2x1c3RlckxldmVsKSB7CgkJCXRoaXMuX3RvcENsdXN0ZXJMZXZlbC5nZXRBbGxDaGlsZE1hcmtlcnMobWFya2Vycyk7CgkJfQoKCQlmb3IgKGkgPSBtYXJrZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCXRoaXNOZWVkc1JlbW92aW5nID0gdHJ1ZTsKCgkJCWZvciAoaiA9IG5lZWRzUmVtb3ZpbmcubGVuZ3RoIC0gMTsgaiA+PSAwOyBqLS0pIHsKCQkJCWlmIChuZWVkc1JlbW92aW5nW2pdLmxheWVyID09PSBtYXJrZXJzW2ldKSB7CgkJCQkJdGhpc05lZWRzUmVtb3ZpbmcgPSBmYWxzZTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoKCQkJaWYgKHRoaXNOZWVkc1JlbW92aW5nKSB7CgkJCQltZXRob2QuY2FsbChjb250ZXh0LCBtYXJrZXJzW2ldKTsKCQkJfQoJCX0KCgkJdGhpcy5fbm9uUG9pbnRHcm91cC5lYWNoTGF5ZXIobWV0aG9kLCBjb250ZXh0KTsKCX0sCgoJLy9PdmVycmlkZXMgTGF5ZXJHcm91cC5nZXRMYXllcnMKCWdldExheWVyczogZnVuY3Rpb24gKCkgewoJCXZhciBsYXllcnMgPSBbXTsKCQl0aGlzLmVhY2hMYXllcihmdW5jdGlvbiAobCkgewoJCQlsYXllcnMucHVzaChsKTsKCQl9KTsKCQlyZXR1cm4gbGF5ZXJzOwoJfSwKCgkvL092ZXJyaWRlcyBMYXllckdyb3VwLmdldExheWVyLCBXQVJOSU5HOiBSZWFsbHkgYmFkIHBlcmZvcm1hbmNlCglnZXRMYXllcjogZnVuY3Rpb24gKGlkKSB7CgkJdmFyIHJlc3VsdCA9IG51bGw7CgoJCWlkID0gcGFyc2VJbnQoaWQsIDEwKTsKCgkJdGhpcy5lYWNoTGF5ZXIoZnVuY3Rpb24gKGwpIHsKCQkJaWYgKEwuc3RhbXAobCkgPT09IGlkKSB7CgkJCQlyZXN1bHQgPSBsOwoJCQl9CgkJfSk7CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8vUmV0dXJucyB0cnVlIGlmIHRoZSBnaXZlbiBsYXllciBpcyBpbiB0aGlzIE1hcmtlckNsdXN0ZXJHcm91cAoJaGFzTGF5ZXI6IGZ1bmN0aW9uIChsYXllcikgewoJCWlmICghbGF5ZXIpIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJdmFyIGksIGFuQXJyYXkgPSB0aGlzLl9uZWVkc0NsdXN0ZXJpbmc7CgoJCWZvciAoaSA9IGFuQXJyYXkubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJaWYgKGFuQXJyYXlbaV0gPT09IGxheWVyKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCgkJYW5BcnJheSA9IHRoaXMuX25lZWRzUmVtb3Zpbmc7CgkJZm9yIChpID0gYW5BcnJheS5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewoJCQlpZiAoYW5BcnJheVtpXS5sYXllciA9PT0gbGF5ZXIpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0KCgkJcmV0dXJuICEhKGxheWVyLl9fcGFyZW50ICYmIGxheWVyLl9fcGFyZW50Ll9ncm91cCA9PT0gdGhpcykgfHwgdGhpcy5fbm9uUG9pbnRHcm91cC5oYXNMYXllcihsYXllcik7Cgl9LAoKCS8vWm9vbSBkb3duIHRvIHNob3cgdGhlIGdpdmVuIGxheWVyIChzcGlkZXJmeWluZyBpZiBuZWNlc3NhcnkpIHRoZW4gY2FsbHMgdGhlIGNhbGxiYWNrCgl6b29tVG9TaG93TGF5ZXI6IGZ1bmN0aW9uIChsYXllciwgY2FsbGJhY2spIHsKCgkJaWYgKHR5cGVvZiBjYWxsYmFjayAhPT0gJ2Z1bmN0aW9uJykgewoJCQljYWxsYmFjayA9IGZ1bmN0aW9uICgpIHt9OwoJCX0KCgkJdmFyIHNob3dNYXJrZXIgPSBmdW5jdGlvbiAoKSB7CgkJCWlmICgobGF5ZXIuX2ljb24gfHwgbGF5ZXIuX19wYXJlbnQuX2ljb24pICYmICF0aGlzLl9pblpvb21BbmltYXRpb24pIHsKCQkJCXRoaXMuX21hcC5vZmYoJ21vdmVlbmQnLCBzaG93TWFya2VyLCB0aGlzKTsKCQkJCXRoaXMub2ZmKCdhbmltYXRpb25lbmQnLCBzaG93TWFya2VyLCB0aGlzKTsKCgkJCQlpZiAobGF5ZXIuX2ljb24pIHsKCQkJCQljYWxsYmFjaygpOwoJCQkJfSBlbHNlIGlmIChsYXllci5fX3BhcmVudC5faWNvbikgewoJCQkJCXRoaXMub25jZSgnc3BpZGVyZmllZCcsIGNhbGxiYWNrLCB0aGlzKTsKCQkJCQlsYXllci5fX3BhcmVudC5zcGlkZXJmeSgpOwoJCQkJfQoJCQl9CgkJfTsKCgkJaWYgKGxheWVyLl9pY29uICYmIHRoaXMuX21hcC5nZXRCb3VuZHMoKS5jb250YWlucyhsYXllci5nZXRMYXRMbmcoKSkpIHsKCQkJLy9MYXllciBpcyB2aXNpYmxlIG9uZCBvbiBzY3JlZW4sIGltbWVkaWF0ZSByZXR1cm4KCQkJY2FsbGJhY2soKTsKCQl9IGVsc2UgaWYgKGxheWVyLl9fcGFyZW50Ll96b29tIDwgTWF0aC5yb3VuZCh0aGlzLl9tYXAuX3pvb20pKSB7CgkJCS8vTGF5ZXIgc2hvdWxkIGJlIHZpc2libGUgYXQgdGhpcyB6b29tIGxldmVsLiBJdCBtdXN0IG5vdCBiZSBvbiBzY3JlZW4gc28ganVzdCBwYW4gb3ZlciB0byBpdAoJCQl0aGlzLl9tYXAub24oJ21vdmVlbmQnLCBzaG93TWFya2VyLCB0aGlzKTsKCQkJdGhpcy5fbWFwLnBhblRvKGxheWVyLmdldExhdExuZygpKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9tYXAub24oJ21vdmVlbmQnLCBzaG93TWFya2VyLCB0aGlzKTsKCQkJdGhpcy5vbignYW5pbWF0aW9uZW5kJywgc2hvd01hcmtlciwgdGhpcyk7CgkJCWxheWVyLl9fcGFyZW50Lnpvb21Ub0JvdW5kcygpOwoJCX0KCX0sCgoJLy9PdmVycmlkZXMgRmVhdHVyZUdyb3VwLm9uQWRkCglvbkFkZDogZnVuY3Rpb24gKG1hcCkgewoJCXRoaXMuX21hcCA9IG1hcDsKCQl2YXIgaSwgbCwgbGF5ZXI7CgoJCWlmICghaXNGaW5pdGUodGhpcy5fbWFwLmdldE1heFpvb20oKSkpIHsKCQkJdGhyb3cgIk1hcCBoYXMgbm8gbWF4Wm9vbSBzcGVjaWZpZWQiOwoJCX0KCgkJdGhpcy5fZmVhdHVyZUdyb3VwLmFkZFRvKG1hcCk7CgkJdGhpcy5fbm9uUG9pbnRHcm91cC5hZGRUbyhtYXApOwoKCQlpZiAoIXRoaXMuX2dyaWRDbHVzdGVycykgewoJCQl0aGlzLl9nZW5lcmF0ZUluaXRpYWxDbHVzdGVycygpOwoJCX0KCgkJdGhpcy5fbWF4TGF0ID0gbWFwLm9wdGlvbnMuY3JzLnByb2plY3Rpb24uTUFYX0xBVElUVURFOwoKCQkvL1Jlc3RvcmUgYWxsIHRoZSBwb3NpdGlvbnMgYXMgdGhleSBhcmUgaW4gdGhlIE1DRyBiZWZvcmUgcmVtb3ZpbmcgdGhlbQoJCWZvciAoaSA9IDAsIGwgPSB0aGlzLl9uZWVkc1JlbW92aW5nLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJCQlsYXllciA9IHRoaXMuX25lZWRzUmVtb3ZpbmdbaV07CgkJCWxheWVyLm5ld2xhdGxuZyA9IGxheWVyLmxheWVyLl9sYXRsbmc7CgkJCWxheWVyLmxheWVyLl9sYXRsbmcgPSBsYXllci5sYXRsbmc7CgkJfQoJCS8vUmVtb3ZlIHRoZW0sIHRoZW4gcmVzdG9yZSB0aGVpciBuZXcgcG9zaXRpb25zCgkJZm9yIChpID0gMCwgbCA9IHRoaXMuX25lZWRzUmVtb3ZpbmcubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkJCWxheWVyID0gdGhpcy5fbmVlZHNSZW1vdmluZ1tpXTsKCQkJdGhpcy5fcmVtb3ZlTGF5ZXIobGF5ZXIubGF5ZXIsIHRydWUpOwoJCQlsYXllci5sYXllci5fbGF0bG5nID0gbGF5ZXIubmV3bGF0bG5nOwoJCX0KCQl0aGlzLl9uZWVkc1JlbW92aW5nID0gW107CgoJCS8vUmVtZW1iZXIgdGhlIGN1cnJlbnQgem9vbSBsZXZlbCBhbmQgYm91bmRzCgkJdGhpcy5fem9vbSA9IE1hdGgucm91bmQodGhpcy5fbWFwLl96b29tKTsKCQl0aGlzLl9jdXJyZW50U2hvd25Cb3VuZHMgPSB0aGlzLl9nZXRFeHBhbmRlZFZpc2libGVCb3VuZHMoKTsKCgkJdGhpcy5fbWFwLm9uKCd6b29tZW5kJywgdGhpcy5fem9vbUVuZCwgdGhpcyk7CgkJdGhpcy5fbWFwLm9uKCdtb3ZlZW5kJywgdGhpcy5fbW92ZUVuZCwgdGhpcyk7CgoJCWlmICh0aGlzLl9zcGlkZXJmaWVyT25BZGQpIHsgLy9UT0RPIEZJWE1FOiBOb3Qgc3VyZSBob3cgdG8gaGF2ZSBzcGlkZXJmaWVyIGFkZCBzb21ldGhpbmcgb24gaGVyZSBuaWNlbHkKCQkJdGhpcy5fc3BpZGVyZmllck9uQWRkKCk7CgkJfQoKCQl0aGlzLl9iaW5kRXZlbnRzKCk7CgoJCS8vQWN0dWFsbHkgYWRkIG91ciBtYXJrZXJzIHRvIHRoZSBtYXA6CgkJbCA9IHRoaXMuX25lZWRzQ2x1c3RlcmluZzsKCQl0aGlzLl9uZWVkc0NsdXN0ZXJpbmcgPSBbXTsKCQl0aGlzLmFkZExheWVycyhsLCB0cnVlKTsKCX0sCgoJLy9PdmVycmlkZXMgRmVhdHVyZUdyb3VwLm9uUmVtb3ZlCglvblJlbW92ZTogZnVuY3Rpb24gKG1hcCkgewoJCW1hcC5vZmYoJ3pvb21lbmQnLCB0aGlzLl96b29tRW5kLCB0aGlzKTsKCQltYXAub2ZmKCdtb3ZlZW5kJywgdGhpcy5fbW92ZUVuZCwgdGhpcyk7CgoJCXRoaXMuX3VuYmluZEV2ZW50cygpOwoKCQkvL0luIGNhc2Ugd2UgYXJlIGluIGEgY2x1c3RlciBhbmltYXRpb24KCQl0aGlzLl9tYXAuX21hcFBhbmUuY2xhc3NOYW1lID0gdGhpcy5fbWFwLl9tYXBQYW5lLmNsYXNzTmFtZS5yZXBsYWNlKCcgbGVhZmxldC1jbHVzdGVyLWFuaW0nLCAnJyk7CgoJCWlmICh0aGlzLl9zcGlkZXJmaWVyT25SZW1vdmUpIHsgLy9UT0RPIEZJWE1FOiBOb3Qgc3VyZSBob3cgdG8gaGF2ZSBzcGlkZXJmaWVyIGFkZCBzb21ldGhpbmcgb24gaGVyZSBuaWNlbHkKCQkJdGhpcy5fc3BpZGVyZmllck9uUmVtb3ZlKCk7CgkJfQoKCQlkZWxldGUgdGhpcy5fbWF4TGF0OwoKCQkvL0NsZWFuIHVwIGFsbCB0aGUgbGF5ZXJzIHdlIGFkZGVkIHRvIHRoZSBtYXAKCQl0aGlzLl9oaWRlQ292ZXJhZ2UoKTsKCQl0aGlzLl9mZWF0dXJlR3JvdXAucmVtb3ZlKCk7CgkJdGhpcy5fbm9uUG9pbnRHcm91cC5yZW1vdmUoKTsKCgkJdGhpcy5fZmVhdHVyZUdyb3VwLmNsZWFyTGF5ZXJzKCk7CgoJCXRoaXMuX21hcCA9IG51bGw7Cgl9LAoKCWdldFZpc2libGVQYXJlbnQ6IGZ1bmN0aW9uIChtYXJrZXIpIHsKCQl2YXIgdk1hcmtlciA9IG1hcmtlcjsKCQl3aGlsZSAodk1hcmtlciAmJiAhdk1hcmtlci5faWNvbikgewoJCQl2TWFya2VyID0gdk1hcmtlci5fX3BhcmVudDsKCQl9CgkJcmV0dXJuIHZNYXJrZXIgfHwgbnVsbDsKCX0sCgoJLy9SZW1vdmUgdGhlIGdpdmVuIG9iamVjdCBmcm9tIHRoZSBnaXZlbiBhcnJheQoJX2FycmF5U3BsaWNlOiBmdW5jdGlvbiAoYW5BcnJheSwgb2JqKSB7CgkJZm9yICh2YXIgaSA9IGFuQXJyYXkubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJaWYgKGFuQXJyYXlbaV0gPT09IG9iaikgewoJCQkJYW5BcnJheS5zcGxpY2UoaSwgMSk7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCX0sCgoJLyoqCgkgKiBSZW1vdmVzIGEgbWFya2VyIGZyb20gYWxsIF9ncmlkVW5jbHVzdGVyZWQgem9vbSBsZXZlbHMsIHN0YXJ0aW5nIGF0IHRoZSBzdXBwbGllZCB6b29tLgoJICogQHBhcmFtIG1hcmtlciB0byBiZSByZW1vdmVkIGZyb20gX2dyaWRVbmNsdXN0ZXJlZC4KCSAqIEBwYXJhbSB6IGludGVnZXIgYm90dG9tIHN0YXJ0IHpvb20gbGV2ZWwgKGluY2x1ZGVkKQoJICogQHByaXZhdGUKCSAqLwoJX3JlbW92ZUZyb21HcmlkVW5jbHVzdGVyZWQ6IGZ1bmN0aW9uIChtYXJrZXIsIHopIHsKCQl2YXIgbWFwID0gdGhpcy5fbWFwLAoJCSAgICBncmlkVW5jbHVzdGVyZWQgPSB0aGlzLl9ncmlkVW5jbHVzdGVyZWQsCgkJCW1pblpvb20gPSBNYXRoLmZsb29yKHRoaXMuX21hcC5nZXRNaW5ab29tKCkpOwoKCQlmb3IgKDsgeiA+PSBtaW5ab29tOyB6LS0pIHsKCQkJaWYgKCFncmlkVW5jbHVzdGVyZWRbel0ucmVtb3ZlT2JqZWN0KG1hcmtlciwgbWFwLnByb2plY3QobWFya2VyLmdldExhdExuZygpLCB6KSkpIHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfSwKCglfY2hpbGRNYXJrZXJEcmFnU3RhcnQ6IGZ1bmN0aW9uIChlKSB7CgkJZS50YXJnZXQuX19kcmFnU3RhcnQgPSBlLnRhcmdldC5fbGF0bG5nOwoJfSwKCglfY2hpbGRNYXJrZXJNb3ZlZDogZnVuY3Rpb24gKGUpIHsKCQlpZiAoIXRoaXMuX2lnbm9yZU1vdmUgJiYgIWUudGFyZ2V0Ll9fZHJhZ1N0YXJ0KSB7CgkJCXZhciBpc1BvcHVwT3BlbiA9IGUudGFyZ2V0Ll9wb3B1cCAmJiBlLnRhcmdldC5fcG9wdXAuaXNPcGVuKCk7CgoJCQl0aGlzLl9tb3ZlQ2hpbGQoZS50YXJnZXQsIGUub2xkTGF0TG5nLCBlLmxhdGxuZyk7CgoJCQlpZiAoaXNQb3B1cE9wZW4pIHsKCQkJCWUudGFyZ2V0Lm9wZW5Qb3B1cCgpOwoJCQl9CgkJfQoJfSwKCglfbW92ZUNoaWxkOiBmdW5jdGlvbiAobGF5ZXIsIGZyb20sIHRvKSB7CgkJbGF5ZXIuX2xhdGxuZyA9IGZyb207CgkJdGhpcy5yZW1vdmVMYXllcihsYXllcik7CgoJCWxheWVyLl9sYXRsbmcgPSB0bzsKCQl0aGlzLmFkZExheWVyKGxheWVyKTsKCX0sCgoJX2NoaWxkTWFya2VyRHJhZ0VuZDogZnVuY3Rpb24gKGUpIHsKCQl2YXIgZHJhZ1N0YXJ0ID0gZS50YXJnZXQuX19kcmFnU3RhcnQ7CgkJZGVsZXRlIGUudGFyZ2V0Ll9fZHJhZ1N0YXJ0OwoJCWlmIChkcmFnU3RhcnQpIHsKCQkJdGhpcy5fbW92ZUNoaWxkKGUudGFyZ2V0LCBkcmFnU3RhcnQsIGUudGFyZ2V0Ll9sYXRsbmcpOwoJCX0JCQoJfSwKCgoJLy9JbnRlcm5hbCBmdW5jdGlvbiBmb3IgcmVtb3ZpbmcgYSBtYXJrZXIgZnJvbSBldmVyeXRoaW5nLgoJLy9kb250VXBkYXRlTWFwOiBzZXQgdG8gdHJ1ZSBpZiB5b3Ugd2lsbCBoYW5kbGUgdXBkYXRpbmcgdGhlIG1hcCBtYW51YWxseSAoZm9yIGJ1bGsgZnVuY3Rpb25zKQoJX3JlbW92ZUxheWVyOiBmdW5jdGlvbiAobWFya2VyLCByZW1vdmVGcm9tRGlzdGFuY2VHcmlkLCBkb250VXBkYXRlTWFwKSB7CgkJdmFyIGdyaWRDbHVzdGVycyA9IHRoaXMuX2dyaWRDbHVzdGVycywKCQkJZ3JpZFVuY2x1c3RlcmVkID0gdGhpcy5fZ3JpZFVuY2x1c3RlcmVkLAoJCQlmZyA9IHRoaXMuX2ZlYXR1cmVHcm91cCwKCQkJbWFwID0gdGhpcy5fbWFwLAoJCQltaW5ab29tID0gTWF0aC5mbG9vcih0aGlzLl9tYXAuZ2V0TWluWm9vbSgpKTsKCgkJLy9SZW1vdmUgdGhlIG1hcmtlciBmcm9tIGRpc3RhbmNlIGNsdXN0ZXJzIGl0IG1pZ2h0IGJlIGluCgkJaWYgKHJlbW92ZUZyb21EaXN0YW5jZUdyaWQpIHsKCQkJdGhpcy5fcmVtb3ZlRnJvbUdyaWRVbmNsdXN0ZXJlZChtYXJrZXIsIHRoaXMuX21heFpvb20pOwoJCX0KCgkJLy9Xb3JrIG91ciB3YXkgdXAgdGhlIGNsdXN0ZXJzIHJlbW92aW5nIHRoZW0gYXMgd2UgZ28gaWYgcmVxdWlyZWQKCQl2YXIgY2x1c3RlciA9IG1hcmtlci5fX3BhcmVudCwKCQkJbWFya2VycyA9IGNsdXN0ZXIuX21hcmtlcnMsCgkJCW90aGVyTWFya2VyOwoKCQkvL1JlbW92ZSB0aGUgbWFya2VyIGZyb20gdGhlIGltbWVkaWF0ZSBwYXJlbnRzIG1hcmtlciBsaXN0CgkJdGhpcy5fYXJyYXlTcGxpY2UobWFya2VycywgbWFya2VyKTsKCgkJd2hpbGUgKGNsdXN0ZXIpIHsKCQkJY2x1c3Rlci5fY2hpbGRDb3VudC0tOwoJCQljbHVzdGVyLl9ib3VuZHNOZWVkVXBkYXRlID0gdHJ1ZTsKCgkJCWlmIChjbHVzdGVyLl96b29tIDwgbWluWm9vbSkgewoJCQkJLy9Ub3AgbGV2ZWwsIGRvIG5vdGhpbmcKCQkJCWJyZWFrOwoJCQl9IGVsc2UgaWYgKHJlbW92ZUZyb21EaXN0YW5jZUdyaWQgJiYgY2x1c3Rlci5fY2hpbGRDb3VudCA8PSAxKSB7IC8vQ2x1c3RlciBubyBsb25nZXIgcmVxdWlyZWQKCQkJCS8vV2UgbmVlZCB0byBwdXNoIHRoZSBvdGhlciBtYXJrZXIgdXAgdG8gdGhlIHBhcmVudAoJCQkJb3RoZXJNYXJrZXIgPSBjbHVzdGVyLl9tYXJrZXJzWzBdID09PSBtYXJrZXIgPyBjbHVzdGVyLl9tYXJrZXJzWzFdIDogY2x1c3Rlci5fbWFya2Vyc1swXTsKCgkJCQkvL1VwZGF0ZSBkaXN0YW5jZSBncmlkCgkJCQlncmlkQ2x1c3RlcnNbY2x1c3Rlci5fem9vbV0ucmVtb3ZlT2JqZWN0KGNsdXN0ZXIsIG1hcC5wcm9qZWN0KGNsdXN0ZXIuX2NMYXRMbmcsIGNsdXN0ZXIuX3pvb20pKTsKCQkJCWdyaWRVbmNsdXN0ZXJlZFtjbHVzdGVyLl96b29tXS5hZGRPYmplY3Qob3RoZXJNYXJrZXIsIG1hcC5wcm9qZWN0KG90aGVyTWFya2VyLmdldExhdExuZygpLCBjbHVzdGVyLl96b29tKSk7CgoJCQkJLy9Nb3ZlIG90aGVyTWFya2VyIHVwIHRvIHBhcmVudAoJCQkJdGhpcy5fYXJyYXlTcGxpY2UoY2x1c3Rlci5fX3BhcmVudC5fY2hpbGRDbHVzdGVycywgY2x1c3Rlcik7CgkJCQljbHVzdGVyLl9fcGFyZW50Ll9tYXJrZXJzLnB1c2gob3RoZXJNYXJrZXIpOwoJCQkJb3RoZXJNYXJrZXIuX19wYXJlbnQgPSBjbHVzdGVyLl9fcGFyZW50OwoKCQkJCWlmIChjbHVzdGVyLl9pY29uKSB7CgkJCQkJLy9DbHVzdGVyIGlzIGN1cnJlbnRseSBvbiB0aGUgbWFwLCBuZWVkIHRvIHB1dCB0aGUgbWFya2VyIG9uIHRoZSBtYXAgaW5zdGVhZAoJCQkJCWZnLnJlbW92ZUxheWVyKGNsdXN0ZXIpOwoJCQkJCWlmICghZG9udFVwZGF0ZU1hcCkgewoJCQkJCQlmZy5hZGRMYXllcihvdGhlck1hcmtlcik7CgkJCQkJfQoJCQkJfQoJCQl9IGVsc2UgewoJCQkJY2x1c3Rlci5faWNvbk5lZWRzVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJY2x1c3RlciA9IGNsdXN0ZXIuX19wYXJlbnQ7CgkJfQoKCQlkZWxldGUgbWFya2VyLl9fcGFyZW50OwoJfSwKCglfaXNPcklzUGFyZW50OiBmdW5jdGlvbiAoZWwsIG9lbCkgewoJCXdoaWxlIChvZWwpIHsKCQkJaWYgKGVsID09PSBvZWwpIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJCW9lbCA9IG9lbC5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCS8vT3ZlcnJpZGUgTC5FdmVudGVkLmZpcmUKCWZpcmU6IGZ1bmN0aW9uICh0eXBlLCBkYXRhLCBwcm9wYWdhdGUpIHsKCQlpZiAoZGF0YSAmJiBkYXRhLmxheWVyIGluc3RhbmNlb2YgTC5NYXJrZXJDbHVzdGVyKSB7CgkJCS8vUHJldmVudCBtdWx0aXBsZSBjbHVzdGVybW91c2VvdmVyL29mZiBldmVudHMgaWYgdGhlIGljb24gaXMgbWFkZSB1cCBvZiBzdGFja2VkIGRpdnMgKERvZXNuJ3Qgd29yayBpbiBpZSA8PSA4LCBubyByZWxhdGVkVGFyZ2V0KQoJCQlpZiAoZGF0YS5vcmlnaW5hbEV2ZW50ICYmIHRoaXMuX2lzT3JJc1BhcmVudChkYXRhLmxheWVyLl9pY29uLCBkYXRhLm9yaWdpbmFsRXZlbnQucmVsYXRlZFRhcmdldCkpIHsKCQkJCXJldHVybjsKCQkJfQoJCQl0eXBlID0gJ2NsdXN0ZXInICsgdHlwZTsKCQl9CgoJCUwuRmVhdHVyZUdyb3VwLnByb3RvdHlwZS5maXJlLmNhbGwodGhpcywgdHlwZSwgZGF0YSwgcHJvcGFnYXRlKTsKCX0sCgoJLy9PdmVycmlkZSBMLkV2ZW50ZWQubGlzdGVucwoJbGlzdGVuczogZnVuY3Rpb24gKHR5cGUsIHByb3BhZ2F0ZSkgewoJCXJldHVybiBMLkZlYXR1cmVHcm91cC5wcm90b3R5cGUubGlzdGVucy5jYWxsKHRoaXMsIHR5cGUsIHByb3BhZ2F0ZSkgfHwgTC5GZWF0dXJlR3JvdXAucHJvdG90eXBlLmxpc3RlbnMuY2FsbCh0aGlzLCAnY2x1c3RlcicgKyB0eXBlLCBwcm9wYWdhdGUpOwoJfSwKCgkvL0RlZmF1bHQgZnVuY3Rpb25hbGl0eQoJX2RlZmF1bHRJY29uQ3JlYXRlRnVuY3Rpb246IGZ1bmN0aW9uIChjbHVzdGVyKSB7CgkJdmFyIGNoaWxkQ291bnQgPSBjbHVzdGVyLmdldENoaWxkQ291bnQoKTsKCgkJdmFyIGMgPSAnIG1hcmtlci1jbHVzdGVyLSc7CgkJaWYgKGNoaWxkQ291bnQgPCAxMCkgewoJCQljICs9ICdzbWFsbCc7CgkJfSBlbHNlIGlmIChjaGlsZENvdW50IDwgMTAwKSB7CgkJCWMgKz0gJ21lZGl1bSc7CgkJfSBlbHNlIHsKCQkJYyArPSAnbGFyZ2UnOwoJCX0KCgkJcmV0dXJuIG5ldyBMLkRpdkljb24oeyBodG1sOiAnPGRpdj48c3Bhbj4nICsgY2hpbGRDb3VudCArICc8L3NwYW4+PC9kaXY+JywgY2xhc3NOYW1lOiAnbWFya2VyLWNsdXN0ZXInICsgYywgaWNvblNpemU6IG5ldyBMLlBvaW50KDQwLCA0MCkgfSk7Cgl9LAoKCV9iaW5kRXZlbnRzOiBmdW5jdGlvbiAoKSB7CgkJdmFyIG1hcCA9IHRoaXMuX21hcCwKCQkgICAgc3BpZGVyZnlPbk1heFpvb20gPSB0aGlzLm9wdGlvbnMuc3BpZGVyZnlPbk1heFpvb20sCgkJICAgIHNob3dDb3ZlcmFnZU9uSG92ZXIgPSB0aGlzLm9wdGlvbnMuc2hvd0NvdmVyYWdlT25Ib3ZlciwKCQkgICAgem9vbVRvQm91bmRzT25DbGljayA9IHRoaXMub3B0aW9ucy56b29tVG9Cb3VuZHNPbkNsaWNrOwoKCQkvL1pvb20gb24gY2x1c3RlciBjbGljayBvciBzcGlkZXJmeSBpZiB3ZSBhcmUgYXQgdGhlIGxvd2VzdCBsZXZlbAoJCWlmIChzcGlkZXJmeU9uTWF4Wm9vbSB8fCB6b29tVG9Cb3VuZHNPbkNsaWNrKSB7CgkJCXRoaXMub24oJ2NsdXN0ZXJjbGljaycsIHRoaXMuX3pvb21PclNwaWRlcmZ5LCB0aGlzKTsKCQl9CgoJCS8vU2hvdyBjb252ZXggaHVsbCAoYm91bmRhcnkpIHBvbHlnb24gb24gbW91c2Ugb3ZlcgoJCWlmIChzaG93Q292ZXJhZ2VPbkhvdmVyKSB7CgkJCXRoaXMub24oJ2NsdXN0ZXJtb3VzZW92ZXInLCB0aGlzLl9zaG93Q292ZXJhZ2UsIHRoaXMpOwoJCQl0aGlzLm9uKCdjbHVzdGVybW91c2VvdXQnLCB0aGlzLl9oaWRlQ292ZXJhZ2UsIHRoaXMpOwoJCQltYXAub24oJ3pvb21lbmQnLCB0aGlzLl9oaWRlQ292ZXJhZ2UsIHRoaXMpOwoJCX0KCX0sCgoJX3pvb21PclNwaWRlcmZ5OiBmdW5jdGlvbiAoZSkgewoJCXZhciBjbHVzdGVyID0gZS5sYXllciwKCQkgICAgYm90dG9tQ2x1c3RlciA9IGNsdXN0ZXI7CgoJCXdoaWxlIChib3R0b21DbHVzdGVyLl9jaGlsZENsdXN0ZXJzLmxlbmd0aCA9PT0gMSkgewoJCQlib3R0b21DbHVzdGVyID0gYm90dG9tQ2x1c3Rlci5fY2hpbGRDbHVzdGVyc1swXTsKCQl9CgoJCWlmIChib3R0b21DbHVzdGVyLl96b29tID09PSB0aGlzLl9tYXhab29tICYmCgkJCWJvdHRvbUNsdXN0ZXIuX2NoaWxkQ291bnQgPT09IGNsdXN0ZXIuX2NoaWxkQ291bnQgJiYKCQkJdGhpcy5vcHRpb25zLnNwaWRlcmZ5T25NYXhab29tKSB7CgoJCQkvLyBBbGwgY2hpbGQgbWFya2VycyBhcmUgY29udGFpbmVkIGluIGEgc2luZ2xlIGNsdXN0ZXIgZnJvbSB0aGlzLl9tYXhab29tIHRvIHRoaXMgY2x1c3Rlci4KCQkJY2x1c3Rlci5zcGlkZXJmeSgpOwoJCX0gZWxzZSBpZiAodGhpcy5vcHRpb25zLnpvb21Ub0JvdW5kc09uQ2xpY2spIHsKCQkJY2x1c3Rlci56b29tVG9Cb3VuZHMoKTsKCQl9CgoJCS8vIEZvY3VzIHRoZSBtYXAgYWdhaW4gZm9yIGtleWJvYXJkIHVzZXJzLgoJCWlmIChlLm9yaWdpbmFsRXZlbnQgJiYgZS5vcmlnaW5hbEV2ZW50LmtleUNvZGUgPT09IDEzKSB7CgkJCXRoaXMuX21hcC5fY29udGFpbmVyLmZvY3VzKCk7CgkJfQoJfSwKCglfc2hvd0NvdmVyYWdlOiBmdW5jdGlvbiAoZSkgewoJCXZhciBtYXAgPSB0aGlzLl9tYXA7CgkJaWYgKHRoaXMuX2luWm9vbUFuaW1hdGlvbikgewoJCQlyZXR1cm47CgkJfQoJCWlmICh0aGlzLl9zaG93blBvbHlnb24pIHsKCQkJbWFwLnJlbW92ZUxheWVyKHRoaXMuX3Nob3duUG9seWdvbik7CgkJfQoJCWlmIChlLmxheWVyLmdldENoaWxkQ291bnQoKSA+IDIgJiYgZS5sYXllciAhPT0gdGhpcy5fc3BpZGVyZmllZCkgewoJCQl0aGlzLl9zaG93blBvbHlnb24gPSBuZXcgTC5Qb2x5Z29uKGUubGF5ZXIuZ2V0Q29udmV4SHVsbCgpLCB0aGlzLm9wdGlvbnMucG9seWdvbk9wdGlvbnMpOwoJCQltYXAuYWRkTGF5ZXIodGhpcy5fc2hvd25Qb2x5Z29uKTsKCQl9Cgl9LAoKCV9oaWRlQ292ZXJhZ2U6IGZ1bmN0aW9uICgpIHsKCQlpZiAodGhpcy5fc2hvd25Qb2x5Z29uKSB7CgkJCXRoaXMuX21hcC5yZW1vdmVMYXllcih0aGlzLl9zaG93blBvbHlnb24pOwoJCQl0aGlzLl9zaG93blBvbHlnb24gPSBudWxsOwoJCX0KCX0sCgoJX3VuYmluZEV2ZW50czogZnVuY3Rpb24gKCkgewoJCXZhciBzcGlkZXJmeU9uTWF4Wm9vbSA9IHRoaXMub3B0aW9ucy5zcGlkZXJmeU9uTWF4Wm9vbSwKCQkJc2hvd0NvdmVyYWdlT25Ib3ZlciA9IHRoaXMub3B0aW9ucy5zaG93Q292ZXJhZ2VPbkhvdmVyLAoJCQl6b29tVG9Cb3VuZHNPbkNsaWNrID0gdGhpcy5vcHRpb25zLnpvb21Ub0JvdW5kc09uQ2xpY2ssCgkJCW1hcCA9IHRoaXMuX21hcDsKCgkJaWYgKHNwaWRlcmZ5T25NYXhab29tIHx8IHpvb21Ub0JvdW5kc09uQ2xpY2spIHsKCQkJdGhpcy5vZmYoJ2NsdXN0ZXJjbGljaycsIHRoaXMuX3pvb21PclNwaWRlcmZ5LCB0aGlzKTsKCQl9CgkJaWYgKHNob3dDb3ZlcmFnZU9uSG92ZXIpIHsKCQkJdGhpcy5vZmYoJ2NsdXN0ZXJtb3VzZW92ZXInLCB0aGlzLl9zaG93Q292ZXJhZ2UsIHRoaXMpOwoJCQl0aGlzLm9mZignY2x1c3Rlcm1vdXNlb3V0JywgdGhpcy5faGlkZUNvdmVyYWdlLCB0aGlzKTsKCQkJbWFwLm9mZignem9vbWVuZCcsIHRoaXMuX2hpZGVDb3ZlcmFnZSwgdGhpcyk7CgkJfQoJfSwKCglfem9vbUVuZDogZnVuY3Rpb24gKCkgewoJCWlmICghdGhpcy5fbWFwKSB7IC8vTWF5IGhhdmUgYmVlbiByZW1vdmVkIGZyb20gdGhlIG1hcCBieSBhIHpvb21FbmQgaGFuZGxlcgoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX21lcmdlU3BsaXRDbHVzdGVycygpOwoKCQl0aGlzLl96b29tID0gTWF0aC5yb3VuZCh0aGlzLl9tYXAuX3pvb20pOwoJCXRoaXMuX2N1cnJlbnRTaG93bkJvdW5kcyA9IHRoaXMuX2dldEV4cGFuZGVkVmlzaWJsZUJvdW5kcygpOwoJfSwKCglfbW92ZUVuZDogZnVuY3Rpb24gKCkgewoJCWlmICh0aGlzLl9pblpvb21BbmltYXRpb24pIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIG5ld0JvdW5kcyA9IHRoaXMuX2dldEV4cGFuZGVkVmlzaWJsZUJvdW5kcygpOwoKCQl0aGlzLl90b3BDbHVzdGVyTGV2ZWwuX3JlY3Vyc2l2ZWx5UmVtb3ZlQ2hpbGRyZW5Gcm9tTWFwKHRoaXMuX2N1cnJlbnRTaG93bkJvdW5kcywgTWF0aC5mbG9vcih0aGlzLl9tYXAuZ2V0TWluWm9vbSgpKSwgdGhpcy5fem9vbSwgbmV3Qm91bmRzKTsKCQl0aGlzLl90b3BDbHVzdGVyTGV2ZWwuX3JlY3Vyc2l2ZWx5QWRkQ2hpbGRyZW5Ub01hcChudWxsLCBNYXRoLnJvdW5kKHRoaXMuX21hcC5fem9vbSksIG5ld0JvdW5kcyk7CgoJCXRoaXMuX2N1cnJlbnRTaG93bkJvdW5kcyA9IG5ld0JvdW5kczsKCQlyZXR1cm47Cgl9LAoKCV9nZW5lcmF0ZUluaXRpYWxDbHVzdGVyczogZnVuY3Rpb24gKCkgewoJCXZhciBtYXhab29tID0gTWF0aC5jZWlsKHRoaXMuX21hcC5nZXRNYXhab29tKCkpLAoJCQltaW5ab29tID0gTWF0aC5mbG9vcih0aGlzLl9tYXAuZ2V0TWluWm9vbSgpKSwKCQkJcmFkaXVzID0gdGhpcy5vcHRpb25zLm1heENsdXN0ZXJSYWRpdXMsCgkJCXJhZGl1c0ZuID0gcmFkaXVzOwoKCQkvL0lmIHdlIGp1c3Qgc2V0IG1heENsdXN0ZXJSYWRpdXMgdG8gYSBzaW5nbGUgbnVtYmVyLCB3ZSBuZWVkIHRvIGNyZWF0ZQoJCS8vYSBzaW1wbGUgZnVuY3Rpb24gdG8gcmV0dXJuIHRoYXQgbnVtYmVyLiBPdGhlcndpc2UsIHdlIGp1c3QgaGF2ZSB0bwoJCS8vdXNlIHRoZSBmdW5jdGlvbiB3ZSd2ZSBwYXNzZWQgaW4uCgkJaWYgKHR5cGVvZiByYWRpdXMgIT09ICJmdW5jdGlvbiIpIHsKCQkJcmFkaXVzRm4gPSBmdW5jdGlvbiAoKSB7IHJldHVybiByYWRpdXM7IH07CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLmRpc2FibGVDbHVzdGVyaW5nQXRab29tICE9PSBudWxsKSB7CgkJCW1heFpvb20gPSB0aGlzLm9wdGlvbnMuZGlzYWJsZUNsdXN0ZXJpbmdBdFpvb20gLSAxOwoJCX0KCQl0aGlzLl9tYXhab29tID0gbWF4Wm9vbTsKCQl0aGlzLl9ncmlkQ2x1c3RlcnMgPSB7fTsKCQl0aGlzLl9ncmlkVW5jbHVzdGVyZWQgPSB7fTsKCgkJLy9TZXQgdXAgRGlzdGFuY2VHcmlkcyBmb3IgZWFjaCB6b29tCgkJZm9yICh2YXIgem9vbSA9IG1heFpvb207IHpvb20gPj0gbWluWm9vbTsgem9vbS0tKSB7CgkJCXRoaXMuX2dyaWRDbHVzdGVyc1t6b29tXSA9IG5ldyBMLkRpc3RhbmNlR3JpZChyYWRpdXNGbih6b29tKSk7CgkJCXRoaXMuX2dyaWRVbmNsdXN0ZXJlZFt6b29tXSA9IG5ldyBMLkRpc3RhbmNlR3JpZChyYWRpdXNGbih6b29tKSk7CgkJfQoKCQkvLyBJbnN0YW50aWF0ZSB0aGUgYXBwcm9wcmlhdGUgTC5NYXJrZXJDbHVzdGVyIGNsYXNzIChhbmltYXRlZCBvciBub3QpLgoJCXRoaXMuX3RvcENsdXN0ZXJMZXZlbCA9IG5ldyB0aGlzLl9tYXJrZXJDbHVzdGVyKHRoaXMsIG1pblpvb20gLSAxKTsKCX0sCgoJLy9ab29tOiBab29tIHRvIHN0YXJ0IGFkZGluZyBhdCAoUGFzcyB0aGlzLl9tYXhab29tIHRvIHN0YXJ0IGF0IHRoZSBib3R0b20pCglfYWRkTGF5ZXI6IGZ1bmN0aW9uIChsYXllciwgem9vbSkgewoJCXZhciBncmlkQ2x1c3RlcnMgPSB0aGlzLl9ncmlkQ2x1c3RlcnMsCgkJICAgIGdyaWRVbmNsdXN0ZXJlZCA9IHRoaXMuX2dyaWRVbmNsdXN0ZXJlZCwKCQkJbWluWm9vbSA9IE1hdGguZmxvb3IodGhpcy5fbWFwLmdldE1pblpvb20oKSksCgkJICAgIG1hcmtlclBvaW50LCB6OwoKCQlpZiAodGhpcy5vcHRpb25zLnNpbmdsZU1hcmtlck1vZGUpIHsKCQkJdGhpcy5fb3ZlcnJpZGVNYXJrZXJJY29uKGxheWVyKTsKCQl9CgoJCWxheWVyLm9uKHRoaXMuX2NoaWxkTWFya2VyRXZlbnRIYW5kbGVycywgdGhpcyk7CgoJCS8vRmluZCB0aGUgbG93ZXN0IHpvb20gbGV2ZWwgdG8gc2xvdCB0aGlzIG9uZSBpbgoJCWZvciAoOyB6b29tID49IG1pblpvb207IHpvb20tLSkgewoJCQltYXJrZXJQb2ludCA9IHRoaXMuX21hcC5wcm9qZWN0KGxheWVyLmdldExhdExuZygpLCB6b29tKTsgLy8gY2FsY3VsYXRlIHBpeGVsIHBvc2l0aW9uCgoJCQkvL1RyeSBmaW5kIGEgY2x1c3RlciBjbG9zZSBieQoJCQl2YXIgY2xvc2VzdCA9IGdyaWRDbHVzdGVyc1t6b29tXS5nZXROZWFyT2JqZWN0KG1hcmtlclBvaW50KTsKCQkJaWYgKGNsb3Nlc3QpIHsKCQkJCWNsb3Nlc3QuX2FkZENoaWxkKGxheWVyKTsKCQkJCWxheWVyLl9fcGFyZW50ID0gY2xvc2VzdDsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9UcnkgZmluZCBhIG1hcmtlciBjbG9zZSBieSB0byBmb3JtIGEgbmV3IGNsdXN0ZXIgd2l0aAoJCQljbG9zZXN0ID0gZ3JpZFVuY2x1c3RlcmVkW3pvb21dLmdldE5lYXJPYmplY3QobWFya2VyUG9pbnQpOwoJCQlpZiAoY2xvc2VzdCkgewoJCQkJdmFyIHBhcmVudCA9IGNsb3Nlc3QuX19wYXJlbnQ7CgkJCQlpZiAocGFyZW50KSB7CgkJCQkJdGhpcy5fcmVtb3ZlTGF5ZXIoY2xvc2VzdCwgZmFsc2UpOwoJCQkJfQoKCQkJCS8vQ3JlYXRlIG5ldyBjbHVzdGVyIHdpdGggdGhlc2UgMiBpbiBpdAoKCQkJCXZhciBuZXdDbHVzdGVyID0gbmV3IHRoaXMuX21hcmtlckNsdXN0ZXIodGhpcywgem9vbSwgY2xvc2VzdCwgbGF5ZXIpOwoJCQkJZ3JpZENsdXN0ZXJzW3pvb21dLmFkZE9iamVjdChuZXdDbHVzdGVyLCB0aGlzLl9tYXAucHJvamVjdChuZXdDbHVzdGVyLl9jTGF0TG5nLCB6b29tKSk7CgkJCQljbG9zZXN0Ll9fcGFyZW50ID0gbmV3Q2x1c3RlcjsKCQkJCWxheWVyLl9fcGFyZW50ID0gbmV3Q2x1c3RlcjsKCgkJCQkvL0ZpcnN0IGNyZWF0ZSBhbnkgbmV3IGludGVybWVkaWF0ZSBwYXJlbnQgY2x1c3RlcnMgdGhhdCBkb24ndCBleGlzdAoJCQkJdmFyIGxhc3RQYXJlbnQgPSBuZXdDbHVzdGVyOwoJCQkJZm9yICh6ID0gem9vbSAtIDE7IHogPiBwYXJlbnQuX3pvb207IHotLSkgewoJCQkJCWxhc3RQYXJlbnQgPSBuZXcgdGhpcy5fbWFya2VyQ2x1c3Rlcih0aGlzLCB6LCBsYXN0UGFyZW50KTsKCQkJCQlncmlkQ2x1c3RlcnNbel0uYWRkT2JqZWN0KGxhc3RQYXJlbnQsIHRoaXMuX21hcC5wcm9qZWN0KGNsb3Nlc3QuZ2V0TGF0TG5nKCksIHopKTsKCQkJCX0KCQkJCXBhcmVudC5fYWRkQ2hpbGQobGFzdFBhcmVudCk7CgoJCQkJLy9SZW1vdmUgY2xvc2VzdCBmcm9tIHRoaXMgem9vbSBsZXZlbCBhbmQgYW55IGFib3ZlIHRoYXQgaXQgaXMgaW4sIHJlcGxhY2Ugd2l0aCBuZXdDbHVzdGVyCgkJCQl0aGlzLl9yZW1vdmVGcm9tR3JpZFVuY2x1c3RlcmVkKGNsb3Nlc3QsIHpvb20pOwoKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9EaWRuJ3QgbWFuYWdlIHRvIGNsdXN0ZXIgaW4gYXQgdGhpcyB6b29tLCByZWNvcmQgdXMgYXMgYSBtYXJrZXIgaGVyZSBhbmQgY29udGludWUgdXB3YXJkcwoJCQlncmlkVW5jbHVzdGVyZWRbem9vbV0uYWRkT2JqZWN0KGxheWVyLCBtYXJrZXJQb2ludCk7CgkJfQoKCQkvL0RpZG4ndCBnZXQgaW4gYW55dGhpbmcsIGFkZCB1cyB0byB0aGUgdG9wCgkJdGhpcy5fdG9wQ2x1c3RlckxldmVsLl9hZGRDaGlsZChsYXllcik7CgkJbGF5ZXIuX19wYXJlbnQgPSB0aGlzLl90b3BDbHVzdGVyTGV2ZWw7CgkJcmV0dXJuOwoJfSwKCgkvKioKCSAqIFJlZnJlc2hlcyB0aGUgaWNvbiBvZiBhbGwgImRpcnR5IiB2aXNpYmxlIGNsdXN0ZXJzLgoJICogTm9uLXZpc2libGUgImRpcnR5IiBjbHVzdGVycyB3aWxsIGJlIHVwZGF0ZWQgd2hlbiB0aGV5IGFyZSBhZGRlZCB0byB0aGUgbWFwLgoJICogQHByaXZhdGUKCSAqLwoJX3JlZnJlc2hDbHVzdGVyc0ljb25zOiBmdW5jdGlvbiAoKSB7CgkJdGhpcy5fZmVhdHVyZUdyb3VwLmVhY2hMYXllcihmdW5jdGlvbiAoYykgewoJCQlpZiAoYyBpbnN0YW5jZW9mIEwuTWFya2VyQ2x1c3RlciAmJiBjLl9pY29uTmVlZHNVcGRhdGUpIHsKCQkJCWMuX3VwZGF0ZUljb24oKTsKCQkJfQoJCX0pOwoJfSwKCgkvL0VucXVldWUgY29kZSB0byBmaXJlIGFmdGVyIHRoZSBtYXJrZXIgZXhwYW5kL2NvbnRyYWN0IGhhcyBoYXBwZW5lZAoJX2VucXVldWU6IGZ1bmN0aW9uIChmbikgewoJCXRoaXMuX3F1ZXVlLnB1c2goZm4pOwoJCWlmICghdGhpcy5fcXVldWVUaW1lb3V0KSB7CgkJCXRoaXMuX3F1ZXVlVGltZW91dCA9IHNldFRpbWVvdXQoTC5iaW5kKHRoaXMuX3Byb2Nlc3NRdWV1ZSwgdGhpcyksIDMwMCk7CgkJfQoJfSwKCV9wcm9jZXNzUXVldWU6IGZ1bmN0aW9uICgpIHsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3F1ZXVlLmxlbmd0aDsgaSsrKSB7CgkJCXRoaXMuX3F1ZXVlW2ldLmNhbGwodGhpcyk7CgkJfQoJCXRoaXMuX3F1ZXVlLmxlbmd0aCA9IDA7CgkJY2xlYXJUaW1lb3V0KHRoaXMuX3F1ZXVlVGltZW91dCk7CgkJdGhpcy5fcXVldWVUaW1lb3V0ID0gbnVsbDsKCX0sCgoJLy9NZXJnZSBhbmQgc3BsaXQgYW55IGV4aXN0aW5nIGNsdXN0ZXJzIHRoYXQgYXJlIHRvbyBiaWcgb3Igc21hbGwKCV9tZXJnZVNwbGl0Q2x1c3RlcnM6IGZ1bmN0aW9uICgpIHsKCQl2YXIgbWFwWm9vbSA9IE1hdGgucm91bmQodGhpcy5fbWFwLl96b29tKTsKCgkJLy9JbiBjYXNlIHdlIGFyZSBzdGFydGluZyB0byBzcGxpdCBiZWZvcmUgdGhlIGFuaW1hdGlvbiBmaW5pc2hlZAoJCXRoaXMuX3Byb2Nlc3NRdWV1ZSgpOwoKCQlpZiAodGhpcy5fem9vbSA8IG1hcFpvb20gJiYgdGhpcy5fY3VycmVudFNob3duQm91bmRzLmludGVyc2VjdHModGhpcy5fZ2V0RXhwYW5kZWRWaXNpYmxlQm91bmRzKCkpKSB7IC8vWm9vbSBpbiwgc3BsaXQKCQkJdGhpcy5fYW5pbWF0aW9uU3RhcnQoKTsKCQkJLy9SZW1vdmUgY2x1c3RlcnMgbm93IG9mZiBzY3JlZW4KCQkJdGhpcy5fdG9wQ2x1c3RlckxldmVsLl9yZWN1cnNpdmVseVJlbW92ZUNoaWxkcmVuRnJvbU1hcCh0aGlzLl9jdXJyZW50U2hvd25Cb3VuZHMsIE1hdGguZmxvb3IodGhpcy5fbWFwLmdldE1pblpvb20oKSksIHRoaXMuX3pvb20sIHRoaXMuX2dldEV4cGFuZGVkVmlzaWJsZUJvdW5kcygpKTsKCgkJCXRoaXMuX2FuaW1hdGlvblpvb21Jbih0aGlzLl96b29tLCBtYXBab29tKTsKCgkJfSBlbHNlIGlmICh0aGlzLl96b29tID4gbWFwWm9vbSkgeyAvL1pvb20gb3V0LCBtZXJnZQoJCQl0aGlzLl9hbmltYXRpb25TdGFydCgpOwoKCQkJdGhpcy5fYW5pbWF0aW9uWm9vbU91dCh0aGlzLl96b29tLCBtYXBab29tKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9tb3ZlRW5kKCk7CgkJfQoJfSwKCgkvL0dldHMgdGhlIG1hcHMgdmlzaWJsZSBib3VuZHMgZXhwYW5kZWQgaW4gZWFjaCBkaXJlY3Rpb24gYnkgdGhlIHNpemUgb2YgdGhlIHNjcmVlbiAoc28gdGhlIHVzZXIgY2Fubm90IHNlZSBhbiBhcmVhIHdlIGRvIG5vdCBjb3ZlciBpbiBvbmUgcGFuKQoJX2dldEV4cGFuZGVkVmlzaWJsZUJvdW5kczogZnVuY3Rpb24gKCkgewoJCWlmICghdGhpcy5vcHRpb25zLnJlbW92ZU91dHNpZGVWaXNpYmxlQm91bmRzKSB7CgkJCXJldHVybiB0aGlzLl9tYXBCb3VuZHNJbmZpbml0ZTsKCQl9IGVsc2UgaWYgKEwuQnJvd3Nlci5tb2JpbGUpIHsKCQkJcmV0dXJuIHRoaXMuX2NoZWNrQm91bmRzTWF4TGF0KHRoaXMuX21hcC5nZXRCb3VuZHMoKSk7CgkJfQoKCQlyZXR1cm4gdGhpcy5fY2hlY2tCb3VuZHNNYXhMYXQodGhpcy5fbWFwLmdldEJvdW5kcygpLnBhZCgxKSk7IC8vIFBhZGRpbmcgZXhwYW5kcyB0aGUgYm91bmRzIGJ5IGl0cyBvd24gZGltZW5zaW9ucyBidXQgc2NhbGVkIHdpdGggdGhlIGdpdmVuIGZhY3Rvci4KCX0sCgoJLyoqCgkgKiBFeHBhbmRzIHRoZSBsYXRpdHVkZSB0byBJbmZpbml0eSAob3IgLUluZmluaXR5KSBpZiB0aGUgaW5wdXQgYm91bmRzIHJlYWNoIHRoZSBtYXAgcHJvamVjdGlvbiBtYXhpbXVtIGRlZmluZWQgbGF0aXR1ZGUKCSAqIChpbiB0aGUgY2FzZSBvZiBXZWIvU3BoZXJpY2FsIE1lcmNhdG9yLCBpdCBpcyA4NS4wNTExMjg3Nzk4IC8gc2VlIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1dlYl9NZXJjYXRvciNGb3JtdWxhcykuCgkgKiBPdGhlcndpc2UsIHRoZSByZW1vdmVPdXRzaWRlVmlzaWJsZUJvdW5kcyBvcHRpb24gd2lsbCByZW1vdmUgbWFya2VycyBiZXlvbmQgdGhhdCBsaW1pdCwgd2hlcmVhcyB0aGUgc2FtZSBtYXJrZXJzIHdpdGhvdXQKCSAqIHRoaXMgb3B0aW9uIChvciBvdXRzaWRlIE1DRykgd2lsbCBoYXZlIHRoZWlyIHBvc2l0aW9uIGZsb29yZWQgKGNlaWxlZCkgYnkgdGhlIHByb2plY3Rpb24gYW5kIHJlbmRlcmVkIGF0IHRoYXQgbGltaXQsCgkgKiBtYWtpbmcgdGhlIHVzZXIgdGhpbmsgdGhhdCBNQ0cgImVhdHMiIHRoZW0gYW5kIG5ldmVyIGRpc3BsYXlzIHRoZW0gYWdhaW4uCgkgKiBAcGFyYW0gYm91bmRzIEwuTGF0TG5nQm91bmRzCgkgKiBAcmV0dXJucyB7TC5MYXRMbmdCb3VuZHN9CgkgKiBAcHJpdmF0ZQoJICovCglfY2hlY2tCb3VuZHNNYXhMYXQ6IGZ1bmN0aW9uIChib3VuZHMpIHsKCQl2YXIgbWF4TGF0ID0gdGhpcy5fbWF4TGF0OwoKCQlpZiAobWF4TGF0ICE9PSB1bmRlZmluZWQpIHsKCQkJaWYgKGJvdW5kcy5nZXROb3J0aCgpID49IG1heExhdCkgewoJCQkJYm91bmRzLl9ub3J0aEVhc3QubGF0ID0gSW5maW5pdHk7CgkJCX0KCQkJaWYgKGJvdW5kcy5nZXRTb3V0aCgpIDw9IC1tYXhMYXQpIHsKCQkJCWJvdW5kcy5fc291dGhXZXN0LmxhdCA9IC1JbmZpbml0eTsKCQkJfQoJCX0KCgkJcmV0dXJuIGJvdW5kczsKCX0sCgoJLy9TaGFyZWQgYW5pbWF0aW9uIGNvZGUKCV9hbmltYXRpb25BZGRMYXllck5vbkFuaW1hdGVkOiBmdW5jdGlvbiAobGF5ZXIsIG5ld0NsdXN0ZXIpIHsKCQlpZiAobmV3Q2x1c3RlciA9PT0gbGF5ZXIpIHsKCQkJdGhpcy5fZmVhdHVyZUdyb3VwLmFkZExheWVyKGxheWVyKTsKCQl9IGVsc2UgaWYgKG5ld0NsdXN0ZXIuX2NoaWxkQ291bnQgPT09IDIpIHsKCQkJbmV3Q2x1c3Rlci5fYWRkVG9NYXAoKTsKCgkJCXZhciBtYXJrZXJzID0gbmV3Q2x1c3Rlci5nZXRBbGxDaGlsZE1hcmtlcnMoKTsKCQkJdGhpcy5fZmVhdHVyZUdyb3VwLnJlbW92ZUxheWVyKG1hcmtlcnNbMF0pOwoJCQl0aGlzLl9mZWF0dXJlR3JvdXAucmVtb3ZlTGF5ZXIobWFya2Vyc1sxXSk7CgkJfSBlbHNlIHsKCQkJbmV3Q2x1c3Rlci5fdXBkYXRlSWNvbigpOwoJCX0KCX0sCgoJLyoqCgkgKiBFeHRyYWN0cyBpbmRpdmlkdWFsIChpLmUuIG5vbi1ncm91cCkgbGF5ZXJzIGZyb20gYSBMYXllciBHcm91cC4KCSAqIEBwYXJhbSBncm91cCB0byBleHRyYWN0IGxheWVycyBmcm9tLgoJICogQHBhcmFtIG91dHB1dCB7QXJyYXl9IGluIHdoaWNoIHRvIHN0b3JlIHRoZSBleHRyYWN0ZWQgbGF5ZXJzLgoJICogQHJldHVybnMgeyp8QXJyYXl9CgkgKiBAcHJpdmF0ZQoJICovCglfZXh0cmFjdE5vbkdyb3VwTGF5ZXJzOiBmdW5jdGlvbiAoZ3JvdXAsIG91dHB1dCkgewoJCXZhciBsYXllcnMgPSBncm91cC5nZXRMYXllcnMoKSwKCQkgICAgaSA9IDAsCgkJICAgIGxheWVyOwoKCQlvdXRwdXQgPSBvdXRwdXQgfHwgW107CgoJCWZvciAoOyBpIDwgbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CgkJCWxheWVyID0gbGF5ZXJzW2ldOwoKCQkJaWYgKGxheWVyIGluc3RhbmNlb2YgTC5MYXllckdyb3VwKSB7CgkJCQl0aGlzLl9leHRyYWN0Tm9uR3JvdXBMYXllcnMobGF5ZXIsIG91dHB1dCk7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJb3V0cHV0LnB1c2gobGF5ZXIpOwoJCX0KCgkJcmV0dXJuIG91dHB1dDsKCX0sCgoJLyoqCgkgKiBJbXBsZW1lbnRzIHRoZSBzaW5nbGVNYXJrZXJNb2RlIG9wdGlvbi4KCSAqIEBwYXJhbSBsYXllciBNYXJrZXIgdG8gcmUtc3R5bGUgdXNpbmcgdGhlIENsdXN0ZXJzIGljb25DcmVhdGVGdW5jdGlvbi4KCSAqIEByZXR1cm5zIHtMLkljb259IFRoZSBuZXdseSBjcmVhdGVkIGljb24uCgkgKiBAcHJpdmF0ZQoJICovCglfb3ZlcnJpZGVNYXJrZXJJY29uOiBmdW5jdGlvbiAobGF5ZXIpIHsKCQl2YXIgaWNvbiA9IGxheWVyLm9wdGlvbnMuaWNvbiA9IHRoaXMub3B0aW9ucy5pY29uQ3JlYXRlRnVuY3Rpb24oewoJCQlnZXRDaGlsZENvdW50OiBmdW5jdGlvbiAoKSB7CgkJCQlyZXR1cm4gMTsKCQkJfSwKCQkJZ2V0QWxsQ2hpbGRNYXJrZXJzOiBmdW5jdGlvbiAoKSB7CgkJCQlyZXR1cm4gW2xheWVyXTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gaWNvbjsKCX0KfSk7CgovLyBDb25zdGFudCBib3VuZHMgdXNlZCBpbiBjYXNlIG9wdGlvbiAicmVtb3ZlT3V0c2lkZVZpc2libGVCb3VuZHMiIGlzIHNldCB0byBmYWxzZS4KTC5NYXJrZXJDbHVzdGVyR3JvdXAuaW5jbHVkZSh7CglfbWFwQm91bmRzSW5maW5pdGU6IG5ldyBMLkxhdExuZ0JvdW5kcyhuZXcgTC5MYXRMbmcoLUluZmluaXR5LCAtSW5maW5pdHkpLCBuZXcgTC5MYXRMbmcoSW5maW5pdHksIEluZmluaXR5KSkKfSk7CgpMLk1hcmtlckNsdXN0ZXJHcm91cC5pbmNsdWRlKHsKCV9ub0FuaW1hdGlvbjogewoJCS8vTm9uIEFuaW1hdGVkIHZlcnNpb25zIG9mIGV2ZXJ5dGhpbmcKCQlfYW5pbWF0aW9uU3RhcnQ6IGZ1bmN0aW9uICgpIHsKCQkJLy9EbyBub3RoaW5nLi4uCgkJfSwKCQlfYW5pbWF0aW9uWm9vbUluOiBmdW5jdGlvbiAocHJldmlvdXNab29tTGV2ZWwsIG5ld1pvb21MZXZlbCkgewoJCQl0aGlzLl90b3BDbHVzdGVyTGV2ZWwuX3JlY3Vyc2l2ZWx5UmVtb3ZlQ2hpbGRyZW5Gcm9tTWFwKHRoaXMuX2N1cnJlbnRTaG93bkJvdW5kcywgTWF0aC5mbG9vcih0aGlzLl9tYXAuZ2V0TWluWm9vbSgpKSwgcHJldmlvdXNab29tTGV2ZWwpOwoJCQl0aGlzLl90b3BDbHVzdGVyTGV2ZWwuX3JlY3Vyc2l2ZWx5QWRkQ2hpbGRyZW5Ub01hcChudWxsLCBuZXdab29tTGV2ZWwsIHRoaXMuX2dldEV4cGFuZGVkVmlzaWJsZUJvdW5kcygpKTsKCgkJCS8vV2UgZGlkbid0IGFjdHVhbGx5IGFuaW1hdGUsIGJ1dCB3ZSB1c2UgdGhpcyBldmVudCB0byBtZWFuICJjbHVzdGVyaW5nIGFuaW1hdGlvbnMgaGF2ZSBmaW5pc2hlZCIKCQkJdGhpcy5maXJlKCdhbmltYXRpb25lbmQnKTsKCQl9LAoJCV9hbmltYXRpb25ab29tT3V0OiBmdW5jdGlvbiAocHJldmlvdXNab29tTGV2ZWwsIG5ld1pvb21MZXZlbCkgewoJCQl0aGlzLl90b3BDbHVzdGVyTGV2ZWwuX3JlY3Vyc2l2ZWx5UmVtb3ZlQ2hpbGRyZW5Gcm9tTWFwKHRoaXMuX2N1cnJlbnRTaG93bkJvdW5kcywgTWF0aC5mbG9vcih0aGlzLl9tYXAuZ2V0TWluWm9vbSgpKSwgcHJldmlvdXNab29tTGV2ZWwpOwoJCQl0aGlzLl90b3BDbHVzdGVyTGV2ZWwuX3JlY3Vyc2l2ZWx5QWRkQ2hpbGRyZW5Ub01hcChudWxsLCBuZXdab29tTGV2ZWwsIHRoaXMuX2dldEV4cGFuZGVkVmlzaWJsZUJvdW5kcygpKTsKCgkJCS8vV2UgZGlkbid0IGFjdHVhbGx5IGFuaW1hdGUsIGJ1dCB3ZSB1c2UgdGhpcyBldmVudCB0byBtZWFuICJjbHVzdGVyaW5nIGFuaW1hdGlvbnMgaGF2ZSBmaW5pc2hlZCIKCQkJdGhpcy5maXJlKCdhbmltYXRpb25lbmQnKTsKCQl9LAoJCV9hbmltYXRpb25BZGRMYXllcjogZnVuY3Rpb24gKGxheWVyLCBuZXdDbHVzdGVyKSB7CgkJCXRoaXMuX2FuaW1hdGlvbkFkZExheWVyTm9uQW5pbWF0ZWQobGF5ZXIsIG5ld0NsdXN0ZXIpOwoJCX0KCX0sCgoJX3dpdGhBbmltYXRpb246IHsKCQkvL0FuaW1hdGVkIHZlcnNpb25zIGhlcmUKCQlfYW5pbWF0aW9uU3RhcnQ6IGZ1bmN0aW9uICgpIHsKCQkJdGhpcy5fbWFwLl9tYXBQYW5lLmNsYXNzTmFtZSArPSAnIGxlYWZsZXQtY2x1c3Rlci1hbmltJzsKCQkJdGhpcy5faW5ab29tQW5pbWF0aW9uKys7CgkJfSwKCgkJX2FuaW1hdGlvblpvb21JbjogZnVuY3Rpb24gKHByZXZpb3VzWm9vbUxldmVsLCBuZXdab29tTGV2ZWwpIHsKCQkJdmFyIGJvdW5kcyA9IHRoaXMuX2dldEV4cGFuZGVkVmlzaWJsZUJvdW5kcygpLAoJCQkgICAgZmcgPSB0aGlzLl9mZWF0dXJlR3JvdXAsCgkJCQltaW5ab29tID0gTWF0aC5mbG9vcih0aGlzLl9tYXAuZ2V0TWluWm9vbSgpKSwKCQkJICAgIGk7CgoJCQl0aGlzLl9pZ25vcmVNb3ZlID0gdHJ1ZTsKCgkJCS8vQWRkIGFsbCBjaGlsZHJlbiBvZiBjdXJyZW50IGNsdXN0ZXJzIHRvIG1hcCBhbmQgcmVtb3ZlIHRob3NlIGNsdXN0ZXJzIGZyb20gbWFwCgkJCXRoaXMuX3RvcENsdXN0ZXJMZXZlbC5fcmVjdXJzaXZlbHkoYm91bmRzLCBwcmV2aW91c1pvb21MZXZlbCwgbWluWm9vbSwgZnVuY3Rpb24gKGMpIHsKCQkJCXZhciBzdGFydFBvcyA9IGMuX2xhdGxuZywKCQkJCSAgICBtYXJrZXJzICA9IGMuX21hcmtlcnMsCgkJCQkgICAgbTsKCgkJCQlpZiAoIWJvdW5kcy5jb250YWlucyhzdGFydFBvcykpIHsKCQkJCQlzdGFydFBvcyA9IG51bGw7CgkJCQl9CgoJCQkJaWYgKGMuX2lzU2luZ2xlUGFyZW50KCkgJiYgcHJldmlvdXNab29tTGV2ZWwgKyAxID09PSBuZXdab29tTGV2ZWwpIHsgLy9JbW1lZGlhdGVseSBhZGQgdGhlIG5ldyBjaGlsZCBhbmQgcmVtb3ZlIHVzCgkJCQkJZmcucmVtb3ZlTGF5ZXIoYyk7CgkJCQkJYy5fcmVjdXJzaXZlbHlBZGRDaGlsZHJlblRvTWFwKG51bGwsIG5ld1pvb21MZXZlbCwgYm91bmRzKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy9GYWRlIG91dCBvbGQgY2x1c3RlcgoJCQkJCWMuY2x1c3RlckhpZGUoKTsKCQkJCQljLl9yZWN1cnNpdmVseUFkZENoaWxkcmVuVG9NYXAoc3RhcnRQb3MsIG5ld1pvb21MZXZlbCwgYm91bmRzKTsKCQkJCX0KCgkJCQkvL1JlbW92ZSBhbGwgbWFya2VycyB0aGF0IGFyZW4ndCB2aXNpYmxlIGFueSBtb3JlCgkJCQkvL1RPRE86IERvIHdlIGFjdHVhbGx5IG5lZWQgdG8gZG8gdGhpcyBvbiB0aGUgaGlnaGVyIGxldmVscyB0b28/CgkJCQlmb3IgKGkgPSBtYXJrZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQkJbSA9IG1hcmtlcnNbaV07CgkJCQkJaWYgKCFib3VuZHMuY29udGFpbnMobS5fbGF0bG5nKSkgewoJCQkJCQlmZy5yZW1vdmVMYXllcihtKTsKCQkJCQl9CgkJCQl9CgoJCQl9KTsKCgkJCXRoaXMuX2ZvcmNlTGF5b3V0KCk7CgoJCQkvL1VwZGF0ZSBvcGFjaXRpZXMKCQkJdGhpcy5fdG9wQ2x1c3RlckxldmVsLl9yZWN1cnNpdmVseUJlY29tZVZpc2libGUoYm91bmRzLCBuZXdab29tTGV2ZWwpOwoJCQkvL1RPRE8gTWF5YmU/IFVwZGF0ZSBtYXJrZXJzIGluIF9yZWN1cnNpdmVseUJlY29tZVZpc2libGUKCQkJZmcuZWFjaExheWVyKGZ1bmN0aW9uIChuKSB7CgkJCQlpZiAoIShuIGluc3RhbmNlb2YgTC5NYXJrZXJDbHVzdGVyKSAmJiBuLl9pY29uKSB7CgkJCQkJbi5jbHVzdGVyU2hvdygpOwoJCQkJfQoJCQl9KTsKCgkJCS8vdXBkYXRlIHRoZSBwb3NpdGlvbnMgb2YgdGhlIGp1c3QgYWRkZWQgY2x1c3RlcnMvbWFya2VycwoJCQl0aGlzLl90b3BDbHVzdGVyTGV2ZWwuX3JlY3Vyc2l2ZWx5KGJvdW5kcywgcHJldmlvdXNab29tTGV2ZWwsIG5ld1pvb21MZXZlbCwgZnVuY3Rpb24gKGMpIHsKCQkJCWMuX3JlY3Vyc2l2ZWx5UmVzdG9yZUNoaWxkUG9zaXRpb25zKG5ld1pvb21MZXZlbCk7CgkJCX0pOwoKCQkJdGhpcy5faWdub3JlTW92ZSA9IGZhbHNlOwoKCQkJLy9SZW1vdmUgdGhlIG9sZCBjbHVzdGVycyBhbmQgY2xvc2UgdGhlIHpvb20gYW5pbWF0aW9uCgkJCXRoaXMuX2VucXVldWUoZnVuY3Rpb24gKCkgewoJCQkJLy91cGRhdGUgdGhlIHBvc2l0aW9ucyBvZiB0aGUganVzdCBhZGRlZCBjbHVzdGVycy9tYXJrZXJzCgkJCQl0aGlzLl90b3BDbHVzdGVyTGV2ZWwuX3JlY3Vyc2l2ZWx5KGJvdW5kcywgcHJldmlvdXNab29tTGV2ZWwsIG1pblpvb20sIGZ1bmN0aW9uIChjKSB7CgkJCQkJZmcucmVtb3ZlTGF5ZXIoYyk7CgkJCQkJYy5jbHVzdGVyU2hvdygpOwoJCQkJfSk7CgoJCQkJdGhpcy5fYW5pbWF0aW9uRW5kKCk7CgkJCX0pOwoJCX0sCgoJCV9hbmltYXRpb25ab29tT3V0OiBmdW5jdGlvbiAocHJldmlvdXNab29tTGV2ZWwsIG5ld1pvb21MZXZlbCkgewoJCQl0aGlzLl9hbmltYXRpb25ab29tT3V0U2luZ2xlKHRoaXMuX3RvcENsdXN0ZXJMZXZlbCwgcHJldmlvdXNab29tTGV2ZWwgLSAxLCBuZXdab29tTGV2ZWwpOwoKCQkJLy9OZWVkIHRvIGFkZCBtYXJrZXJzIGZvciB0aG9zZSB0aGF0IHdlcmVuJ3Qgb24gdGhlIG1hcCBiZWZvcmUgYnV0IGFyZSBub3cKCQkJdGhpcy5fdG9wQ2x1c3RlckxldmVsLl9yZWN1cnNpdmVseUFkZENoaWxkcmVuVG9NYXAobnVsbCwgbmV3Wm9vbUxldmVsLCB0aGlzLl9nZXRFeHBhbmRlZFZpc2libGVCb3VuZHMoKSk7CgkJCS8vUmVtb3ZlIG1hcmtlcnMgdGhhdCB3ZXJlIG9uIHRoZSBtYXAgYmVmb3JlIGJ1dCB3b24ndCBiZSBub3cKCQkJdGhpcy5fdG9wQ2x1c3RlckxldmVsLl9yZWN1cnNpdmVseVJlbW92ZUNoaWxkcmVuRnJvbU1hcCh0aGlzLl9jdXJyZW50U2hvd25Cb3VuZHMsIE1hdGguZmxvb3IodGhpcy5fbWFwLmdldE1pblpvb20oKSksIHByZXZpb3VzWm9vbUxldmVsLCB0aGlzLl9nZXRFeHBhbmRlZFZpc2libGVCb3VuZHMoKSk7CgkJfSwKCgkJX2FuaW1hdGlvbkFkZExheWVyOiBmdW5jdGlvbiAobGF5ZXIsIG5ld0NsdXN0ZXIpIHsKCQkJdmFyIG1lID0gdGhpcywKCQkJICAgIGZnID0gdGhpcy5fZmVhdHVyZUdyb3VwOwoKCQkJZmcuYWRkTGF5ZXIobGF5ZXIpOwoJCQlpZiAobmV3Q2x1c3RlciAhPT0gbGF5ZXIpIHsKCQkJCWlmIChuZXdDbHVzdGVyLl9jaGlsZENvdW50ID4gMikgeyAvL1dhcyBhbHJlYWR5IGEgY2x1c3RlcgoKCQkJCQluZXdDbHVzdGVyLl91cGRhdGVJY29uKCk7CgkJCQkJdGhpcy5fZm9yY2VMYXlvdXQoKTsKCQkJCQl0aGlzLl9hbmltYXRpb25TdGFydCgpOwoKCQkJCQlsYXllci5fc2V0UG9zKHRoaXMuX21hcC5sYXRMbmdUb0xheWVyUG9pbnQobmV3Q2x1c3Rlci5nZXRMYXRMbmcoKSkpOwoJCQkJCWxheWVyLmNsdXN0ZXJIaWRlKCk7CgoJCQkJCXRoaXMuX2VucXVldWUoZnVuY3Rpb24gKCkgewoJCQkJCQlmZy5yZW1vdmVMYXllcihsYXllcik7CgkJCQkJCWxheWVyLmNsdXN0ZXJTaG93KCk7CgoJCQkJCQltZS5fYW5pbWF0aW9uRW5kKCk7CgkJCQkJfSk7CgoJCQkJfSBlbHNlIHsgLy9KdXN0IGJlY2FtZSBhIGNsdXN0ZXIKCQkJCQl0aGlzLl9mb3JjZUxheW91dCgpOwoKCQkJCQltZS5fYW5pbWF0aW9uU3RhcnQoKTsKCQkJCQltZS5fYW5pbWF0aW9uWm9vbU91dFNpbmdsZShuZXdDbHVzdGVyLCB0aGlzLl9tYXAuZ2V0TWF4Wm9vbSgpLCB0aGlzLl96b29tKTsKCQkJCX0KCQkJfQoJCX0KCX0sCgoJLy8gUHJpdmF0ZSBtZXRob2RzIGZvciBhbmltYXRlZCB2ZXJzaW9ucy4KCV9hbmltYXRpb25ab29tT3V0U2luZ2xlOiBmdW5jdGlvbiAoY2x1c3RlciwgcHJldmlvdXNab29tTGV2ZWwsIG5ld1pvb21MZXZlbCkgewoJCXZhciBib3VuZHMgPSB0aGlzLl9nZXRFeHBhbmRlZFZpc2libGVCb3VuZHMoKSwKCQkJbWluWm9vbSA9IE1hdGguZmxvb3IodGhpcy5fbWFwLmdldE1pblpvb20oKSk7CgoJCS8vQW5pbWF0ZSBhbGwgb2YgdGhlIG1hcmtlcnMgaW4gdGhlIGNsdXN0ZXJzIHRvIG1vdmUgdG8gdGhlaXIgY2x1c3RlciBjZW50ZXIgcG9pbnQKCQljbHVzdGVyLl9yZWN1cnNpdmVseUFuaW1hdGVDaGlsZHJlbkluQW5kQWRkU2VsZlRvTWFwKGJvdW5kcywgbWluWm9vbSwgcHJldmlvdXNab29tTGV2ZWwgKyAxLCBuZXdab29tTGV2ZWwpOwoKCQl2YXIgbWUgPSB0aGlzOwoKCQkvL1VwZGF0ZSB0aGUgb3BhY2l0eSAoSWYgd2UgaW1tZWRpYXRlbHkgc2V0IGl0IHRoZXkgd29uJ3QgYW5pbWF0ZSkKCQl0aGlzLl9mb3JjZUxheW91dCgpOwoJCWNsdXN0ZXIuX3JlY3Vyc2l2ZWx5QmVjb21lVmlzaWJsZShib3VuZHMsIG5ld1pvb21MZXZlbCk7CgoJCS8vVE9ETzogTWF5YmUgdXNlIHRoZSB0cmFuc2l0aW9uIHRpbWluZyBzdHVmZiB0byBtYWtlIHRoaXMgbW9yZSByZWxpYWJsZQoJCS8vV2hlbiB0aGUgYW5pbWF0aW9ucyBhcmUgZG9uZSwgdGlkeSB1cAoJCXRoaXMuX2VucXVldWUoZnVuY3Rpb24gKCkgewoKCQkJLy9UaGlzIGNsdXN0ZXIgc3RvcHBlZCBiZWluZyBhIGNsdXN0ZXIgYmVmb3JlIHRoZSB0aW1lb3V0IGZpcmVkCgkJCWlmIChjbHVzdGVyLl9jaGlsZENvdW50ID09PSAxKSB7CgkJCQl2YXIgbSA9IGNsdXN0ZXIuX21hcmtlcnNbMF07CgkJCQkvL0lmIHdlIHdlcmUgaW4gYSBjbHVzdGVyIGFuaW1hdGlvbiBhdCB0aGUgdGltZSB0aGVuIHRoZSBvcGFjaXR5IGFuZCBwb3NpdGlvbiBvZiBvdXIgY2hpbGQgY291bGQgYmUgd3Jvbmcgbm93LCBzbyBmaXggaXQKCQkJCXRoaXMuX2lnbm9yZU1vdmUgPSB0cnVlOwoJCQkJbS5zZXRMYXRMbmcobS5nZXRMYXRMbmcoKSk7CgkJCQl0aGlzLl9pZ25vcmVNb3ZlID0gZmFsc2U7CgkJCQlpZiAobS5jbHVzdGVyU2hvdykgewoJCQkJCW0uY2x1c3RlclNob3coKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWNsdXN0ZXIuX3JlY3Vyc2l2ZWx5KGJvdW5kcywgbmV3Wm9vbUxldmVsLCBtaW5ab29tLCBmdW5jdGlvbiAoYykgewoJCQkJCWMuX3JlY3Vyc2l2ZWx5UmVtb3ZlQ2hpbGRyZW5Gcm9tTWFwKGJvdW5kcywgbWluWm9vbSwgcHJldmlvdXNab29tTGV2ZWwgKyAxKTsKCQkJCX0pOwoJCQl9CgkJCW1lLl9hbmltYXRpb25FbmQoKTsKCQl9KTsKCX0sCgoJX2FuaW1hdGlvbkVuZDogZnVuY3Rpb24gKCkgewoJCWlmICh0aGlzLl9tYXApIHsKCQkJdGhpcy5fbWFwLl9tYXBQYW5lLmNsYXNzTmFtZSA9IHRoaXMuX21hcC5fbWFwUGFuZS5jbGFzc05hbWUucmVwbGFjZSgnIGxlYWZsZXQtY2x1c3Rlci1hbmltJywgJycpOwoJCX0KCQl0aGlzLl9pblpvb21BbmltYXRpb24tLTsKCQl0aGlzLmZpcmUoJ2FuaW1hdGlvbmVuZCcpOwoJfSwKCgkvL0ZvcmNlIGEgYnJvd3NlciBsYXlvdXQgb2Ygc3R1ZmYgaW4gdGhlIG1hcAoJLy8gU2hvdWxkIGFwcGx5IHRoZSBjdXJyZW50IG9wYWNpdHkgYW5kIGxvY2F0aW9uIHRvIGFsbCBlbGVtZW50cyBzbyB3ZSBjYW4gdXBkYXRlIHRoZW0gYWdhaW4gZm9yIGFuIGFuaW1hdGlvbgoJX2ZvcmNlTGF5b3V0OiBmdW5jdGlvbiAoKSB7CgkJLy9JbiBteSB0ZXN0aW5nIHRoaXMgd29ya3MsIGluZmFjdCBvZmZzZXRXaWR0aCBvZiBhbnkgZWxlbWVudCBzZWVtcyB0byB3b3JrLgoJCS8vQ291bGQgbG9vcCBhbGwgdGhpcy5fbGF5ZXJzIGFuZCBkbyB0aGlzIGZvciBlYWNoIF9pY29uIGlmIGl0IHN0b3BzIHdvcmtpbmcKCgkJTC5VdGlsLmZhbHNlRm4oZG9jdW1lbnQuYm9keS5vZmZzZXRXaWR0aCk7Cgl9Cn0pOwoKTC5tYXJrZXJDbHVzdGVyR3JvdXAgPSBmdW5jdGlvbiAob3B0aW9ucykgewoJcmV0dXJuIG5ldyBMLk1hcmtlckNsdXN0ZXJHcm91cChvcHRpb25zKTsKfTsKCnZhciBNYXJrZXJDbHVzdGVyID0gTC5NYXJrZXJDbHVzdGVyID0gTC5NYXJrZXIuZXh0ZW5kKHsKCW9wdGlvbnM6IEwuSWNvbi5wcm90b3R5cGUub3B0aW9ucywKCglpbml0aWFsaXplOiBmdW5jdGlvbiAoZ3JvdXAsIHpvb20sIGEsIGIpIHsKCgkJTC5NYXJrZXIucHJvdG90eXBlLmluaXRpYWxpemUuY2FsbCh0aGlzLCBhID8gKGEuX2NMYXRMbmcgfHwgYS5nZXRMYXRMbmcoKSkgOiBuZXcgTC5MYXRMbmcoMCwgMCksCiAgICAgICAgICAgIHsgaWNvbjogdGhpcywgcGFuZTogZ3JvdXAub3B0aW9ucy5jbHVzdGVyUGFuZSB9KTsKCgkJdGhpcy5fZ3JvdXAgPSBncm91cDsKCQl0aGlzLl96b29tID0gem9vbTsKCgkJdGhpcy5fbWFya2VycyA9IFtdOwoJCXRoaXMuX2NoaWxkQ2x1c3RlcnMgPSBbXTsKCQl0aGlzLl9jaGlsZENvdW50ID0gMDsKCQl0aGlzLl9pY29uTmVlZHNVcGRhdGUgPSB0cnVlOwoJCXRoaXMuX2JvdW5kc05lZWRVcGRhdGUgPSB0cnVlOwoKCQl0aGlzLl9ib3VuZHMgPSBuZXcgTC5MYXRMbmdCb3VuZHMoKTsKCgkJaWYgKGEpIHsKCQkJdGhpcy5fYWRkQ2hpbGQoYSk7CgkJfQoJCWlmIChiKSB7CgkJCXRoaXMuX2FkZENoaWxkKGIpOwoJCX0KCX0sCgoJLy9SZWN1cnNpdmVseSByZXRyaWV2ZSBhbGwgY2hpbGQgbWFya2VycyBvZiB0aGlzIGNsdXN0ZXIKCWdldEFsbENoaWxkTWFya2VyczogZnVuY3Rpb24gKHN0b3JhZ2VBcnJheSwgaWdub3JlRHJhZ2dlZE1hcmtlcikgewoJCXN0b3JhZ2VBcnJheSA9IHN0b3JhZ2VBcnJheSB8fCBbXTsKCgkJZm9yICh2YXIgaSA9IHRoaXMuX2NoaWxkQ2x1c3RlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJdGhpcy5fY2hpbGRDbHVzdGVyc1tpXS5nZXRBbGxDaGlsZE1hcmtlcnMoc3RvcmFnZUFycmF5KTsKCQl9CgoJCWZvciAodmFyIGogPSB0aGlzLl9tYXJrZXJzLmxlbmd0aCAtIDE7IGogPj0gMDsgai0tKSB7CgkJCWlmIChpZ25vcmVEcmFnZ2VkTWFya2VyICYmIHRoaXMuX21hcmtlcnNbal0uX19kcmFnU3RhcnQpIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgkJCXN0b3JhZ2VBcnJheS5wdXNoKHRoaXMuX21hcmtlcnNbal0pOwoJCX0KCgkJcmV0dXJuIHN0b3JhZ2VBcnJheTsKCX0sCgoJLy9SZXR1cm5zIHRoZSBjb3VudCBvZiBob3cgbWFueSBjaGlsZCBtYXJrZXJzIHdlIGhhdmUKCWdldENoaWxkQ291bnQ6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gdGhpcy5fY2hpbGRDb3VudDsKCX0sCgoJLy9ab29tIHRvIHRoZSBtaW5pbXVtIG9mIHNob3dpbmcgYWxsIG9mIHRoZSBjaGlsZCBtYXJrZXJzLCBvciB0aGUgZXh0ZW50cyBvZiB0aGlzIGNsdXN0ZXIKCXpvb21Ub0JvdW5kczogZnVuY3Rpb24gKGZpdEJvdW5kc09wdGlvbnMpIHsKCQl2YXIgY2hpbGRDbHVzdGVycyA9IHRoaXMuX2NoaWxkQ2x1c3RlcnMuc2xpY2UoKSwKCQkJbWFwID0gdGhpcy5fZ3JvdXAuX21hcCwKCQkJYm91bmRzWm9vbSA9IG1hcC5nZXRCb3VuZHNab29tKHRoaXMuX2JvdW5kcyksCgkJCXpvb20gPSB0aGlzLl96b29tICsgMSwKCQkJbWFwWm9vbSA9IG1hcC5nZXRab29tKCksCgkJCWk7CgoJCS8vY2FsY3VsYXRlIGhvdyBmYXIgd2UgbmVlZCB0byB6b29tIGRvd24gdG8gc2VlIGFsbCBvZiB0aGUgbWFya2VycwoJCXdoaWxlIChjaGlsZENsdXN0ZXJzLmxlbmd0aCA+IDAgJiYgYm91bmRzWm9vbSA+IHpvb20pIHsKCQkJem9vbSsrOwoJCQl2YXIgbmV3Q2x1c3RlcnMgPSBbXTsKCQkJZm9yIChpID0gMDsgaSA8IGNoaWxkQ2x1c3RlcnMubGVuZ3RoOyBpKyspIHsKCQkJCW5ld0NsdXN0ZXJzID0gbmV3Q2x1c3RlcnMuY29uY2F0KGNoaWxkQ2x1c3RlcnNbaV0uX2NoaWxkQ2x1c3RlcnMpOwoJCQl9CgkJCWNoaWxkQ2x1c3RlcnMgPSBuZXdDbHVzdGVyczsKCQl9CgoJCWlmIChib3VuZHNab29tID4gem9vbSkgewoJCQl0aGlzLl9ncm91cC5fbWFwLnNldFZpZXcodGhpcy5fbGF0bG5nLCB6b29tKTsKCQl9IGVsc2UgaWYgKGJvdW5kc1pvb20gPD0gbWFwWm9vbSkgeyAvL0lmIGZpdEJvdW5kcyB3b3VsZG4ndCB6b29tIHVzIGRvd24sIHpvb20gdXMgZG93biBpbnN0ZWFkCgkJCXRoaXMuX2dyb3VwLl9tYXAuc2V0Vmlldyh0aGlzLl9sYXRsbmcsIG1hcFpvb20gKyAxKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9ncm91cC5fbWFwLmZpdEJvdW5kcyh0aGlzLl9ib3VuZHMsIGZpdEJvdW5kc09wdGlvbnMpOwoJCX0KCX0sCgoJZ2V0Qm91bmRzOiBmdW5jdGlvbiAoKSB7CgkJdmFyIGJvdW5kcyA9IG5ldyBMLkxhdExuZ0JvdW5kcygpOwoJCWJvdW5kcy5leHRlbmQodGhpcy5fYm91bmRzKTsKCQlyZXR1cm4gYm91bmRzOwoJfSwKCglfdXBkYXRlSWNvbjogZnVuY3Rpb24gKCkgewoJCXRoaXMuX2ljb25OZWVkc1VwZGF0ZSA9IHRydWU7CgkJaWYgKHRoaXMuX2ljb24pIHsKCQkJdGhpcy5zZXRJY29uKHRoaXMpOwoJCX0KCX0sCgoJLy9DbHVkZ2UgZm9yIEljb24sIHdlIHByZXRlbmQgdG8gYmUgYW4gaWNvbiBmb3IgcGVyZm9ybWFuY2UKCWNyZWF0ZUljb246IGZ1bmN0aW9uICgpIHsKCQlpZiAodGhpcy5faWNvbk5lZWRzVXBkYXRlKSB7CgkJCXRoaXMuX2ljb25PYmogPSB0aGlzLl9ncm91cC5vcHRpb25zLmljb25DcmVhdGVGdW5jdGlvbih0aGlzKTsKCQkJdGhpcy5faWNvbk5lZWRzVXBkYXRlID0gZmFsc2U7CgkJfQoJCXJldHVybiB0aGlzLl9pY29uT2JqLmNyZWF0ZUljb24oKTsKCX0sCgljcmVhdGVTaGFkb3c6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gdGhpcy5faWNvbk9iai5jcmVhdGVTaGFkb3coKTsKCX0sCgoKCV9hZGRDaGlsZDogZnVuY3Rpb24gKG5ldzEsIGlzTm90aWZpY2F0aW9uRnJvbUNoaWxkKSB7CgoJCXRoaXMuX2ljb25OZWVkc1VwZGF0ZSA9IHRydWU7CgoJCXRoaXMuX2JvdW5kc05lZWRVcGRhdGUgPSB0cnVlOwoJCXRoaXMuX3NldENsdXN0ZXJDZW50ZXIobmV3MSk7CgoJCWlmIChuZXcxIGluc3RhbmNlb2YgTC5NYXJrZXJDbHVzdGVyKSB7CgkJCWlmICghaXNOb3RpZmljYXRpb25Gcm9tQ2hpbGQpIHsKCQkJCXRoaXMuX2NoaWxkQ2x1c3RlcnMucHVzaChuZXcxKTsKCQkJCW5ldzEuX19wYXJlbnQgPSB0aGlzOwoJCQl9CgkJCXRoaXMuX2NoaWxkQ291bnQgKz0gbmV3MS5fY2hpbGRDb3VudDsKCQl9IGVsc2UgewoJCQlpZiAoIWlzTm90aWZpY2F0aW9uRnJvbUNoaWxkKSB7CgkJCQl0aGlzLl9tYXJrZXJzLnB1c2gobmV3MSk7CgkJCX0KCQkJdGhpcy5fY2hpbGRDb3VudCsrOwoJCX0KCgkJaWYgKHRoaXMuX19wYXJlbnQpIHsKCQkJdGhpcy5fX3BhcmVudC5fYWRkQ2hpbGQobmV3MSwgdHJ1ZSk7CgkJfQoJfSwKCgkvKioKCSAqIE1ha2VzIHN1cmUgdGhlIGNsdXN0ZXIgY2VudGVyIGlzIHNldC4gSWYgbm90LCB1c2VzIHRoZSBjaGlsZCBjZW50ZXIgaWYgaXQgaXMgYSBjbHVzdGVyLCBvciB0aGUgbWFya2VyIHBvc2l0aW9uLgoJICogQHBhcmFtIGNoaWxkIEwuTWFya2VyQ2x1c3RlcnxMLk1hcmtlciB0aGF0IHdpbGwgYmUgdXNlZCBhcyBjbHVzdGVyIGNlbnRlciBpZiBub3QgZGVmaW5lZCB5ZXQuCgkgKiBAcHJpdmF0ZQoJICovCglfc2V0Q2x1c3RlckNlbnRlcjogZnVuY3Rpb24gKGNoaWxkKSB7CgkJaWYgKCF0aGlzLl9jTGF0TG5nKSB7CgkJCS8vIHdoZW4gY2x1c3RlcmluZywgdGFrZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3QgcG9pbnQgYXMgdGhlIGNsdXN0ZXIgY2VudGVyCgkJCXRoaXMuX2NMYXRMbmcgPSBjaGlsZC5fY0xhdExuZyB8fCBjaGlsZC5fbGF0bG5nOwoJCX0KCX0sCgoJLyoqCgkgKiBBc3NpZ25zIGltcG9zc2libGUgYm91bmRpbmcgdmFsdWVzIHNvIHRoYXQgdGhlIG5leHQgZXh0ZW5kIGVudGlyZWx5IGRldGVybWluZXMgdGhlIG5ldyBib3VuZHMuCgkgKiBUaGlzIG1ldGhvZCBhdm9pZHMgaGF2aW5nIHRvIHRyYXNoIHRoZSBwcmV2aW91cyBMLkxhdExuZ0JvdW5kcyBvYmplY3QgYW5kIHRvIGNyZWF0ZSBhIG5ldyBvbmUsIHdoaWNoIGlzIG11Y2ggc2xvd2VyIGZvciB0aGlzIGNsYXNzLgoJICogQXMgbG9uZyBhcyB0aGUgYm91bmRzIGFyZSBub3QgZXh0ZW5kZWQsIG1vc3Qgb3RoZXIgbWV0aG9kcyB3b3VsZCBwcm9iYWJseSBmYWlsLCBhcyB0aGV5IHdvdWxkIHdpdGggYm91bmRzIGluaXRpYWxpemVkIGJ1dCBub3QgZXh0ZW5kZWQuCgkgKiBAcHJpdmF0ZQoJICovCglfcmVzZXRCb3VuZHM6IGZ1bmN0aW9uICgpIHsKCQl2YXIgYm91bmRzID0gdGhpcy5fYm91bmRzOwoKCQlpZiAoYm91bmRzLl9zb3V0aFdlc3QpIHsKCQkJYm91bmRzLl9zb3V0aFdlc3QubGF0ID0gSW5maW5pdHk7CgkJCWJvdW5kcy5fc291dGhXZXN0LmxuZyA9IEluZmluaXR5OwoJCX0KCQlpZiAoYm91bmRzLl9ub3J0aEVhc3QpIHsKCQkJYm91bmRzLl9ub3J0aEVhc3QubGF0ID0gLUluZmluaXR5OwoJCQlib3VuZHMuX25vcnRoRWFzdC5sbmcgPSAtSW5maW5pdHk7CgkJfQoJfSwKCglfcmVjYWxjdWxhdGVCb3VuZHM6IGZ1bmN0aW9uICgpIHsKCQl2YXIgbWFya2VycyA9IHRoaXMuX21hcmtlcnMsCgkJICAgIGNoaWxkQ2x1c3RlcnMgPSB0aGlzLl9jaGlsZENsdXN0ZXJzLAoJCSAgICBsYXRTdW0gPSAwLAoJCSAgICBsbmdTdW0gPSAwLAoJCSAgICB0b3RhbENvdW50ID0gdGhpcy5fY2hpbGRDb3VudCwKCQkgICAgaSwgY2hpbGQsIGNoaWxkTGF0TG5nLCBjaGlsZENvdW50OwoKCQkvLyBDYXNlIHdoZXJlIGFsbCBtYXJrZXJzIGFyZSByZW1vdmVkIGZyb20gdGhlIG1hcCBhbmQgd2UgYXJlIGxlZnQgd2l0aCBqdXN0IGFuIGVtcHR5IF90b3BDbHVzdGVyTGV2ZWwuCgkJaWYgKHRvdGFsQ291bnQgPT09IDApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gUmVzZXQgcmF0aGVyIHRoYW4gY3JlYXRpbmcgYSBuZXcgb2JqZWN0LCBmb3IgcGVyZm9ybWFuY2UuCgkJdGhpcy5fcmVzZXRCb3VuZHMoKTsKCgkJLy8gQ2hpbGQgbWFya2Vycy4KCQlmb3IgKGkgPSAwOyBpIDwgbWFya2Vycy5sZW5ndGg7IGkrKykgewoJCQljaGlsZExhdExuZyA9IG1hcmtlcnNbaV0uX2xhdGxuZzsKCgkJCXRoaXMuX2JvdW5kcy5leHRlbmQoY2hpbGRMYXRMbmcpOwoKCQkJbGF0U3VtICs9IGNoaWxkTGF0TG5nLmxhdDsKCQkJbG5nU3VtICs9IGNoaWxkTGF0TG5nLmxuZzsKCQl9CgoJCS8vIENoaWxkIGNsdXN0ZXJzLgoJCWZvciAoaSA9IDA7IGkgPCBjaGlsZENsdXN0ZXJzLmxlbmd0aDsgaSsrKSB7CgkJCWNoaWxkID0gY2hpbGRDbHVzdGVyc1tpXTsKCgkJCS8vIFJlLWNvbXB1dGUgY2hpbGQgYm91bmRzIGFuZCB3ZWlnaHRlZCBwb3NpdGlvbiBmaXJzdCBpZiBuZWNlc3NhcnkuCgkJCWlmIChjaGlsZC5fYm91bmRzTmVlZFVwZGF0ZSkgewoJCQkJY2hpbGQuX3JlY2FsY3VsYXRlQm91bmRzKCk7CgkJCX0KCgkJCXRoaXMuX2JvdW5kcy5leHRlbmQoY2hpbGQuX2JvdW5kcyk7CgoJCQljaGlsZExhdExuZyA9IGNoaWxkLl93TGF0TG5nOwoJCQljaGlsZENvdW50ID0gY2hpbGQuX2NoaWxkQ291bnQ7CgoJCQlsYXRTdW0gKz0gY2hpbGRMYXRMbmcubGF0ICogY2hpbGRDb3VudDsKCQkJbG5nU3VtICs9IGNoaWxkTGF0TG5nLmxuZyAqIGNoaWxkQ291bnQ7CgkJfQoKCQl0aGlzLl9sYXRsbmcgPSB0aGlzLl93TGF0TG5nID0gbmV3IEwuTGF0TG5nKGxhdFN1bSAvIHRvdGFsQ291bnQsIGxuZ1N1bSAvIHRvdGFsQ291bnQpOwoKCQkvLyBSZXNldCBkaXJ0eSBmbGFnLgoJCXRoaXMuX2JvdW5kc05lZWRVcGRhdGUgPSBmYWxzZTsKCX0sCgoJLy9TZXQgb3VyIG1hcmtlcnMgcG9zaXRpb24gYXMgZ2l2ZW4gYW5kIGFkZCBpdCB0byB0aGUgbWFwCglfYWRkVG9NYXA6IGZ1bmN0aW9uIChzdGFydFBvcykgewoJCWlmIChzdGFydFBvcykgewoJCQl0aGlzLl9iYWNrdXBMYXRsbmcgPSB0aGlzLl9sYXRsbmc7CgkJCXRoaXMuc2V0TGF0TG5nKHN0YXJ0UG9zKTsKCQl9CgkJdGhpcy5fZ3JvdXAuX2ZlYXR1cmVHcm91cC5hZGRMYXllcih0aGlzKTsKCX0sCgoJX3JlY3Vyc2l2ZWx5QW5pbWF0ZUNoaWxkcmVuSW46IGZ1bmN0aW9uIChib3VuZHMsIGNlbnRlciwgbWF4Wm9vbSkgewoJCXRoaXMuX3JlY3Vyc2l2ZWx5KGJvdW5kcywgdGhpcy5fZ3JvdXAuX21hcC5nZXRNaW5ab29tKCksIG1heFpvb20gLSAxLAoJCQlmdW5jdGlvbiAoYykgewoJCQkJdmFyIG1hcmtlcnMgPSBjLl9tYXJrZXJzLAoJCQkJCWksIG07CgkJCQlmb3IgKGkgPSBtYXJrZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQkJbSA9IG1hcmtlcnNbaV07CgoJCQkJCS8vT25seSBkbyBpdCBpZiB0aGUgaWNvbiBpcyBzdGlsbCBvbiB0aGUgbWFwCgkJCQkJaWYgKG0uX2ljb24pIHsKCQkJCQkJbS5fc2V0UG9zKGNlbnRlcik7CgkJCQkJCW0uY2x1c3RlckhpZGUoKTsKCQkJCQl9CgkJCQl9CgkJCX0sCgkJCWZ1bmN0aW9uIChjKSB7CgkJCQl2YXIgY2hpbGRDbHVzdGVycyA9IGMuX2NoaWxkQ2x1c3RlcnMsCgkJCQkJaiwgY207CgkJCQlmb3IgKGogPSBjaGlsZENsdXN0ZXJzLmxlbmd0aCAtIDE7IGogPj0gMDsgai0tKSB7CgkJCQkJY20gPSBjaGlsZENsdXN0ZXJzW2pdOwoJCQkJCWlmIChjbS5faWNvbikgewoJCQkJCQljbS5fc2V0UG9zKGNlbnRlcik7CgkJCQkJCWNtLmNsdXN0ZXJIaWRlKCk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJKTsKCX0sCgoJX3JlY3Vyc2l2ZWx5QW5pbWF0ZUNoaWxkcmVuSW5BbmRBZGRTZWxmVG9NYXA6IGZ1bmN0aW9uIChib3VuZHMsIG1hcE1pblpvb20sIHByZXZpb3VzWm9vbUxldmVsLCBuZXdab29tTGV2ZWwpIHsKCQl0aGlzLl9yZWN1cnNpdmVseShib3VuZHMsIG5ld1pvb21MZXZlbCwgbWFwTWluWm9vbSwKCQkJZnVuY3Rpb24gKGMpIHsKCQkJCWMuX3JlY3Vyc2l2ZWx5QW5pbWF0ZUNoaWxkcmVuSW4oYm91bmRzLCBjLl9ncm91cC5fbWFwLmxhdExuZ1RvTGF5ZXJQb2ludChjLmdldExhdExuZygpKS5yb3VuZCgpLCBwcmV2aW91c1pvb21MZXZlbCk7CgoJCQkJLy9UT0RPOiBkZXB0aFRvQW5pbWF0ZUluIGFmZmVjdHMgX2lzU2luZ2xlUGFyZW50LCBpZiB0aGVyZSBpcyBhIG11bHRpem9vbSB3ZSBtYXkvbWF5IG5vdCBiZS4KCQkJCS8vQXMgYSBoYWNrIHdlIG9ubHkgZG8gYSBhbmltYXRpb24gZnJlZSB6b29tIG9uIGEgc2luZ2xlIGxldmVsIHpvb20sIGlmIHNvbWVvbmUgZG9lcyBtdWx0aXBsZSBsZXZlbHMgdGhlbiB3ZSBhbHdheXMgYW5pbWF0ZQoJCQkJaWYgKGMuX2lzU2luZ2xlUGFyZW50KCkgJiYgcHJldmlvdXNab29tTGV2ZWwgLSAxID09PSBuZXdab29tTGV2ZWwpIHsKCQkJCQljLmNsdXN0ZXJTaG93KCk7CgkJCQkJYy5fcmVjdXJzaXZlbHlSZW1vdmVDaGlsZHJlbkZyb21NYXAoYm91bmRzLCBtYXBNaW5ab29tLCBwcmV2aW91c1pvb21MZXZlbCk7IC8vSW1tZWRpYXRlbHkgcmVtb3ZlIG91ciBjaGlsZHJlbiBhcyB3ZSBhcmUgcmVwbGFjaW5nIHRoZW0uIFRPRE8gcHJldmlvdXNCb3VuZHMgbm90IGJvdW5kcwoJCQkJfSBlbHNlIHsKCQkJCQljLmNsdXN0ZXJIaWRlKCk7CgkJCQl9CgoJCQkJYy5fYWRkVG9NYXAoKTsKCQkJfQoJCSk7Cgl9LAoKCV9yZWN1cnNpdmVseUJlY29tZVZpc2libGU6IGZ1bmN0aW9uIChib3VuZHMsIHpvb21MZXZlbCkgewoJCXRoaXMuX3JlY3Vyc2l2ZWx5KGJvdW5kcywgdGhpcy5fZ3JvdXAuX21hcC5nZXRNaW5ab29tKCksIHpvb21MZXZlbCwgbnVsbCwgZnVuY3Rpb24gKGMpIHsKCQkJYy5jbHVzdGVyU2hvdygpOwoJCX0pOwoJfSwKCglfcmVjdXJzaXZlbHlBZGRDaGlsZHJlblRvTWFwOiBmdW5jdGlvbiAoc3RhcnRQb3MsIHpvb21MZXZlbCwgYm91bmRzKSB7CgkJdGhpcy5fcmVjdXJzaXZlbHkoYm91bmRzLCB0aGlzLl9ncm91cC5fbWFwLmdldE1pblpvb20oKSAtIDEsIHpvb21MZXZlbCwKCQkJZnVuY3Rpb24gKGMpIHsKCQkJCWlmICh6b29tTGV2ZWwgPT09IGMuX3pvb20pIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy9BZGQgb3VyIGNoaWxkIG1hcmtlcnMgYXQgc3RhcnRQb3MgKHNvIHRoZXkgY2FuIGJlIGFuaW1hdGVkIG91dCkKCQkJCWZvciAodmFyIGkgPSBjLl9tYXJrZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQkJdmFyIG5tID0gYy5fbWFya2Vyc1tpXTsKCgkJCQkJaWYgKCFib3VuZHMuY29udGFpbnMobm0uX2xhdGxuZykpIHsKCQkJCQkJY29udGludWU7CgkJCQkJfQoKCQkJCQlpZiAoc3RhcnRQb3MpIHsKCQkJCQkJbm0uX2JhY2t1cExhdGxuZyA9IG5tLmdldExhdExuZygpOwoKCQkJCQkJbm0uc2V0TGF0TG5nKHN0YXJ0UG9zKTsKCQkJCQkJaWYgKG5tLmNsdXN0ZXJIaWRlKSB7CgkJCQkJCQlubS5jbHVzdGVySGlkZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQljLl9ncm91cC5fZmVhdHVyZUdyb3VwLmFkZExheWVyKG5tKTsKCQkJCX0KCQkJfSwKCQkJZnVuY3Rpb24gKGMpIHsKCQkJCWMuX2FkZFRvTWFwKHN0YXJ0UG9zKTsKCQkJfQoJCSk7Cgl9LAoKCV9yZWN1cnNpdmVseVJlc3RvcmVDaGlsZFBvc2l0aW9uczogZnVuY3Rpb24gKHpvb21MZXZlbCkgewoJCS8vRml4IHBvc2l0aW9ucyBvZiBjaGlsZCBtYXJrZXJzCgkJZm9yICh2YXIgaSA9IHRoaXMuX21hcmtlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJdmFyIG5tID0gdGhpcy5fbWFya2Vyc1tpXTsKCQkJaWYgKG5tLl9iYWNrdXBMYXRsbmcpIHsKCQkJCW5tLnNldExhdExuZyhubS5fYmFja3VwTGF0bG5nKTsKCQkJCWRlbGV0ZSBubS5fYmFja3VwTGF0bG5nOwoJCQl9CgkJfQoKCQlpZiAoem9vbUxldmVsIC0gMSA9PT0gdGhpcy5fem9vbSkgewoJCQkvL1JlcG9zaXRpb24gY2hpbGQgY2x1c3RlcnMKCQkJZm9yICh2YXIgaiA9IHRoaXMuX2NoaWxkQ2x1c3RlcnMubGVuZ3RoIC0gMTsgaiA+PSAwOyBqLS0pIHsKCQkJCXRoaXMuX2NoaWxkQ2x1c3RlcnNbal0uX3Jlc3RvcmVQb3NpdGlvbigpOwoJCQl9CgkJfSBlbHNlIHsKCQkJZm9yICh2YXIgayA9IHRoaXMuX2NoaWxkQ2x1c3RlcnMubGVuZ3RoIC0gMTsgayA+PSAwOyBrLS0pIHsKCQkJCXRoaXMuX2NoaWxkQ2x1c3RlcnNba10uX3JlY3Vyc2l2ZWx5UmVzdG9yZUNoaWxkUG9zaXRpb25zKHpvb21MZXZlbCk7CgkJCX0KCQl9Cgl9LAoKCV9yZXN0b3JlUG9zaXRpb246IGZ1bmN0aW9uICgpIHsKCQlpZiAodGhpcy5fYmFja3VwTGF0bG5nKSB7CgkJCXRoaXMuc2V0TGF0TG5nKHRoaXMuX2JhY2t1cExhdGxuZyk7CgkJCWRlbGV0ZSB0aGlzLl9iYWNrdXBMYXRsbmc7CgkJfQoJfSwKCgkvL2V4Y2VwdEJvdW5kczogSWYgc2V0LCBkb24ndCByZW1vdmUgYW55IG1hcmtlcnMvY2x1c3RlcnMgaW4gaXQKCV9yZWN1cnNpdmVseVJlbW92ZUNoaWxkcmVuRnJvbU1hcDogZnVuY3Rpb24gKHByZXZpb3VzQm91bmRzLCBtYXBNaW5ab29tLCB6b29tTGV2ZWwsIGV4Y2VwdEJvdW5kcykgewoJCXZhciBtLCBpOwoJCXRoaXMuX3JlY3Vyc2l2ZWx5KHByZXZpb3VzQm91bmRzLCBtYXBNaW5ab29tIC0gMSwgem9vbUxldmVsIC0gMSwKCQkJZnVuY3Rpb24gKGMpIHsKCQkJCS8vUmVtb3ZlIG1hcmtlcnMgYXQgZXZlcnkgbGV2ZWwKCQkJCWZvciAoaSA9IGMuX21hcmtlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCQltID0gYy5fbWFya2Vyc1tpXTsKCQkJCQlpZiAoIWV4Y2VwdEJvdW5kcyB8fCAhZXhjZXB0Qm91bmRzLmNvbnRhaW5zKG0uX2xhdGxuZykpIHsKCQkJCQkJYy5fZ3JvdXAuX2ZlYXR1cmVHcm91cC5yZW1vdmVMYXllcihtKTsKCQkJCQkJaWYgKG0uY2x1c3RlclNob3cpIHsKCQkJCQkJCW0uY2x1c3RlclNob3coKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSwKCQkJZnVuY3Rpb24gKGMpIHsKCQkJCS8vUmVtb3ZlIGNoaWxkIGNsdXN0ZXJzIGF0IGp1c3QgdGhlIGJvdHRvbSBsZXZlbAoJCQkJZm9yIChpID0gYy5fY2hpbGRDbHVzdGVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewoJCQkJCW0gPSBjLl9jaGlsZENsdXN0ZXJzW2ldOwoJCQkJCWlmICghZXhjZXB0Qm91bmRzIHx8ICFleGNlcHRCb3VuZHMuY29udGFpbnMobS5fbGF0bG5nKSkgewoJCQkJCQljLl9ncm91cC5fZmVhdHVyZUdyb3VwLnJlbW92ZUxheWVyKG0pOwoJCQkJCQlpZiAobS5jbHVzdGVyU2hvdykgewoJCQkJCQkJbS5jbHVzdGVyU2hvdygpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgkJKTsKCX0sCgoJLy9SdW4gdGhlIGdpdmVuIGZ1bmN0aW9ucyByZWN1cnNpdmVseSB0byB0aGlzIGFuZCBjaGlsZCBjbHVzdGVycwoJLy8gYm91bmRzVG9BcHBseVRvOiBhIEwuTGF0TG5nQm91bmRzIHJlcHJlc2VudGluZyB0aGUgYm91bmRzIG9mIHdoYXQgY2x1c3RlcnMgdG8gcmVjdXJzZSBpbiB0bwoJLy8gem9vbUxldmVsVG9TdGFydDogem9vbSBsZXZlbCB0byBzdGFydCBydW5uaW5nIGZ1bmN0aW9ucyAoaW5jbHVzaXZlKQoJLy8gem9vbUxldmVsVG9TdG9wOiB6b29tIGxldmVsIHRvIHN0b3AgcnVubmluZyBmdW5jdGlvbnMgKGluY2x1c2l2ZSkKCS8vIHJ1bkF0RXZlcnlMZXZlbDogZnVuY3Rpb24gdGhhdCB0YWtlcyBhbiBMLk1hcmtlckNsdXN0ZXIgYXMgYW4gYXJndW1lbnQgdGhhdCBzaG91bGQgYmUgYXBwbGllZCBvbiBldmVyeSBsZXZlbAoJLy8gcnVuQXRCb3R0b21MZXZlbDogZnVuY3Rpb24gdGhhdCB0YWtlcyBhbiBMLk1hcmtlckNsdXN0ZXIgYXMgYW4gYXJndW1lbnQgdGhhdCBzaG91bGQgYmUgYXBwbGllZCBhdCBvbmx5IHRoZSBib3R0b20gbGV2ZWwKCV9yZWN1cnNpdmVseTogZnVuY3Rpb24gKGJvdW5kc1RvQXBwbHlUbywgem9vbUxldmVsVG9TdGFydCwgem9vbUxldmVsVG9TdG9wLCBydW5BdEV2ZXJ5TGV2ZWwsIHJ1bkF0Qm90dG9tTGV2ZWwpIHsKCQl2YXIgY2hpbGRDbHVzdGVycyA9IHRoaXMuX2NoaWxkQ2x1c3RlcnMsCgkJICAgIHpvb20gPSB0aGlzLl96b29tLAoJCSAgICBpLCBjOwoKCQlpZiAoem9vbUxldmVsVG9TdGFydCA8PSB6b29tKSB7CgkJCWlmIChydW5BdEV2ZXJ5TGV2ZWwpIHsKCQkJCXJ1bkF0RXZlcnlMZXZlbCh0aGlzKTsKCQkJfQoJCQlpZiAocnVuQXRCb3R0b21MZXZlbCAmJiB6b29tID09PSB6b29tTGV2ZWxUb1N0b3ApIHsKCQkJCXJ1bkF0Qm90dG9tTGV2ZWwodGhpcyk7CgkJCX0KCQl9CgoJCWlmICh6b29tIDwgem9vbUxldmVsVG9TdGFydCB8fCB6b29tIDwgem9vbUxldmVsVG9TdG9wKSB7CgkJCWZvciAoaSA9IGNoaWxkQ2x1c3RlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCWMgPSBjaGlsZENsdXN0ZXJzW2ldOwoJCQkJaWYgKGMuX2JvdW5kc05lZWRVcGRhdGUpIHsKCQkJCQljLl9yZWNhbGN1bGF0ZUJvdW5kcygpOwoJCQkJfQoJCQkJaWYgKGJvdW5kc1RvQXBwbHlUby5pbnRlcnNlY3RzKGMuX2JvdW5kcykpIHsKCQkJCQljLl9yZWN1cnNpdmVseShib3VuZHNUb0FwcGx5VG8sIHpvb21MZXZlbFRvU3RhcnQsIHpvb21MZXZlbFRvU3RvcCwgcnVuQXRFdmVyeUxldmVsLCBydW5BdEJvdHRvbUxldmVsKTsKCQkJCX0KCQkJfQoJCX0KCX0sCgoJLy9SZXR1cm5zIHRydWUgaWYgd2UgYXJlIHRoZSBwYXJlbnQgb2Ygb25seSBvbmUgY2x1c3RlciBhbmQgdGhhdCBjbHVzdGVyIGlzIHRoZSBzYW1lIGFzIHVzCglfaXNTaW5nbGVQYXJlbnQ6IGZ1bmN0aW9uICgpIHsKCQkvL0Rvbid0IG5lZWQgdG8gY2hlY2sgdGhpcy5fbWFya2VycyBhcyB0aGUgcmVzdCB3b24ndCB3b3JrIGlmIHRoZXJlIGFyZSBhbnkKCQlyZXR1cm4gdGhpcy5fY2hpbGRDbHVzdGVycy5sZW5ndGggPiAwICYmIHRoaXMuX2NoaWxkQ2x1c3RlcnNbMF0uX2NoaWxkQ291bnQgPT09IHRoaXMuX2NoaWxkQ291bnQ7Cgl9Cn0pOwoKLyoKKiBFeHRlbmRzIEwuTWFya2VyIHRvIGluY2x1ZGUgdHdvIGV4dHJhIG1ldGhvZHM6IGNsdXN0ZXJIaWRlIGFuZCBjbHVzdGVyU2hvdy4KKiAKKiBUaGV5IHdvcmsgYXMgc2V0T3BhY2l0eSgwKSBhbmQgc2V0T3BhY2l0eSgxKSByZXNwZWN0aXZlbHksIGJ1dAoqIGRvbid0IG92ZXJ3cml0ZSB0aGUgb3B0aW9ucy5vcGFjaXR5CiogCiovCgpMLk1hcmtlci5pbmNsdWRlKHsKCWNsdXN0ZXJIaWRlOiBmdW5jdGlvbiAoKSB7CgkJdmFyIGJhY2t1cCA9IHRoaXMub3B0aW9ucy5vcGFjaXR5OwoJCXRoaXMuc2V0T3BhY2l0eSgwKTsKCQl0aGlzLm9wdGlvbnMub3BhY2l0eSA9IGJhY2t1cDsKCQlyZXR1cm4gdGhpczsKCX0sCgkKCWNsdXN0ZXJTaG93OiBmdW5jdGlvbiAoKSB7CgkJcmV0dXJuIHRoaXMuc2V0T3BhY2l0eSh0aGlzLm9wdGlvbnMub3BhY2l0eSk7Cgl9Cn0pOwoKTC5EaXN0YW5jZUdyaWQgPSBmdW5jdGlvbiAoY2VsbFNpemUpIHsKCXRoaXMuX2NlbGxTaXplID0gY2VsbFNpemU7Cgl0aGlzLl9zcUNlbGxTaXplID0gY2VsbFNpemUgKiBjZWxsU2l6ZTsKCXRoaXMuX2dyaWQgPSB7fTsKCXRoaXMuX29iamVjdFBvaW50ID0geyB9Owp9OwoKTC5EaXN0YW5jZUdyaWQucHJvdG90eXBlID0gewoKCWFkZE9iamVjdDogZnVuY3Rpb24gKG9iaiwgcG9pbnQpIHsKCQl2YXIgeCA9IHRoaXMuX2dldENvb3JkKHBvaW50LngpLAoJCSAgICB5ID0gdGhpcy5fZ2V0Q29vcmQocG9pbnQueSksCgkJICAgIGdyaWQgPSB0aGlzLl9ncmlkLAoJCSAgICByb3cgPSBncmlkW3ldID0gZ3JpZFt5XSB8fCB7fSwKCQkgICAgY2VsbCA9IHJvd1t4XSA9IHJvd1t4XSB8fCBbXSwKCQkgICAgc3RhbXAgPSBMLlV0aWwuc3RhbXAob2JqKTsKCgkJdGhpcy5fb2JqZWN0UG9pbnRbc3RhbXBdID0gcG9pbnQ7CgoJCWNlbGwucHVzaChvYmopOwoJfSwKCgl1cGRhdGVPYmplY3Q6IGZ1bmN0aW9uIChvYmosIHBvaW50KSB7CgkJdGhpcy5yZW1vdmVPYmplY3Qob2JqKTsKCQl0aGlzLmFkZE9iamVjdChvYmosIHBvaW50KTsKCX0sCgoJLy9SZXR1cm5zIHRydWUgaWYgdGhlIG9iamVjdCB3YXMgZm91bmQKCXJlbW92ZU9iamVjdDogZnVuY3Rpb24gKG9iaiwgcG9pbnQpIHsKCQl2YXIgeCA9IHRoaXMuX2dldENvb3JkKHBvaW50LngpLAoJCSAgICB5ID0gdGhpcy5fZ2V0Q29vcmQocG9pbnQueSksCgkJICAgIGdyaWQgPSB0aGlzLl9ncmlkLAoJCSAgICByb3cgPSBncmlkW3ldID0gZ3JpZFt5XSB8fCB7fSwKCQkgICAgY2VsbCA9IHJvd1t4XSA9IHJvd1t4XSB8fCBbXSwKCQkgICAgaSwgbGVuOwoKCQlkZWxldGUgdGhpcy5fb2JqZWN0UG9pbnRbTC5VdGlsLnN0YW1wKG9iaildOwoKCQlmb3IgKGkgPSAwLCBsZW4gPSBjZWxsLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CgkJCWlmIChjZWxsW2ldID09PSBvYmopIHsKCgkJCQljZWxsLnNwbGljZShpLCAxKTsKCgkJCQlpZiAobGVuID09PSAxKSB7CgkJCQkJZGVsZXRlIHJvd1t4XTsKCQkJCX0KCgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCgl9LAoKCWVhY2hPYmplY3Q6IGZ1bmN0aW9uIChmbiwgY29udGV4dCkgewoJCXZhciBpLCBqLCBrLCBsZW4sIHJvdywgY2VsbCwgcmVtb3ZlZCwKCQkgICAgZ3JpZCA9IHRoaXMuX2dyaWQ7CgoJCWZvciAoaSBpbiBncmlkKSB7CgkJCXJvdyA9IGdyaWRbaV07CgoJCQlmb3IgKGogaW4gcm93KSB7CgkJCQljZWxsID0gcm93W2pdOwoKCQkJCWZvciAoayA9IDAsIGxlbiA9IGNlbGwubGVuZ3RoOyBrIDwgbGVuOyBrKyspIHsKCQkJCQlyZW1vdmVkID0gZm4uY2FsbChjb250ZXh0LCBjZWxsW2tdKTsKCQkJCQlpZiAocmVtb3ZlZCkgewoJCQkJCQlrLS07CgkJCQkJCWxlbi0tOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0sCgoJZ2V0TmVhck9iamVjdDogZnVuY3Rpb24gKHBvaW50KSB7CgkJdmFyIHggPSB0aGlzLl9nZXRDb29yZChwb2ludC54KSwKCQkgICAgeSA9IHRoaXMuX2dldENvb3JkKHBvaW50LnkpLAoJCSAgICBpLCBqLCBrLCByb3csIGNlbGwsIGxlbiwgb2JqLCBkaXN0LAoJCSAgICBvYmplY3RQb2ludCA9IHRoaXMuX29iamVjdFBvaW50LAoJCSAgICBjbG9zZXN0RGlzdFNxID0gdGhpcy5fc3FDZWxsU2l6ZSwKCQkgICAgY2xvc2VzdCA9IG51bGw7CgoJCWZvciAoaSA9IHkgLSAxOyBpIDw9IHkgKyAxOyBpKyspIHsKCQkJcm93ID0gdGhpcy5fZ3JpZFtpXTsKCQkJaWYgKHJvdykgewoKCQkJCWZvciAoaiA9IHggLSAxOyBqIDw9IHggKyAxOyBqKyspIHsKCQkJCQljZWxsID0gcm93W2pdOwoJCQkJCWlmIChjZWxsKSB7CgoJCQkJCQlmb3IgKGsgPSAwLCBsZW4gPSBjZWxsLmxlbmd0aDsgayA8IGxlbjsgaysrKSB7CgkJCQkJCQlvYmogPSBjZWxsW2tdOwoJCQkJCQkJZGlzdCA9IHRoaXMuX3NxRGlzdChvYmplY3RQb2ludFtMLlV0aWwuc3RhbXAob2JqKV0sIHBvaW50KTsKCQkJCQkJCWlmIChkaXN0IDwgY2xvc2VzdERpc3RTcSB8fAoJCQkJCQkJCWRpc3QgPD0gY2xvc2VzdERpc3RTcSAmJiBjbG9zZXN0ID09PSBudWxsKSB7CgkJCQkJCQkJY2xvc2VzdERpc3RTcSA9IGRpc3Q7CgkJCQkJCQkJY2xvc2VzdCA9IG9iajsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCQlyZXR1cm4gY2xvc2VzdDsKCX0sCgoJX2dldENvb3JkOiBmdW5jdGlvbiAoeCkgewoJCXZhciBjb29yZCA9IE1hdGguZmxvb3IoeCAvIHRoaXMuX2NlbGxTaXplKTsKCQlyZXR1cm4gaXNGaW5pdGUoY29vcmQpID8gY29vcmQgOiB4OwoJfSwKCglfc3FEaXN0OiBmdW5jdGlvbiAocCwgcDIpIHsKCQl2YXIgZHggPSBwMi54IC0gcC54LAoJCSAgICBkeSA9IHAyLnkgLSBwLnk7CgkJcmV0dXJuIGR4ICogZHggKyBkeSAqIGR5OwoJfQp9OwoKLyogQ29weXJpZ2h0IChjKSAyMDEyIHRoZSBhdXRob3JzIGxpc3RlZCBhdCB0aGUgZm9sbG93aW5nIFVSTCwgYW5kL29yCnRoZSBhdXRob3JzIG9mIHJlZmVyZW5jZWQgYXJ0aWNsZXMgb3IgaW5jb3Jwb3JhdGVkIGV4dGVybmFsIGNvZGU6Cmh0dHA6Ly9lbi5saXRlcmF0ZXByb2dyYW1zLm9yZy9RdWlja2h1bGxfKEphdmFzY3JpcHQpP2FjdGlvbj1oaXN0b3J5Jm9mZnNldD0yMDEyMDQxMDE3NTI1NgoKUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nCmEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQoiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCndpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvCnBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0bwp0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CgpUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZQppbmNsdWRlZCBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KClRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELApFWFBSRVNTIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULgpJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWQpDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULApUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRQpTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KClJldHJpZXZlZCBmcm9tOiBodHRwOi8vZW4ubGl0ZXJhdGVwcm9ncmFtcy5vcmcvUXVpY2todWxsXyhKYXZhc2NyaXB0KT9vbGRpZD0xODQzNAoqLwoKKGZ1bmN0aW9uICgpIHsKCUwuUXVpY2tIdWxsID0gewoKCQkvKgoJCSAqIEBwYXJhbSB7T2JqZWN0fSBjcHQgYSBwb2ludCB0byBiZSBtZWFzdXJlZCBmcm9tIHRoZSBiYXNlbGluZQoJCSAqIEBwYXJhbSB7QXJyYXl9IGJsIHRoZSBiYXNlbGluZSwgYXMgcmVwcmVzZW50ZWQgYnkgYSB0d28tZWxlbWVudAoJCSAqICAgYXJyYXkgb2YgbGF0bG5nIG9iamVjdHMuCgkJICogQHJldHVybnMge051bWJlcn0gYW4gYXBwcm94aW1hdGUgZGlzdGFuY2UgbWVhc3VyZQoJCSAqLwoJCWdldERpc3RhbnQ6IGZ1bmN0aW9uIChjcHQsIGJsKSB7CgkJCXZhciB2WSA9IGJsWzFdLmxhdCAtIGJsWzBdLmxhdCwKCQkJCXZYID0gYmxbMF0ubG5nIC0gYmxbMV0ubG5nOwoJCQlyZXR1cm4gKHZYICogKGNwdC5sYXQgLSBibFswXS5sYXQpICsgdlkgKiAoY3B0LmxuZyAtIGJsWzBdLmxuZykpOwoJCX0sCgoJCS8qCgkJICogQHBhcmFtIHtBcnJheX0gYmFzZUxpbmUgYSB0d28tZWxlbWVudCBhcnJheSBvZiBsYXRsbmcgb2JqZWN0cwoJCSAqICAgcmVwcmVzZW50aW5nIHRoZSBiYXNlbGluZSB0byBwcm9qZWN0IGZyb20KCQkgKiBAcGFyYW0ge0FycmF5fSBsYXRMbmdzIGFuIGFycmF5IG9mIGxhdGxuZyBvYmplY3RzCgkJICogQHJldHVybnMge09iamVjdH0gdGhlIG1heGltdW0gcG9pbnQgYW5kIGFsbCBuZXcgcG9pbnRzIHRvIHN0YXkKCQkgKiAgIGluIGNvbnNpZGVyYXRpb24gZm9yIHRoZSBodWxsLgoJCSAqLwoJCWZpbmRNb3N0RGlzdGFudFBvaW50RnJvbUJhc2VMaW5lOiBmdW5jdGlvbiAoYmFzZUxpbmUsIGxhdExuZ3MpIHsKCQkJdmFyIG1heEQgPSAwLAoJCQkJbWF4UHQgPSBudWxsLAoJCQkJbmV3UG9pbnRzID0gW10sCgkJCQlpLCBwdCwgZDsKCgkJCWZvciAoaSA9IGxhdExuZ3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCXB0ID0gbGF0TG5nc1tpXTsKCQkJCWQgPSB0aGlzLmdldERpc3RhbnQocHQsIGJhc2VMaW5lKTsKCgkJCQlpZiAoZCA+IDApIHsKCQkJCQluZXdQb2ludHMucHVzaChwdCk7CgkJCQl9IGVsc2UgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoKCQkJCWlmIChkID4gbWF4RCkgewoJCQkJCW1heEQgPSBkOwoJCQkJCW1heFB0ID0gcHQ7CgkJCQl9CgkJCX0KCgkJCXJldHVybiB7IG1heFBvaW50OiBtYXhQdCwgbmV3UG9pbnRzOiBuZXdQb2ludHMgfTsKCQl9LAoKCgkJLyoKCQkgKiBHaXZlbiBhIGJhc2VsaW5lLCBjb21wdXRlIHRoZSBjb252ZXggaHVsbCBvZiBsYXRMbmdzIGFzIGFuIGFycmF5CgkJICogb2YgbGF0TG5ncy4KCQkgKgoJCSAqIEBwYXJhbSB7QXJyYXl9IGxhdExuZ3MKCQkgKiBAcmV0dXJucyB7QXJyYXl9CgkJICovCgkJYnVpbGRDb252ZXhIdWxsOiBmdW5jdGlvbiAoYmFzZUxpbmUsIGxhdExuZ3MpIHsKCQkJdmFyIGNvbnZleEh1bGxCYXNlTGluZXMgPSBbXSwKCQkJCXQgPSB0aGlzLmZpbmRNb3N0RGlzdGFudFBvaW50RnJvbUJhc2VMaW5lKGJhc2VMaW5lLCBsYXRMbmdzKTsKCgkJCWlmICh0Lm1heFBvaW50KSB7IC8vIGlmIHRoZXJlIGlzIHN0aWxsIGEgcG9pbnQgIm91dHNpZGUiIHRoZSBiYXNlIGxpbmUKCQkJCWNvbnZleEh1bGxCYXNlTGluZXMgPQoJCQkJCWNvbnZleEh1bGxCYXNlTGluZXMuY29uY2F0KAoJCQkJCQl0aGlzLmJ1aWxkQ29udmV4SHVsbChbYmFzZUxpbmVbMF0sIHQubWF4UG9pbnRdLCB0Lm5ld1BvaW50cykKCQkJCQkpOwoJCQkJY29udmV4SHVsbEJhc2VMaW5lcyA9CgkJCQkJY29udmV4SHVsbEJhc2VMaW5lcy5jb25jYXQoCgkJCQkJCXRoaXMuYnVpbGRDb252ZXhIdWxsKFt0Lm1heFBvaW50LCBiYXNlTGluZVsxXV0sIHQubmV3UG9pbnRzKQoJCQkJCSk7CgkJCQlyZXR1cm4gY29udmV4SHVsbEJhc2VMaW5lczsKCQkJfSBlbHNlIHsgIC8vIGlmIHRoZXJlIGlzIG5vIG1vcmUgcG9pbnQgIm91dHNpZGUiIHRoZSBiYXNlIGxpbmUsIHRoZSBjdXJyZW50IGJhc2UgbGluZSBpcyBwYXJ0IG9mIHRoZSBjb252ZXggaHVsbAoJCQkJcmV0dXJuIFtiYXNlTGluZVswXV07CgkJCX0KCQl9LAoKCQkvKgoJCSAqIEdpdmVuIGFuIGFycmF5IG9mIGxhdGxuZ3MsIGNvbXB1dGUgYSBjb252ZXggaHVsbCBhcyBhbiBhcnJheQoJCSAqIG9mIGxhdGxuZ3MKCQkgKgoJCSAqIEBwYXJhbSB7QXJyYXl9IGxhdExuZ3MKCQkgKiBAcmV0dXJucyB7QXJyYXl9CgkJICovCgkJZ2V0Q29udmV4SHVsbDogZnVuY3Rpb24gKGxhdExuZ3MpIHsKCQkJLy8gZmluZCBmaXJzdCBiYXNlbGluZQoJCQl2YXIgbWF4TGF0ID0gZmFsc2UsIG1pbkxhdCA9IGZhbHNlLAoJCQkJbWF4TG5nID0gZmFsc2UsIG1pbkxuZyA9IGZhbHNlLAoJCQkJbWF4TGF0UHQgPSBudWxsLCBtaW5MYXRQdCA9IG51bGwsCgkJCQltYXhMbmdQdCA9IG51bGwsIG1pbkxuZ1B0ID0gbnVsbCwKCQkJCW1heFB0ID0gbnVsbCwgbWluUHQgPSBudWxsLAoJCQkJaTsKCgkJCWZvciAoaSA9IGxhdExuZ3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCXZhciBwdCA9IGxhdExuZ3NbaV07CgkJCQlpZiAobWF4TGF0ID09PSBmYWxzZSB8fCBwdC5sYXQgPiBtYXhMYXQpIHsKCQkJCQltYXhMYXRQdCA9IHB0OwoJCQkJCW1heExhdCA9IHB0LmxhdDsKCQkJCX0KCQkJCWlmIChtaW5MYXQgPT09IGZhbHNlIHx8IHB0LmxhdCA8IG1pbkxhdCkgewoJCQkJCW1pbkxhdFB0ID0gcHQ7CgkJCQkJbWluTGF0ID0gcHQubGF0OwoJCQkJfQoJCQkJaWYgKG1heExuZyA9PT0gZmFsc2UgfHwgcHQubG5nID4gbWF4TG5nKSB7CgkJCQkJbWF4TG5nUHQgPSBwdDsKCQkJCQltYXhMbmcgPSBwdC5sbmc7CgkJCQl9CgkJCQlpZiAobWluTG5nID09PSBmYWxzZSB8fCBwdC5sbmcgPCBtaW5MbmcpIHsKCQkJCQltaW5MbmdQdCA9IHB0OwoJCQkJCW1pbkxuZyA9IHB0LmxuZzsKCQkJCX0KCQkJfQoJCQkKCQkJaWYgKG1pbkxhdCAhPT0gbWF4TGF0KSB7CgkJCQltaW5QdCA9IG1pbkxhdFB0OwoJCQkJbWF4UHQgPSBtYXhMYXRQdDsKCQkJfSBlbHNlIHsKCQkJCW1pblB0ID0gbWluTG5nUHQ7CgkJCQltYXhQdCA9IG1heExuZ1B0OwoJCQl9CgoJCQl2YXIgY2ggPSBbXS5jb25jYXQodGhpcy5idWlsZENvbnZleEh1bGwoW21pblB0LCBtYXhQdF0sIGxhdExuZ3MpLAoJCQkJCQkJCXRoaXMuYnVpbGRDb252ZXhIdWxsKFttYXhQdCwgbWluUHRdLCBsYXRMbmdzKSk7CgkJCXJldHVybiBjaDsKCQl9Cgl9Owp9KCkpOwoKTC5NYXJrZXJDbHVzdGVyLmluY2x1ZGUoewoJZ2V0Q29udmV4SHVsbDogZnVuY3Rpb24gKCkgewoJCXZhciBjaGlsZE1hcmtlcnMgPSB0aGlzLmdldEFsbENoaWxkTWFya2VycygpLAoJCQlwb2ludHMgPSBbXSwKCQkJcCwgaTsKCgkJZm9yIChpID0gY2hpbGRNYXJrZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCXAgPSBjaGlsZE1hcmtlcnNbaV0uZ2V0TGF0TG5nKCk7CgkJCXBvaW50cy5wdXNoKHApOwoJCX0KCgkJcmV0dXJuIEwuUXVpY2tIdWxsLmdldENvbnZleEh1bGwocG9pbnRzKTsKCX0KfSk7CgovL1RoaXMgY29kZSBpcyAxMDAlIGJhc2VkIG9uIGh0dHBzOi8vZ2l0aHViLmNvbS9qYXdqL092ZXJsYXBwaW5nTWFya2VyU3BpZGVyZmllci1MZWFmbGV0Ci8vSHVnZSB0aGFua3MgdG8gamF3aiBmb3IgaW1wbGVtZW50aW5nIGl0IGZpcnN0IHRvIG1ha2UgbXkgam9iIGVhc3kgOi0pCgpMLk1hcmtlckNsdXN0ZXIuaW5jbHVkZSh7CgoJXzJQSTogTWF0aC5QSSAqIDIsCglfY2lyY2xlRm9vdFNlcGFyYXRpb246IDI1LCAvL3JlbGF0ZWQgdG8gY2lyY3VtZmVyZW5jZSBvZiBjaXJjbGUKCV9jaXJjbGVTdGFydEFuZ2xlOiAwLAoKCV9zcGlyYWxGb290U2VwYXJhdGlvbjogIDI4LCAvL3JlbGF0ZWQgdG8gc2l6ZSBvZiBzcGlyYWwgKGV4cGVyaW1lbnQhKQoJX3NwaXJhbExlbmd0aFN0YXJ0OiAxMSwKCV9zcGlyYWxMZW5ndGhGYWN0b3I6IDUsCgoJX2NpcmNsZVNwaXJhbFN3aXRjaG92ZXI6IDksIC8vc2hvdyBzcGlyYWwgaW5zdGVhZCBvZiBjaXJjbGUgZnJvbSB0aGlzIG1hcmtlciBjb3VudCB1cHdhcmRzLgoJCQkJCQkJCS8vIDAgLT4gYWx3YXlzIHNwaXJhbDsgSW5maW5pdHkgLT4gYWx3YXlzIGNpcmNsZQoKCXNwaWRlcmZ5OiBmdW5jdGlvbiAoKSB7CgkJaWYgKHRoaXMuX2dyb3VwLl9zcGlkZXJmaWVkID09PSB0aGlzIHx8IHRoaXMuX2dyb3VwLl9pblpvb21BbmltYXRpb24pIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGNoaWxkTWFya2VycyA9IHRoaXMuZ2V0QWxsQ2hpbGRNYXJrZXJzKG51bGwsIHRydWUpLAoJCQlncm91cCA9IHRoaXMuX2dyb3VwLAoJCQltYXAgPSBncm91cC5fbWFwLAoJCQljZW50ZXIgPSBtYXAubGF0TG5nVG9MYXllclBvaW50KHRoaXMuX2xhdGxuZyksCgkJCXBvc2l0aW9uczsKCgkJdGhpcy5fZ3JvdXAuX3Vuc3BpZGVyZnkoKTsKCQl0aGlzLl9ncm91cC5fc3BpZGVyZmllZCA9IHRoaXM7CgoJCS8vVE9ETyBNYXliZTogY2hpbGRNYXJrZXJzIG9yZGVyIGJ5IGRpc3RhbmNlIHRvIGNlbnRlcgoKCQlpZiAoY2hpbGRNYXJrZXJzLmxlbmd0aCA+PSB0aGlzLl9jaXJjbGVTcGlyYWxTd2l0Y2hvdmVyKSB7CgkJCXBvc2l0aW9ucyA9IHRoaXMuX2dlbmVyYXRlUG9pbnRzU3BpcmFsKGNoaWxkTWFya2Vycy5sZW5ndGgsIGNlbnRlcik7CgkJfSBlbHNlIHsKCQkJY2VudGVyLnkgKz0gMTA7IC8vIE90aGVyd2lzZSBjaXJjbGVzIGxvb2sgd3JvbmcgPT4gaGFjayBmb3Igc3RhbmRhcmQgYmx1ZSBpY29uLCByZW5kZXJzIGRpZmZlcmVudGx5IGZvciBvdGhlciBpY29ucy4KCQkJcG9zaXRpb25zID0gdGhpcy5fZ2VuZXJhdGVQb2ludHNDaXJjbGUoY2hpbGRNYXJrZXJzLmxlbmd0aCwgY2VudGVyKTsKCQl9CgoJCXRoaXMuX2FuaW1hdGlvblNwaWRlcmZ5KGNoaWxkTWFya2VycywgcG9zaXRpb25zKTsKCX0sCgoJdW5zcGlkZXJmeTogZnVuY3Rpb24gKHpvb21EZXRhaWxzKSB7CgkJLy8vIDxwYXJhbSBOYW1lPSJ6b29tRGV0YWlscyI+QXJndW1lbnQgZnJvbSB6b29tYW5pbSBpZiBiZWluZyBjYWxsZWQgaW4gYSB6b29tIGFuaW1hdGlvbiBvciBudWxsIG90aGVyd2lzZTwvcGFyYW0+CgkJaWYgKHRoaXMuX2dyb3VwLl9pblpvb21BbmltYXRpb24pIHsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9hbmltYXRpb25VbnNwaWRlcmZ5KHpvb21EZXRhaWxzKTsKCgkJdGhpcy5fZ3JvdXAuX3NwaWRlcmZpZWQgPSBudWxsOwoJfSwKCglfZ2VuZXJhdGVQb2ludHNDaXJjbGU6IGZ1bmN0aW9uIChjb3VudCwgY2VudGVyUHQpIHsKCQl2YXIgY2lyY3VtZmVyZW5jZSA9IHRoaXMuX2dyb3VwLm9wdGlvbnMuc3BpZGVyZnlEaXN0YW5jZU11bHRpcGxpZXIgKiB0aGlzLl9jaXJjbGVGb290U2VwYXJhdGlvbiAqICgyICsgY291bnQpLAoJCQlsZWdMZW5ndGggPSBjaXJjdW1mZXJlbmNlIC8gdGhpcy5fMlBJLCAgLy9yYWRpdXMgZnJvbSBjaXJjdW1mZXJlbmNlCgkJCWFuZ2xlU3RlcCA9IHRoaXMuXzJQSSAvIGNvdW50LAoJCQlyZXMgPSBbXSwKCQkJaSwgYW5nbGU7CgoJCWxlZ0xlbmd0aCA9IE1hdGgubWF4KGxlZ0xlbmd0aCwgMzUpOyAvLyBNaW5pbXVtIGRpc3RhbmNlIHRvIGdldCBvdXRzaWRlIHRoZSBjbHVzdGVyIGljb24uCgoJCXJlcy5sZW5ndGggPSBjb3VudDsKCgkJZm9yIChpID0gMDsgaSA8IGNvdW50OyBpKyspIHsgLy8gQ2xvY2t3aXNlLCBsaWtlIHNwaXJhbC4KCQkJYW5nbGUgPSB0aGlzLl9jaXJjbGVTdGFydEFuZ2xlICsgaSAqIGFuZ2xlU3RlcDsKCQkJcmVzW2ldID0gbmV3IEwuUG9pbnQoY2VudGVyUHQueCArIGxlZ0xlbmd0aCAqIE1hdGguY29zKGFuZ2xlKSwgY2VudGVyUHQueSArIGxlZ0xlbmd0aCAqIE1hdGguc2luKGFuZ2xlKSkuX3JvdW5kKCk7CgkJfQoKCQlyZXR1cm4gcmVzOwoJfSwKCglfZ2VuZXJhdGVQb2ludHNTcGlyYWw6IGZ1bmN0aW9uIChjb3VudCwgY2VudGVyUHQpIHsKCQl2YXIgc3BpZGVyZnlEaXN0YW5jZU11bHRpcGxpZXIgPSB0aGlzLl9ncm91cC5vcHRpb25zLnNwaWRlcmZ5RGlzdGFuY2VNdWx0aXBsaWVyLAoJCQlsZWdMZW5ndGggPSBzcGlkZXJmeURpc3RhbmNlTXVsdGlwbGllciAqIHRoaXMuX3NwaXJhbExlbmd0aFN0YXJ0LAoJCQlzZXBhcmF0aW9uID0gc3BpZGVyZnlEaXN0YW5jZU11bHRpcGxpZXIgKiB0aGlzLl9zcGlyYWxGb290U2VwYXJhdGlvbiwKCQkJbGVuZ3RoRmFjdG9yID0gc3BpZGVyZnlEaXN0YW5jZU11bHRpcGxpZXIgKiB0aGlzLl9zcGlyYWxMZW5ndGhGYWN0b3IgKiB0aGlzLl8yUEksCgkJCWFuZ2xlID0gMCwKCQkJcmVzID0gW10sCgkJCWk7CgoJCXJlcy5sZW5ndGggPSBjb3VudDsKCgkJLy8gSGlnaGVyIGluZGV4LCBjbG9zZXIgcG9zaXRpb24gdG8gY2x1c3RlciBjZW50ZXIuCgkJZm9yIChpID0gY291bnQ7IGkgPj0gMDsgaS0tKSB7CgkJCS8vIFNraXAgdGhlIGZpcnN0IHBvc2l0aW9uLCBzbyB0aGF0IHdlIGFyZSBhbHJlYWR5IGZhcnRoZXIgZnJvbSBjZW50ZXIgYW5kIHdlIGF2b2lkCgkJCS8vIGJlaW5nIHVuZGVyIHRoZSBkZWZhdWx0IGNsdXN0ZXIgaWNvbiAoZXNwZWNpYWxseSBpbXBvcnRhbnQgZm9yIENpcmNsZSBNYXJrZXJzKS4KCQkJaWYgKGkgPCBjb3VudCkgewoJCQkJcmVzW2ldID0gbmV3IEwuUG9pbnQoY2VudGVyUHQueCArIGxlZ0xlbmd0aCAqIE1hdGguY29zKGFuZ2xlKSwgY2VudGVyUHQueSArIGxlZ0xlbmd0aCAqIE1hdGguc2luKGFuZ2xlKSkuX3JvdW5kKCk7CgkJCX0KCQkJYW5nbGUgKz0gc2VwYXJhdGlvbiAvIGxlZ0xlbmd0aCArIGkgKiAwLjAwMDU7CgkJCWxlZ0xlbmd0aCArPSBsZW5ndGhGYWN0b3IgLyBhbmdsZTsKCQl9CgkJcmV0dXJuIHJlczsKCX0sCgoJX25vYW5pbWF0aW9uVW5zcGlkZXJmeTogZnVuY3Rpb24gKCkgewoJCXZhciBncm91cCA9IHRoaXMuX2dyb3VwLAoJCQltYXAgPSBncm91cC5fbWFwLAoJCQlmZyA9IGdyb3VwLl9mZWF0dXJlR3JvdXAsCgkJCWNoaWxkTWFya2VycyA9IHRoaXMuZ2V0QWxsQ2hpbGRNYXJrZXJzKG51bGwsIHRydWUpLAoJCQltLCBpOwoKCQlncm91cC5faWdub3JlTW92ZSA9IHRydWU7CgoJCXRoaXMuc2V0T3BhY2l0eSgxKTsKCQlmb3IgKGkgPSBjaGlsZE1hcmtlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJbSA9IGNoaWxkTWFya2Vyc1tpXTsKCgkJCWZnLnJlbW92ZUxheWVyKG0pOwoKCQkJaWYgKG0uX3ByZVNwaWRlcmZ5TGF0bG5nKSB7CgkJCQltLnNldExhdExuZyhtLl9wcmVTcGlkZXJmeUxhdGxuZyk7CgkJCQlkZWxldGUgbS5fcHJlU3BpZGVyZnlMYXRsbmc7CgkJCX0KCQkJaWYgKG0uc2V0WkluZGV4T2Zmc2V0KSB7CgkJCQltLnNldFpJbmRleE9mZnNldCgwKTsKCQkJfQoKCQkJaWYgKG0uX3NwaWRlckxlZykgewoJCQkJbWFwLnJlbW92ZUxheWVyKG0uX3NwaWRlckxlZyk7CgkJCQlkZWxldGUgbS5fc3BpZGVyTGVnOwoJCQl9CgkJfQoKCQlncm91cC5maXJlKCd1bnNwaWRlcmZpZWQnLCB7CgkJCWNsdXN0ZXI6IHRoaXMsCgkJCW1hcmtlcnM6IGNoaWxkTWFya2VycwoJCX0pOwoJCWdyb3VwLl9pZ25vcmVNb3ZlID0gZmFsc2U7CgkJZ3JvdXAuX3NwaWRlcmZpZWQgPSBudWxsOwoJfQp9KTsKCi8vTm9uIEFuaW1hdGVkIHZlcnNpb25zIG9mIGV2ZXJ5dGhpbmcKTC5NYXJrZXJDbHVzdGVyTm9uQW5pbWF0ZWQgPSBMLk1hcmtlckNsdXN0ZXIuZXh0ZW5kKHsKCV9hbmltYXRpb25TcGlkZXJmeTogZnVuY3Rpb24gKGNoaWxkTWFya2VycywgcG9zaXRpb25zKSB7CgkJdmFyIGdyb3VwID0gdGhpcy5fZ3JvdXAsCgkJCW1hcCA9IGdyb3VwLl9tYXAsCgkJCWZnID0gZ3JvdXAuX2ZlYXR1cmVHcm91cCwKCQkJbGVnT3B0aW9ucyA9IHRoaXMuX2dyb3VwLm9wdGlvbnMuc3BpZGVyTGVnUG9seWxpbmVPcHRpb25zLAoJCQlpLCBtLCBsZWcsIG5ld1BvczsKCgkJZ3JvdXAuX2lnbm9yZU1vdmUgPSB0cnVlOwoKCQkvLyBUcmF2ZXJzZSBpbiBhc2NlbmRpbmcgb3JkZXIgdG8gbWFrZSBzdXJlIHRoYXQgaW5uZXIgY2lyY2xlTWFya2VycyBhcmUgb24gdG9wIG9mIGZ1cnRoZXIgbGVncy4gTm9ybWFsIG1hcmtlcnMgYXJlIHJlLW9yZGVyZWQgYnkgbmV3UG9zaXRpb24uCgkJLy8gVGhlIHJldmVyc2Ugb3JkZXIgdHJpY2sgbm8gbG9uZ2VyIGltcHJvdmVzIHBlcmZvcm1hbmNlIG9uIG1vZGVybiBicm93c2Vycy4KCQlmb3IgKGkgPSAwOyBpIDwgY2hpbGRNYXJrZXJzLmxlbmd0aDsgaSsrKSB7CgkJCW5ld1BvcyA9IG1hcC5sYXllclBvaW50VG9MYXRMbmcocG9zaXRpb25zW2ldKTsKCQkJbSA9IGNoaWxkTWFya2Vyc1tpXTsKCgkJCS8vIEFkZCB0aGUgbGVnIGJlZm9yZSB0aGUgbWFya2VyLCBzbyB0aGF0IGluIGNhc2UgdGhlIGxhdHRlciBpcyBhIGNpcmNsZU1hcmtlciwgdGhlIGxlZyBpcyBiZWhpbmQgaXQuCgkJCWxlZyA9IG5ldyBMLlBvbHlsaW5lKFt0aGlzLl9sYXRsbmcsIG5ld1Bvc10sIGxlZ09wdGlvbnMpOwoJCQltYXAuYWRkTGF5ZXIobGVnKTsKCQkJbS5fc3BpZGVyTGVnID0gbGVnOwoKCQkJLy8gTm93IGFkZCB0aGUgbWFya2VyLgoJCQltLl9wcmVTcGlkZXJmeUxhdGxuZyA9IG0uX2xhdGxuZzsKCQkJbS5zZXRMYXRMbmcobmV3UG9zKTsKCQkJaWYgKG0uc2V0WkluZGV4T2Zmc2V0KSB7CgkJCQltLnNldFpJbmRleE9mZnNldCgxMDAwMDAwKTsgLy9NYWtlIHRoZXNlIGFwcGVhciBvbiB0b3Agb2YgRVZFUllUSElORwoJCQl9CgoJCQlmZy5hZGRMYXllcihtKTsKCQl9CgkJdGhpcy5zZXRPcGFjaXR5KDAuMyk7CgoJCWdyb3VwLl9pZ25vcmVNb3ZlID0gZmFsc2U7CgkJZ3JvdXAuZmlyZSgnc3BpZGVyZmllZCcsIHsKCQkJY2x1c3RlcjogdGhpcywKCQkJbWFya2VyczogY2hpbGRNYXJrZXJzCgkJfSk7Cgl9LAoKCV9hbmltYXRpb25VbnNwaWRlcmZ5OiBmdW5jdGlvbiAoKSB7CgkJdGhpcy5fbm9hbmltYXRpb25VbnNwaWRlcmZ5KCk7Cgl9Cn0pOwoKLy9BbmltYXRlZCB2ZXJzaW9ucyBoZXJlCkwuTWFya2VyQ2x1c3Rlci5pbmNsdWRlKHsKCglfYW5pbWF0aW9uU3BpZGVyZnk6IGZ1bmN0aW9uIChjaGlsZE1hcmtlcnMsIHBvc2l0aW9ucykgewoJCXZhciBtZSA9IHRoaXMsCgkJCWdyb3VwID0gdGhpcy5fZ3JvdXAsCgkJCW1hcCA9IGdyb3VwLl9tYXAsCgkJCWZnID0gZ3JvdXAuX2ZlYXR1cmVHcm91cCwKCQkJdGhpc0xheWVyTGF0TG5nID0gdGhpcy5fbGF0bG5nLAoJCQl0aGlzTGF5ZXJQb3MgPSBtYXAubGF0TG5nVG9MYXllclBvaW50KHRoaXNMYXllckxhdExuZyksCgkJCXN2ZyA9IEwuUGF0aC5TVkcsCgkJCWxlZ09wdGlvbnMgPSBMLmV4dGVuZCh7fSwgdGhpcy5fZ3JvdXAub3B0aW9ucy5zcGlkZXJMZWdQb2x5bGluZU9wdGlvbnMpLCAvLyBDb3B5IHRoZSBvcHRpb25zIHNvIHRoYXQgd2UgY2FuIG1vZGlmeSB0aGVtIGZvciBhbmltYXRpb24uCgkJCWZpbmFsTGVnT3BhY2l0eSA9IGxlZ09wdGlvbnMub3BhY2l0eSwKCQkJaSwgbSwgbGVnLCBsZWdQYXRoLCBsZWdMZW5ndGgsIG5ld1BvczsKCgkJaWYgKGZpbmFsTGVnT3BhY2l0eSA9PT0gdW5kZWZpbmVkKSB7CgkJCWZpbmFsTGVnT3BhY2l0eSA9IEwuTWFya2VyQ2x1c3Rlckdyb3VwLnByb3RvdHlwZS5vcHRpb25zLnNwaWRlckxlZ1BvbHlsaW5lT3B0aW9ucy5vcGFjaXR5OwoJCX0KCgkJaWYgKHN2ZykgewoJCQkvLyBJZiB0aGUgaW5pdGlhbCBvcGFjaXR5IG9mIHRoZSBzcGlkZXIgbGVnIGlzIG5vdCAwIHRoZW4gaXQgYXBwZWFycyBiZWZvcmUgdGhlIGFuaW1hdGlvbiBzdGFydHMuCgkJCWxlZ09wdGlvbnMub3BhY2l0eSA9IDA7CgoJCQkvLyBBZGQgdGhlIGNsYXNzIGZvciBDU1MgdHJhbnNpdGlvbnMuCgkJCWxlZ09wdGlvbnMuY2xhc3NOYW1lID0gKGxlZ09wdGlvbnMuY2xhc3NOYW1lIHx8ICcnKSArICcgbGVhZmxldC1jbHVzdGVyLXNwaWRlci1sZWcnOwoJCX0gZWxzZSB7CgkJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZGVmaW5lZCBvcGFjaXR5LgoJCQlsZWdPcHRpb25zLm9wYWNpdHkgPSBmaW5hbExlZ09wYWNpdHk7CgkJfQoKCQlncm91cC5faWdub3JlTW92ZSA9IHRydWU7CgoJCS8vIEFkZCBtYXJrZXJzIGFuZCBzcGlkZXIgbGVncyB0byBtYXAsIGhpZGRlbiBhdCBvdXIgY2VudGVyIHBvaW50LgoJCS8vIFRyYXZlcnNlIGluIGFzY2VuZGluZyBvcmRlciB0byBtYWtlIHN1cmUgdGhhdCBpbm5lciBjaXJjbGVNYXJrZXJzIGFyZSBvbiB0b3Agb2YgZnVydGhlciBsZWdzLiBOb3JtYWwgbWFya2VycyBhcmUgcmUtb3JkZXJlZCBieSBuZXdQb3NpdGlvbi4KCQkvLyBUaGUgcmV2ZXJzZSBvcmRlciB0cmljayBubyBsb25nZXIgaW1wcm92ZXMgcGVyZm9ybWFuY2Ugb24gbW9kZXJuIGJyb3dzZXJzLgoJCWZvciAoaSA9IDA7IGkgPCBjaGlsZE1hcmtlcnMubGVuZ3RoOyBpKyspIHsKCQkJbSA9IGNoaWxkTWFya2Vyc1tpXTsKCgkJCW5ld1BvcyA9IG1hcC5sYXllclBvaW50VG9MYXRMbmcocG9zaXRpb25zW2ldKTsKCgkJCS8vIEFkZCB0aGUgbGVnIGJlZm9yZSB0aGUgbWFya2VyLCBzbyB0aGF0IGluIGNhc2UgdGhlIGxhdHRlciBpcyBhIGNpcmNsZU1hcmtlciwgdGhlIGxlZyBpcyBiZWhpbmQgaXQuCgkJCWxlZyA9IG5ldyBMLlBvbHlsaW5lKFt0aGlzTGF5ZXJMYXRMbmcsIG5ld1Bvc10sIGxlZ09wdGlvbnMpOwoJCQltYXAuYWRkTGF5ZXIobGVnKTsKCQkJbS5fc3BpZGVyTGVnID0gbGVnOwoKCQkJLy8gRXhwbGFuYXRpb25zOiBodHRwczovL2pha2VhcmNoaWJhbGQuY29tLzIwMTMvYW5pbWF0ZWQtbGluZS1kcmF3aW5nLXN2Zy8KCQkJLy8gSW4gb3VyIGNhc2UgdGhlIHRyYW5zaXRpb24gcHJvcGVydHkgaXMgZGVjbGFyZWQgaW4gdGhlIENTUyBmaWxlLgoJCQlpZiAoc3ZnKSB7CgkJCQlsZWdQYXRoID0gbGVnLl9wYXRoOwoJCQkJbGVnTGVuZ3RoID0gbGVnUGF0aC5nZXRUb3RhbExlbmd0aCgpICsgMC4xOyAvLyBOZWVkIGEgc21hbGwgZXh0cmEgbGVuZ3RoIHRvIGF2b2lkIHJlbWFpbmluZyBkb3QgaW4gRmlyZWZveC4KCQkJCWxlZ1BhdGguc3R5bGUuc3Ryb2tlRGFzaGFycmF5ID0gbGVnTGVuZ3RoOyAvLyBKdXN0IDEgbGVuZ3RoIGlzIGVub3VnaCwgaXQgd2lsbCBiZSBkdXBsaWNhdGVkLgoJCQkJbGVnUGF0aC5zdHlsZS5zdHJva2VEYXNob2Zmc2V0ID0gbGVnTGVuZ3RoOwoJCQl9CgoJCQkvLyBJZiBpdCBpcyBhIG1hcmtlciwgYWRkIGl0IG5vdyBhbmQgd2UnbGwgYW5pbWF0ZSBpdCBvdXQKCQkJaWYgKG0uc2V0WkluZGV4T2Zmc2V0KSB7CgkJCQltLnNldFpJbmRleE9mZnNldCgxMDAwMDAwKTsgLy8gTWFrZSBub3JtYWwgbWFya2VycyBhcHBlYXIgb24gdG9wIG9mIEVWRVJZVEhJTkcKCQkJfQoJCQlpZiAobS5jbHVzdGVySGlkZSkgewoJCQkJbS5jbHVzdGVySGlkZSgpOwoJCQl9CgkJCQoJCQkvLyBWZWN0b3JzIGp1c3QgZ2V0IGltbWVkaWF0ZWx5IGFkZGVkCgkJCWZnLmFkZExheWVyKG0pOwoKCQkJaWYgKG0uX3NldFBvcykgewoJCQkJbS5fc2V0UG9zKHRoaXNMYXllclBvcyk7CgkJCX0KCQl9CgoJCWdyb3VwLl9mb3JjZUxheW91dCgpOwoJCWdyb3VwLl9hbmltYXRpb25TdGFydCgpOwoKCQkvLyBSZXZlYWwgbWFya2VycyBhbmQgc3BpZGVyIGxlZ3MuCgkJZm9yIChpID0gY2hpbGRNYXJrZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCW5ld1BvcyA9IG1hcC5sYXllclBvaW50VG9MYXRMbmcocG9zaXRpb25zW2ldKTsKCQkJbSA9IGNoaWxkTWFya2Vyc1tpXTsKCgkJCS8vTW92ZSBtYXJrZXIgdG8gbmV3IHBvc2l0aW9uCgkJCW0uX3ByZVNwaWRlcmZ5TGF0bG5nID0gbS5fbGF0bG5nOwoJCQltLnNldExhdExuZyhuZXdQb3MpOwoJCQkKCQkJaWYgKG0uY2x1c3RlclNob3cpIHsKCQkJCW0uY2x1c3RlclNob3coKTsKCQkJfQoKCQkJLy8gQW5pbWF0ZSBsZWcgKGFuaW1hdGlvbiBpcyBhY3R1YWxseSBkZWxlZ2F0ZWQgdG8gQ1NTIHRyYW5zaXRpb24pLgoJCQlpZiAoc3ZnKSB7CgkJCQlsZWcgPSBtLl9zcGlkZXJMZWc7CgkJCQlsZWdQYXRoID0gbGVnLl9wYXRoOwoJCQkJbGVnUGF0aC5zdHlsZS5zdHJva2VEYXNob2Zmc2V0ID0gMDsKCQkJCS8vbGVnUGF0aC5zdHlsZS5zdHJva2VPcGFjaXR5ID0gZmluYWxMZWdPcGFjaXR5OwoJCQkJbGVnLnNldFN0eWxlKHtvcGFjaXR5OiBmaW5hbExlZ09wYWNpdHl9KTsKCQkJfQoJCX0KCQl0aGlzLnNldE9wYWNpdHkoMC4zKTsKCgkJZ3JvdXAuX2lnbm9yZU1vdmUgPSBmYWxzZTsKCgkJc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CgkJCWdyb3VwLl9hbmltYXRpb25FbmQoKTsKCQkJZ3JvdXAuZmlyZSgnc3BpZGVyZmllZCcsIHsKCQkJCWNsdXN0ZXI6IG1lLAoJCQkJbWFya2VyczogY2hpbGRNYXJrZXJzCgkJCX0pOwoJCX0sIDIwMCk7Cgl9LAoKCV9hbmltYXRpb25VbnNwaWRlcmZ5OiBmdW5jdGlvbiAoem9vbURldGFpbHMpIHsKCQl2YXIgbWUgPSB0aGlzLAoJCQlncm91cCA9IHRoaXMuX2dyb3VwLAoJCQltYXAgPSBncm91cC5fbWFwLAoJCQlmZyA9IGdyb3VwLl9mZWF0dXJlR3JvdXAsCgkJCXRoaXNMYXllclBvcyA9IHpvb21EZXRhaWxzID8gbWFwLl9sYXRMbmdUb05ld0xheWVyUG9pbnQodGhpcy5fbGF0bG5nLCB6b29tRGV0YWlscy56b29tLCB6b29tRGV0YWlscy5jZW50ZXIpIDogbWFwLmxhdExuZ1RvTGF5ZXJQb2ludCh0aGlzLl9sYXRsbmcpLAoJCQljaGlsZE1hcmtlcnMgPSB0aGlzLmdldEFsbENoaWxkTWFya2VycyhudWxsLCB0cnVlKSwKCQkJc3ZnID0gTC5QYXRoLlNWRywKCQkJbSwgaSwgbGVnLCBsZWdQYXRoLCBsZWdMZW5ndGgsIG5vbkFuaW1hdGFibGU7CgoJCWdyb3VwLl9pZ25vcmVNb3ZlID0gdHJ1ZTsKCQlncm91cC5fYW5pbWF0aW9uU3RhcnQoKTsKCgkJLy9NYWtlIHVzIHZpc2libGUgYW5kIGJyaW5nIHRoZSBjaGlsZCBtYXJrZXJzIGJhY2sgaW4KCQl0aGlzLnNldE9wYWNpdHkoMSk7CgkJZm9yIChpID0gY2hpbGRNYXJrZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCW0gPSBjaGlsZE1hcmtlcnNbaV07CgoJCQkvL01hcmtlciB3YXMgYWRkZWQgdG8gdXMgYWZ0ZXIgd2Ugd2VyZSBzcGlkZXJmaWVkCgkJCWlmICghbS5fcHJlU3BpZGVyZnlMYXRsbmcpIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQkvL0Nsb3NlIGFueSBwb3B1cCBvbiB0aGUgbWFya2VyIGZpcnN0LCBvdGhlcndpc2Ugc2V0dGluZyB0aGUgbG9jYXRpb24gb2YgdGhlIG1hcmtlciB3aWxsIG1ha2UgdGhlIG1hcCBzY3JvbGwKCQkJbS5jbG9zZVBvcHVwKCk7CgoJCQkvL0ZpeCB1cCB0aGUgbG9jYXRpb24gdG8gdGhlIHJlYWwgb25lCgkJCW0uc2V0TGF0TG5nKG0uX3ByZVNwaWRlcmZ5TGF0bG5nKTsKCQkJZGVsZXRlIG0uX3ByZVNwaWRlcmZ5TGF0bG5nOwoKCQkJLy9IYWNrIG92ZXJyaWRlIHRoZSBsb2NhdGlvbiB0byBiZSBvdXIgY2VudGVyCgkJCW5vbkFuaW1hdGFibGUgPSB0cnVlOwoJCQlpZiAobS5fc2V0UG9zKSB7CgkJCQltLl9zZXRQb3ModGhpc0xheWVyUG9zKTsKCQkJCW5vbkFuaW1hdGFibGUgPSBmYWxzZTsKCQkJfQoJCQlpZiAobS5jbHVzdGVySGlkZSkgewoJCQkJbS5jbHVzdGVySGlkZSgpOwoJCQkJbm9uQW5pbWF0YWJsZSA9IGZhbHNlOwoJCQl9CgkJCWlmIChub25BbmltYXRhYmxlKSB7CgkJCQlmZy5yZW1vdmVMYXllcihtKTsKCQkJfQoKCQkJLy8gQW5pbWF0ZSB0aGUgc3BpZGVyIGxlZyBiYWNrIGluIChhbmltYXRpb24gaXMgYWN0dWFsbHkgZGVsZWdhdGVkIHRvIENTUyB0cmFuc2l0aW9uKS4KCQkJaWYgKHN2ZykgewoJCQkJbGVnID0gbS5fc3BpZGVyTGVnOwoJCQkJbGVnUGF0aCA9IGxlZy5fcGF0aDsKCQkJCWxlZ0xlbmd0aCA9IGxlZ1BhdGguZ2V0VG90YWxMZW5ndGgoKSArIDAuMTsKCQkJCWxlZ1BhdGguc3R5bGUuc3Ryb2tlRGFzaG9mZnNldCA9IGxlZ0xlbmd0aDsKCQkJCWxlZy5zZXRTdHlsZSh7b3BhY2l0eTogMH0pOwoJCQl9CgkJfQoKCQlncm91cC5faWdub3JlTW92ZSA9IGZhbHNlOwoKCQlzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKCQkJLy9JZiB3ZSBoYXZlIG9ubHkgPD0gb25lIGNoaWxkIGxlZnQgdGhlbiB0aGF0IG1hcmtlciB3aWxsIGJlIHNob3duIG9uIHRoZSBtYXAgc28gZG9uJ3QgcmVtb3ZlIGl0IQoJCQl2YXIgc3RpbGxUaGVyZUNoaWxkQ291bnQgPSAwOwoJCQlmb3IgKGkgPSBjaGlsZE1hcmtlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCW0gPSBjaGlsZE1hcmtlcnNbaV07CgkJCQlpZiAobS5fc3BpZGVyTGVnKSB7CgkJCQkJc3RpbGxUaGVyZUNoaWxkQ291bnQrKzsKCQkJCX0KCQkJfQoKCgkJCWZvciAoaSA9IGNoaWxkTWFya2Vycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewoJCQkJbSA9IGNoaWxkTWFya2Vyc1tpXTsKCgkJCQlpZiAoIW0uX3NwaWRlckxlZykgeyAvL0hhcyBhbHJlYWR5IGJlZW4gdW5zcGlkZXJmaWVkCgkJCQkJY29udGludWU7CgkJCQl9CgoJCQkJaWYgKG0uY2x1c3RlclNob3cpIHsKCQkJCQltLmNsdXN0ZXJTaG93KCk7CgkJCQl9CgkJCQlpZiAobS5zZXRaSW5kZXhPZmZzZXQpIHsKCQkJCQltLnNldFpJbmRleE9mZnNldCgwKTsKCQkJCX0KCgkJCQlpZiAoc3RpbGxUaGVyZUNoaWxkQ291bnQgPiAxKSB7CgkJCQkJZmcucmVtb3ZlTGF5ZXIobSk7CgkJCQl9CgoJCQkJbWFwLnJlbW92ZUxheWVyKG0uX3NwaWRlckxlZyk7CgkJCQlkZWxldGUgbS5fc3BpZGVyTGVnOwoJCQl9CgkJCWdyb3VwLl9hbmltYXRpb25FbmQoKTsKCQkJZ3JvdXAuZmlyZSgndW5zcGlkZXJmaWVkJywgewoJCQkJY2x1c3RlcjogbWUsCgkJCQltYXJrZXJzOiBjaGlsZE1hcmtlcnMKCQkJfSk7CgkJfSwgMjAwKTsKCX0KfSk7CgoKTC5NYXJrZXJDbHVzdGVyR3JvdXAuaW5jbHVkZSh7CgkvL1RoZSBNYXJrZXJDbHVzdGVyIGN1cnJlbnRseSBzcGlkZXJmaWVkIChpZiBhbnkpCglfc3BpZGVyZmllZDogbnVsbCwKCgl1bnNwaWRlcmZ5OiBmdW5jdGlvbiAoKSB7CgkJdGhpcy5fdW5zcGlkZXJmeS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJfSwKCglfc3BpZGVyZmllck9uQWRkOiBmdW5jdGlvbiAoKSB7CgkJdGhpcy5fbWFwLm9uKCdjbGljaycsIHRoaXMuX3Vuc3BpZGVyZnlXcmFwcGVyLCB0aGlzKTsKCgkJaWYgKHRoaXMuX21hcC5vcHRpb25zLnpvb21BbmltYXRpb24pIHsKCQkJdGhpcy5fbWFwLm9uKCd6b29tc3RhcnQnLCB0aGlzLl91bnNwaWRlcmZ5Wm9vbVN0YXJ0LCB0aGlzKTsKCQl9CgkJLy9Ccm93c2VycyB3aXRob3V0IHpvb21BbmltYXRpb24gb3IgYSBiaWcgem9vbSBkb24ndCBmaXJlIHpvb21zdGFydAoJCXRoaXMuX21hcC5vbignem9vbWVuZCcsIHRoaXMuX25vYW5pbWF0aW9uVW5zcGlkZXJmeSwgdGhpcyk7CgoJCWlmICghTC5Ccm93c2VyLnRvdWNoKSB7CgkJCXRoaXMuX21hcC5nZXRSZW5kZXJlcih0aGlzKTsKCQkJLy9OZWVkcyB0byBoYXBwZW4gaW4gdGhlIHBhZ2Vsb2FkLCBub3QgYWZ0ZXIsIG9yIGFuaW1hdGlvbnMgZG9uJ3Qgd29yayBpbiB3ZWJraXQKCQkJLy8gIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvODQ1NTIwMC9zdmctYW5pbWF0ZS13aXRoLWR5bmFtaWNhbGx5LWFkZGVkLWVsZW1lbnRzCgkJCS8vRGlzYWJsZSBvbiB0b3VjaCBicm93c2VycyBhcyB0aGUgYW5pbWF0aW9uIG1lc3NlcyB1cCBvbiBhIHRvdWNoIHpvb20gYW5kIGlzbid0IHZlcnkgbm90aWNhYmxlCgkJfQoJfSwKCglfc3BpZGVyZmllck9uUmVtb3ZlOiBmdW5jdGlvbiAoKSB7CgkJdGhpcy5fbWFwLm9mZignY2xpY2snLCB0aGlzLl91bnNwaWRlcmZ5V3JhcHBlciwgdGhpcyk7CgkJdGhpcy5fbWFwLm9mZignem9vbXN0YXJ0JywgdGhpcy5fdW5zcGlkZXJmeVpvb21TdGFydCwgdGhpcyk7CgkJdGhpcy5fbWFwLm9mZignem9vbWFuaW0nLCB0aGlzLl91bnNwaWRlcmZ5Wm9vbUFuaW0sIHRoaXMpOwoJCXRoaXMuX21hcC5vZmYoJ3pvb21lbmQnLCB0aGlzLl9ub2FuaW1hdGlvblVuc3BpZGVyZnksIHRoaXMpOwoKCQkvL0Vuc3VyZSB0aGF0IG1hcmtlcnMgYXJlIGJhY2sgd2hlcmUgdGhleSBzaG91bGQgYmUKCQkvLyBVc2Ugbm8gYW5pbWF0aW9uIHRvIGF2b2lkIGEgc3RpY2t5IGxlYWZsZXQtY2x1c3Rlci1hbmltIGNsYXNzIG9uIG1hcFBhbmUKCQl0aGlzLl9ub2FuaW1hdGlvblVuc3BpZGVyZnkoKTsKCX0sCgoJLy9PbiB6b29tIHN0YXJ0IHdlIGFkZCBhIHpvb21hbmltIGhhbmRsZXIgc28gdGhhdCB3ZSBhcmUgZ3VhcmFudGVlZCB0byBiZSBsYXN0IChhZnRlciBtYXJrZXJzIGFyZSBhbmltYXRlZCkKCS8vVGhpcyBtZWFucyB3ZSBjYW4gZGVmaW5lIHRoZSBhbmltYXRpb24gdGhleSBkbyByYXRoZXIgdGhhbiBNYXJrZXJzIGRvaW5nIGFuIGFuaW1hdGlvbiB0byB0aGVpciBhY3R1YWwgbG9jYXRpb24KCV91bnNwaWRlcmZ5Wm9vbVN0YXJ0OiBmdW5jdGlvbiAoKSB7CgkJaWYgKCF0aGlzLl9tYXApIHsgLy9NYXkgaGF2ZSBiZWVuIHJlbW92ZWQgZnJvbSB0aGUgbWFwIGJ5IGEgem9vbUVuZCBoYW5kbGVyCgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX21hcC5vbignem9vbWFuaW0nLCB0aGlzLl91bnNwaWRlcmZ5Wm9vbUFuaW0sIHRoaXMpOwoJfSwKCglfdW5zcGlkZXJmeVpvb21BbmltOiBmdW5jdGlvbiAoem9vbURldGFpbHMpIHsKCQkvL1dhaXQgdW50aWwgdGhlIGZpcnN0IHpvb21hbmltIGFmdGVyIHRoZSB1c2VyIGhhcyBmaW5pc2hlZCB0b3VjaC16b29taW5nIGJlZm9yZSBydW5uaW5nIHRoZSBhbmltYXRpb24KCQlpZiAoTC5Eb21VdGlsLmhhc0NsYXNzKHRoaXMuX21hcC5fbWFwUGFuZSwgJ2xlYWZsZXQtdG91Y2hpbmcnKSkgewoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9tYXAub2ZmKCd6b29tYW5pbScsIHRoaXMuX3Vuc3BpZGVyZnlab29tQW5pbSwgdGhpcyk7CgkJdGhpcy5fdW5zcGlkZXJmeSh6b29tRGV0YWlscyk7Cgl9LAoKCV91bnNwaWRlcmZ5V3JhcHBlcjogZnVuY3Rpb24gKCkgewoJCS8vLyA8c3VtbWFyeT5fdW5zcGlkZXJmeSBidXQgcGFzc2VzIG5vIGFyZ3VtZW50czwvc3VtbWFyeT4KCQl0aGlzLl91bnNwaWRlcmZ5KCk7Cgl9LAoKCV91bnNwaWRlcmZ5OiBmdW5jdGlvbiAoem9vbURldGFpbHMpIHsKCQlpZiAodGhpcy5fc3BpZGVyZmllZCkgewoJCQl0aGlzLl9zcGlkZXJmaWVkLnVuc3BpZGVyZnkoem9vbURldGFpbHMpOwoJCX0KCX0sCgoJX25vYW5pbWF0aW9uVW5zcGlkZXJmeTogZnVuY3Rpb24gKCkgewoJCWlmICh0aGlzLl9zcGlkZXJmaWVkKSB7CgkJCXRoaXMuX3NwaWRlcmZpZWQuX25vYW5pbWF0aW9uVW5zcGlkZXJmeSgpOwoJCX0KCX0sCgoJLy9JZiB0aGUgZ2l2ZW4gbGF5ZXIgaXMgY3VycmVudGx5IGJlaW5nIHNwaWRlcmZpZWQgdGhlbiB3ZSB1bnNwaWRlcmZ5IGl0IHNvIGl0IGlzbid0IG9uIHRoZSBtYXAgYW55bW9yZSBldGMKCV91bnNwaWRlcmZ5TGF5ZXI6IGZ1bmN0aW9uIChsYXllcikgewoJCWlmIChsYXllci5fc3BpZGVyTGVnKSB7CgkJCXRoaXMuX2ZlYXR1cmVHcm91cC5yZW1vdmVMYXllcihsYXllcik7CgoJCQlpZiAobGF5ZXIuY2x1c3RlclNob3cpIHsKCQkJCWxheWVyLmNsdXN0ZXJTaG93KCk7CgkJCX0KCQkJCS8vUG9zaXRpb24gd2lsbCBiZSBmaXhlZCB1cCBpbW1lZGlhdGVseSBpbiBfYW5pbWF0aW9uVW5zcGlkZXJmeQoJCQlpZiAobGF5ZXIuc2V0WkluZGV4T2Zmc2V0KSB7CgkJCQlsYXllci5zZXRaSW5kZXhPZmZzZXQoMCk7CgkJCX0KCgkJCXRoaXMuX21hcC5yZW1vdmVMYXllcihsYXllci5fc3BpZGVyTGVnKTsKCQkJZGVsZXRlIGxheWVyLl9zcGlkZXJMZWc7CgkJfQoJfQp9KTsKCi8qKgogKiBBZGRzIDEgcHVibGljIG1ldGhvZCB0byBNQ0cgYW5kIDEgdG8gTC5NYXJrZXIgdG8gZmFjaWxpdGF0ZSBjaGFuZ2luZwogKiBtYXJrZXJzJyBpY29uIG9wdGlvbnMgYW5kIHJlZnJlc2hpbmcgdGhlaXIgaWNvbiBhbmQgdGhlaXIgcGFyZW50IGNsdXN0ZXJzCiAqIGFjY29yZGluZ2x5IChjYXNlIHdoZXJlIHRoZWlyIGljb25DcmVhdGVGdW5jdGlvbiB1c2VzIGRhdGEgb2YgY2hpbGRNYXJrZXJzCiAqIHRvIG1ha2UgdXAgdGhlIGNsdXN0ZXIgaWNvbikuCiAqLwoKCkwuTWFya2VyQ2x1c3Rlckdyb3VwLmluY2x1ZGUoewoJLyoqCgkgKiBVcGRhdGVzIHRoZSBpY29uIG9mIGFsbCBjbHVzdGVycyB3aGljaCBhcmUgcGFyZW50cyBvZiB0aGUgZ2l2ZW4gbWFya2VyKHMpLgoJICogSW4gc2luZ2xlTWFya2VyTW9kZSwgYWxzbyB1cGRhdGVzIHRoZSBnaXZlbiBtYXJrZXIocykgaWNvbi4KCSAqIEBwYXJhbSBsYXllcnMgTC5NYXJrZXJDbHVzdGVyR3JvdXB8TC5MYXllckdyb3VwfEFycmF5KEwuTWFya2VyKXxNYXAoTC5NYXJrZXIpfAoJICogTC5NYXJrZXJDbHVzdGVyfEwuTWFya2VyIChvcHRpb25hbCkgbGlzdCBvZiBtYXJrZXJzIChvciBzaW5nbGUgbWFya2VyKSB3aG9zZSBwYXJlbnQKCSAqIGNsdXN0ZXJzIG5lZWQgdG8gYmUgdXBkYXRlZC4gSWYgbm90IHByb3ZpZGVkLCByZXRyaWV2ZXMgYWxsIGNoaWxkIG1hcmtlcnMgb2YgdGhpcy4KCSAqIEByZXR1cm5zIHtMLk1hcmtlckNsdXN0ZXJHcm91cH0KCSAqLwoJcmVmcmVzaENsdXN0ZXJzOiBmdW5jdGlvbiAobGF5ZXJzKSB7CgkJaWYgKCFsYXllcnMpIHsKCQkJbGF5ZXJzID0gdGhpcy5fdG9wQ2x1c3RlckxldmVsLmdldEFsbENoaWxkTWFya2VycygpOwoJCX0gZWxzZSBpZiAobGF5ZXJzIGluc3RhbmNlb2YgTC5NYXJrZXJDbHVzdGVyR3JvdXApIHsKCQkJbGF5ZXJzID0gbGF5ZXJzLl90b3BDbHVzdGVyTGV2ZWwuZ2V0QWxsQ2hpbGRNYXJrZXJzKCk7CgkJfSBlbHNlIGlmIChsYXllcnMgaW5zdGFuY2VvZiBMLkxheWVyR3JvdXApIHsKCQkJbGF5ZXJzID0gbGF5ZXJzLl9sYXllcnM7CgkJfSBlbHNlIGlmIChsYXllcnMgaW5zdGFuY2VvZiBMLk1hcmtlckNsdXN0ZXIpIHsKCQkJbGF5ZXJzID0gbGF5ZXJzLmdldEFsbENoaWxkTWFya2VycygpOwoJCX0gZWxzZSBpZiAobGF5ZXJzIGluc3RhbmNlb2YgTC5NYXJrZXIpIHsKCQkJbGF5ZXJzID0gW2xheWVyc107CgkJfSAvLyBlbHNlOiBtdXN0IGJlIGFuIEFycmF5KEwuTWFya2VyKXxNYXAoTC5NYXJrZXIpCgkJdGhpcy5fZmxhZ1BhcmVudHNJY29uc05lZWRVcGRhdGUobGF5ZXJzKTsKCQl0aGlzLl9yZWZyZXNoQ2x1c3RlcnNJY29ucygpOwoKCQkvLyBJbiBjYXNlIG9mIHNpbmdsZU1hcmtlck1vZGUsIGFsc28gcmUtZHJhdyB0aGUgbWFya2Vycy4KCQlpZiAodGhpcy5vcHRpb25zLnNpbmdsZU1hcmtlck1vZGUpIHsKCQkJdGhpcy5fcmVmcmVzaFNpbmdsZU1hcmtlck1vZGVNYXJrZXJzKGxheWVycyk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoqCgkgKiBTaW1wbHkgZmxhZ3MgYWxsIHBhcmVudCBjbHVzdGVycyBvZiB0aGUgZ2l2ZW4gbWFya2VycyBhcyBoYXZpbmcgYSAiZGlydHkiIGljb24uCgkgKiBAcGFyYW0gbGF5ZXJzIEFycmF5KEwuTWFya2VyKXxNYXAoTC5NYXJrZXIpIGxpc3Qgb2YgbWFya2Vycy4KCSAqIEBwcml2YXRlCgkgKi8KCV9mbGFnUGFyZW50c0ljb25zTmVlZFVwZGF0ZTogZnVuY3Rpb24gKGxheWVycykgewoJCXZhciBpZCwgcGFyZW50OwoKCQkvLyBBc3N1bWVzIGxheWVycyBpcyBhbiBBcnJheSBvciBhbiBPYmplY3Qgd2hvc2UgcHJvdG90eXBlIGlzIG5vbi1lbnVtZXJhYmxlLgoJCWZvciAoaWQgaW4gbGF5ZXJzKSB7CgkJCS8vIEZsYWcgcGFyZW50IGNsdXN0ZXJzJyBpY29uIGFzICJkaXJ0eSIsIGFsbCB0aGUgd2F5IHVwLgoJCQkvLyBEdW1iIHByb2Nlc3MgdGhhdCBmbGFncyBtdWx0aXBsZSB0aW1lcyB1cHBlciBwYXJlbnRzLCBidXQgc3RpbGwKCQkJLy8gbXVjaCBtb3JlIGVmZmljaWVudCB0aGFuIHRyeWluZyB0byBiZSBzbWFydCBhbmQgbWFrZSBzaG9ydCBsaXN0cywKCQkJLy8gYXQgbGVhc3QgaW4gdGhlIGNhc2Ugb2YgYSBoaWVyYXJjaHkgZm9sbG93aW5nIGEgcG93ZXIgbGF3OgoJCQkvLyBodHRwOi8vanNwZXJmLmNvbS9mbGFnLW5vZGVzLWluLXBvd2VyLWhpZXJhcmNoeS8yCgkJCXBhcmVudCA9IGxheWVyc1tpZF0uX19wYXJlbnQ7CgkJCXdoaWxlIChwYXJlbnQpIHsKCQkJCXBhcmVudC5faWNvbk5lZWRzVXBkYXRlID0gdHJ1ZTsKCQkJCXBhcmVudCA9IHBhcmVudC5fX3BhcmVudDsKCQkJfQoJCX0KCX0sCgoJLyoqCgkgKiBSZS1kcmF3cyB0aGUgaWNvbiBvZiB0aGUgc3VwcGxpZWQgbWFya2Vycy4KCSAqIFRvIGJlIHVzZWQgaW4gc2luZ2xlTWFya2VyTW9kZSBvbmx5LgoJICogQHBhcmFtIGxheWVycyBBcnJheShMLk1hcmtlcil8TWFwKEwuTWFya2VyKSBsaXN0IG9mIG1hcmtlcnMuCgkgKiBAcHJpdmF0ZQoJICovCglfcmVmcmVzaFNpbmdsZU1hcmtlck1vZGVNYXJrZXJzOiBmdW5jdGlvbiAobGF5ZXJzKSB7CgkJdmFyIGlkLCBsYXllcjsKCgkJZm9yIChpZCBpbiBsYXllcnMpIHsKCQkJbGF5ZXIgPSBsYXllcnNbaWRdOwoKCQkJLy8gTWFrZSBzdXJlIHdlIGRvIG5vdCBvdmVycmlkZSBtYXJrZXJzIHRoYXQgZG8gbm90IGJlbG9uZyB0byBUSElTIGdyb3VwLgoJCQlpZiAodGhpcy5oYXNMYXllcihsYXllcikpIHsKCQkJCS8vIE5lZWQgdG8gcmUtY3JlYXRlIHRoZSBpY29uIGZpcnN0LCB0aGVuIHJlLWRyYXcgdGhlIG1hcmtlci4KCQkJCWxheWVyLnNldEljb24odGhpcy5fb3ZlcnJpZGVNYXJrZXJJY29uKGxheWVyKSk7CgkJCX0KCQl9Cgl9Cn0pOwoKTC5NYXJrZXIuaW5jbHVkZSh7CgkvKioKCSAqIFVwZGF0ZXMgdGhlIGdpdmVuIG9wdGlvbnMgaW4gdGhlIG1hcmtlcidzIGljb24gYW5kIHJlZnJlc2hlcyB0aGUgbWFya2VyLgoJICogQHBhcmFtIG9wdGlvbnMgbWFwIG9iamVjdCBvZiBpY29uIG9wdGlvbnMuCgkgKiBAcGFyYW0gZGlyZWN0bHlSZWZyZXNoQ2x1c3RlcnMgYm9vbGVhbiAob3B0aW9uYWwpIHRydWUgdG8gdHJpZ2dlcgoJICogTUNHLnJlZnJlc2hDbHVzdGVyc09mKCkgcmlnaHQgYXdheSB3aXRoIHRoaXMgc2luZ2xlIG1hcmtlci4KCSAqIEByZXR1cm5zIHtMLk1hcmtlcn0KCSAqLwoJcmVmcmVzaEljb25PcHRpb25zOiBmdW5jdGlvbiAob3B0aW9ucywgZGlyZWN0bHlSZWZyZXNoQ2x1c3RlcnMpIHsKCQl2YXIgaWNvbiA9IHRoaXMub3B0aW9ucy5pY29uOwoKCQlMLnNldE9wdGlvbnMoaWNvbiwgb3B0aW9ucyk7CgoJCXRoaXMuc2V0SWNvbihpY29uKTsKCgkJLy8gU2hvcnRjdXQgdG8gcmVmcmVzaCB0aGUgYXNzb2NpYXRlZCBNQ0cgY2x1c3RlcnMgcmlnaHQgYXdheS4KCQkvLyBUbyBiZSB1c2VkIHdoZW4gcmVmcmVzaGluZyBhIHNpbmdsZSBtYXJrZXIuCgkJLy8gT3RoZXJ3aXNlLCBiZXR0ZXIgdXNlIE1DRy5yZWZyZXNoQ2x1c3RlcnMoKSBvbmNlIGF0IHRoZSBlbmQgd2l0aAoJCS8vIHRoZSBsaXN0IG9mIG1vZGlmaWVkIG1hcmtlcnMuCgkJaWYgKGRpcmVjdGx5UmVmcmVzaENsdXN0ZXJzICYmIHRoaXMuX19wYXJlbnQpIHsKCQkJdGhpcy5fX3BhcmVudC5fZ3JvdXAucmVmcmVzaENsdXN0ZXJzKHRoaXMpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9Cn0pOwoKZXhwb3J0cy5NYXJrZXJDbHVzdGVyR3JvdXAgPSBNYXJrZXJDbHVzdGVyR3JvdXA7CmV4cG9ydHMuTWFya2VyQ2x1c3RlciA9IE1hcmtlckNsdXN0ZXI7Cgp9KSkpOwovLyMgc291cmNlTWFwcGluZ1VSTD1sZWFmbGV0Lm1hcmtlcmNsdXN0ZXItc3JjLmpzLm1hcAo=